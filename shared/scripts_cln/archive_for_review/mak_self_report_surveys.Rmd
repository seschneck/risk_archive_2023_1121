---
title: "Clean and process the raw qualtrics screen, intake and monthly surveys"
author: "John Curtin"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: 
  html_document:
  toc: true 
toc_depth: 4
editor_options: 
  chunk_output_type: console
---
  
### Notes
Purpose: This file does cleaning and basic processing of the qualtrics surveys (other than EMA).

Inputs:  Opens data files in path_in

* screen.csv
* intake.csv
* followup12.csv
* followup3.csv
* beddit_burden_survey_F12.csv
* empatica_burden_survey_F12.csv
* beddit_burden_survey_F3.csv
* empatica_burden_survey_F3.csv

Also opens log files in path_log

* log_screen.csv
* log_intake.csv
* log_followup12.csv
* log_followup3.csv

Outputs: Creates files in path_out

* ds_screen.csv
* ds_intake.csv
* ds_followup12.csv
* ds_followup3.csv

FIX: Deleted Finished variable but didnt delete finished records.  Confirm this is OK

FIX: Deleted DataType variable but didnt delete records based on it.  Confirm this OK

### Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, results = "hold")
```

Paths 
```{r}
path_in <- "raw_data/qualtrics"
path_out <- "analysis/shared/data"
path_log <- "analysis/notes"  
```

Packages and Source
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
library(janitor)

source('P:/toolboxes/lab_support/clean_qualtrics_by_log.R')
```
   
### Screening survey
Load survey and remove unused variables

Rename subid and response_id to tidy case because these variables are used by name in clean_qualtrics_by_log()
```{r}
screen <- read_csv(file.path(path_in, 'screen.csv'))  %>% 
  select(-c(ResponseSet, IPAddress, RecipientLastName, RecipientFirstName,
            RecipientEmail, ExternalDataReference, Status,
            LocationLatitude, LocationLongitude, LocationAccuracy, DataType, Finished,
            DSM5_score, paranoia, psychosis, Psychosis_Final, Paranoia_Final, 
            StudyName, DEM_Inst, DEM2_Inst, AUH_Inst, DSM5_Inst, DSM5_Inst2, 
            YAP_Inst, ASSIST_Inst, SCL90_Inst, IUS_Inst, ASI_Inst, DTS_Inst, 
            FAD_Inst, MPS_Inst, SB_Inst, SB_Inst2, EB_1, EB_2, EB_3, EB_4, Q140)) %>% 
  rename(subid = SubID, response_id = ResponseID)  %>%  #update to tidy case for use in clean_qualtrics_by_log()
  relocate(subid)
```

Open and summarize data log
```{r}
log_screen <- read_csv(file.path(path_log, "log_screen.csv")) %>% 
  glimpse()
```

```{r}
tabyl(log_screen$log_action)
```

Clean raw data using log
```{r}
screen <- clean_qualtrics_by_log(log_screen, screen)
```

Tidy variable names
```{r}
screen <- clean_names(screen, "snake") %>% 
  rename(auh_8_month = auh_8_1_auh_8_month, auh_8_day = auh_8_2_auh_8_day,
         auh_8_year = auh_8_3_auh_8_year, auh_7_med1 = auh_7_1_1_text,
         auh_7_med2 = auh_7_1_2_text, auh_7_med3 = auh_7_1_3_text, 
         auh_7_med4 = auh_7_1_4_text,
         auh_6_7_text = auh_6_1_2)
```

Save final clean data.  Variables will open with proper class on next load of data
```{r}
screen %>% 
  select(-utc) %>% 
  glimpse() %>% 
  write_csv(file.path(path_out, "ds_screen.csv")) 
```


### Intake survey
Load survey and remove unused variables

Rename subid and response_id to tidy case because these variables are used by name in clean_qualtrics_by_log()
```{r}
intake <- read_csv(file.path(path_in, 'intake.csv'))  %>% 
  select(-c(ResponseSet, IPAddress, RecipientLastName, RecipientFirstName,
            RecipientEmail, ExternalDataReference, Status,
            LocationLatitude, LocationLongitude, LocationAccuracy, DataType, Finished,
            StudyName, PACS_Inst, AASE_Inst, MAM_Inst, DASS21_Inst,
            PSS_Inst, QOL_Inst, DAS_Inst, MSPSS_Inst)) %>% 
  rename(subid = SubID, response_id = ResponseID)  %>%  #update to tidy case for use in clean_qualtrics_by_log()
  relocate(subid)
```

Clean data using log
```{r}
log_intake <- read_csv(file.path(path_log, "log_intake.csv"))%>% 
  glimpse()
```

```{r}
tabyl(log_intake$log_action)
```

```{r}
intake <- clean_qualtrics_by_log(log_intake, intake)
```

Tidy variable names
```{r}
intake <- clean_names(intake, "snake") 
```

Save final clean data.  Variables will open with proper class on next load of data
```{r}
intake %>% 
  select(-utc) %>% 
  glimpse() %>% 
  write_csv(file.path(path_out, "ds_intake.csv")) 
```

### Followup 12 survey
Load surveys, join, and remove unused variables

Rename subid and response_id to tidy case because these variables are used by name in clean_qualtrics_by_log()
```{r}
main12 <- read_csv(file.path(path_in, 'followup12.csv'))  
burden_sleep <- read_csv(file.path(path_in, 'beddit_burden_survey_F12.csv'))  %>% 
  select(ResponseID, RBM_5, RBM_6, RBM_7, RBM_8) 
burden_empatica <- read_csv(file.path(path_in, 'empatica_burden_survey_F12.csv')) %>% 
  select(ResponseID, RBM_1, RBM_2, RBM_3, RBM_4) 

fu12 <- left_join(main12,burden_empatica, by = "ResponseID") %>% 
  left_join(burden_sleep, by = "ResponseID") %>% 
  select(-c(ResponseSet, IPAddress, RecipientLastName, RecipientFirstName,
            RecipientEmail, ExternalDataReference, Status, Finished,
            LocationLatitude, LocationLongitude, LocationAccuracy,
            DataType, StudyName, PACS_Inst, AASE_Inst, MAM_Inst, ASSIST_Inst,
            DASS21_Inst, PSS_Inst, QOL_Inst, DAS_Inst, MSPSS_Inst, RBM_Inst)) %>% 
  rename(subid = SubID, response_id = ResponseID)  %>%  #update to tidy case for use in clean_qualtrics_by_log()
  relocate(subid) %>% 
  relocate(any_of(str_c("RBM_", 1:8)), .before = "RBM_9")
```

Clean data using log
```{r}
log_fu12 <- read_csv(file.path(path_log, "log_followup12.csv")) %>% 
  glimpse()
```

```{r}
tabyl(log_fu12$log_action)
```

```{r}
fu12 <- clean_qualtrics_by_log(log_fu12, fu12)
```

Tidy variable names
```{r}
fu12 <- clean_names(fu12, "snake") 
```

Save final clean data.  Variables will open with proper class on next load of data
```{r}
fu12 %>% 
  select(-utc) %>% 
  glimpse() %>% 
  write_csv(file.path(path_out, "ds_followup12.csv")) 
```


### Followup 3
Load surveys, join, and remove unused variables

Rename subid and response_id to tidy case because these variables are used by name in clean_qualtrics_by_log()
```{r}
main3 <- read_csv(file.path(path_in, 'followup3.csv'))  
burden_sleep <- read_csv(file.path(path_in, 'beddit_burden_survey_F3.csv'))  %>% 
  select(ResponseID, RBM_5, RBM_6, RBM_7, RBM_8) 
burden_empatica <- read_csv(file.path(path_in, 'empatica_burden_survey_F3.csv')) %>% 
  select(ResponseID, RBM_1, RBM_2, RBM_3, RBM_4) 

fu3 <- left_join(main3,burden_empatica, by = "ResponseID") %>% 
  left_join(burden_sleep, by = "ResponseID") %>% 
  select(-c(ResponseSet, IPAddress, RecipientLastName, RecipientFirstName,
            RecipientEmail, ExternalDataReference, Status, Finished,
            LocationLatitude, LocationLongitude, LocationAccuracy,
            DataType, StudyName, RBM_Inst)) %>% 
  rename(subid = SubID, response_id = ResponseID)  %>%  #update to tidy case for use in clean_qualtrics_by_log()
  relocate(subid) %>% 
  relocate(any_of(str_c("RBM_", 1:8)), .before = "RBM_9")
```

Clean data using log
```{r}
log_fu3 <- read_csv(file.path(path_log, "log_followup3.csv")) %>% 
  glimpse()
```

```{r}
tabyl(log_fu3$log_action)
```

```{r}
fu3 <- clean_qualtrics_by_log(log_fu3, fu3)
```

Tidy variable names
```{r}
fu3 <- clean_names(fu3, "snake") 
```

Save final clean data.  Variables will open with proper class on next load of data
```{r}
fu3 %>% 
  select(-utc) %>% 
  glimpse() %>% 
  write_csv(file.path(path_out, "ds_followup3.csv")) 
```