---
title: "Clean the raw qualtrics EMA surveys"
author: "Sarah Sant'Ana and Kendra Wyant"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/knits/shared", 
      "/Volumes/private/studydata/risk/knits/shared")
    )
  })
---

### Code Status

KW currently working on this clean script.   

Working on:   

- clean up and check all log entries to see if they are known errors or estimations   
- EDA on cleaning log entries    
- EDA on lapses     
- check and remove test entries with log    
  

### Conclusion

- All unfinished surveys (finished = 0) have at least ema_1 answered which reports if there have been any lapses since the last survey.    

- Many participants completed more than 4 EMAs per day. This may be due to several reasons, including trying to make up for missed surveys the day before, receiving too many prompts via survey signal, or forgetting whether they already did it.    


### Notes

Purpose: This file cleans the qualtrics EMA surveys and performs EDA on all EMA variables. The focus of this script is to clean/check all EMA lapse reports so that the cleaned data can be used to create lapse labels for individual studies.   


Inputs (path_raw):  

* ema_morning.csv
* ema_later.csv

Outputs (path_shared):   

* ema_morning.csv
* ema_later.csv


### Set up Environment

Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```

Absolute paths
```{r, paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_raw <- "P:/studydata/risk/data_raw/qualtrics"
          path_shared <- "P:/studydata/risk/data_processed/shared"
          path_lab_support <- "P:/toolboxes/lab_support"},

        # IOS paths
        Darwin = {
          path_raw <- "/Volumes/private/studydata/risk/data_raw"
          path_shared <- "/Volumes/private/studydata/risk/data_processed/shared"
          path_lab_support <- "/Volumes/private/toolboxes/lab_support"}
        )
```

Relative paths
```{r}
path_log <- "shared/notes"
```

Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) # detect and warn about function conflicts
 conflict_prefer("filter", "dplyr")
 conflict_prefer("select", "dplyr")

library(here)  # establish project directory consistently as working directory
```

Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
# for data wrangling
library(tidyverse)  # always need this
library(janitor) # cleaning and EDA
library(lubridate)

# for plots and tables
library(ggplot2)
theme_set(theme_bw()) # or theme_set(theme_classic())
library(kableExtra)
```

Source for script
```{r, source_script, message=FALSE, warning=FALSE}
source(here(path_lab_support, "clean_qualtrics_by_log.R"))
```



### Print EMA relevant notes from raw_notes

```{r}
notes <- vroom::vroom(here(path_log, "raw_notes.csv"), col_types = vroom::cols())

notes %>% 
  select(subid, notes_ema) %>% 
  filter(!is.na(notes_ema)) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```



### Read in raw data 

Rename subid and response_id to tidy case because these variables are used by name in clean_qualtrics_by_log()
```{r}
ema_morning <- vroom::vroom(here(path_raw, 'ema_morning.csv'), col_types = vroom::cols()) %>% 
  rename(subid = SubID) %>% 
  rename(response_id = ResponseID) %>% 
  glimpse()

ema_later <- vroom::vroom(here(path_raw, 'ema_later.csv'), col_types = vroom::cols()) %>% 
  rename(subid = SubID) %>% 
  rename(response_id = ResponseID) %>% 
  glimpse()
```


### Read in Logs

```{r}
log_morning <- vroom::vroom(here(path_log, "log_ema_morning.csv"), col_types = vroom::cols()) %>% 
  glimpse()

log_later <- vroom::vroom(here(path_log, "log_ema_later.csv"), col_types = vroom::cols()) %>% 
  glimpse()
```


### Log EDA

Join logs for light EDA
```{r}
log_all <- log_morning %>% 
  bind_rows(log_later)
```

Log actions
```{r}
tabyl(log_all$log_action)
```
    
#### recode_one entries

variables with recode_one entries
```{r}
log_all %>% 
  filter(log_action == "recode_one") %>% 
  tabyl(var_name)
```

subids recoded 
```{r}
log_all %>% 
  filter(var_name == "subid") %>% 
  tabyl(subid)
```

subid 66 
```{r}
log_all %>% 
  filter(subid == "066") %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%")
```

subid 136
```{r}
log_all %>% 
  filter(subid == "136") %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%")
```

subid 31
```{r}
log_all %>% 
  filter(subid == "031" & var_name == "subid") %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```

subid 101
```{r}
log_all %>% 
  filter(subid == "101" & var_name == "subid") %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```

#### recode_tz entries
```{r}
log_all %>% 
  filter(log_action == "recode_tz") %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```

#### remove entries
```{r}
log_all %>% 
  filter(log_action == "remove") %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```

#### note entries
```{r}
log_all %>% 
  filter(log_action == "note") %>% 
  select(-c(var_name, new_value, old_value)) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```



### Clean Data with Cleaning Function

```{r}
ema_morning <- ema_morning %>% 
  clean_qualtrics_by_log(log_morning) %>% 
  glimpse()

ema_later <- ema_later %>% 
  clean_qualtrics_by_log(log_later) %>% 
  glimpse()
```


### Tidy variable names

```{r}
ema_morning <- ema_morning %>% 
  clean_names() %>% 
  glimpse()

ema_later <- ema_later %>% 
  clean_names() %>% 
  glimpse()
```

### EDA

Combine EMA files for EDA
```{r}
ema_all <- ema_morning %>% 
  rename_with(~ str_replace(.x, "emam_", "ema_")) %>% 
  # put start and end date in central time
  mutate(start_date = with_tz(start_date, tzone = "America/Chicago"),
         end_date = with_tz(end_date, tzone = "America/Chicago")) %>% 
  # add temp variable to trace which ema file an entry came from for EDA
  mutate(ema_type = "morning") %>% 
  bind_rows(ema_later %>% 
              rename_with(~ str_replace(.x, "emal_", "ema_")) %>% 
              mutate(ema_type = "later")) %>% 
  glimpse()
```

#### Test data

`r nrow(subset(ema_all, subid == "test"))` test surveys remain.   

FIX: How to check test data is invalid and how to remove invalid test data (log?/code?)    

Most test entries are complete
```{r}
ema_all %>% 
  filter(subid == "test") %>% 
  tabyl(finished)
```

May be able to use latitude/longitude to see if in brogden or find groups of tests
```{r}
ema_all %>% 
  filter(subid == "test") %>% 
  tabyl(location_latitude) %>% 
  arrange(desc(n))
```


#### Missing data
```{r}
ema_all %>% 
  naniar::miss_var_summary()
```

Remove Qualtrics variables with 100% missing data and variables with 0 variance   
```{r}
ema_morning <- ema_morning %>% 
  select(-c(recipient_last_name, recipient_first_name, recipient_email,
            external_data_reference, response_set, location_accuracy))
ema_later <- ema_later %>% 
  select(-c(recipient_last_name, recipient_first_name, recipient_email,
            external_data_reference, response_set, location_accuracy))
ema_all <- ema_all %>% 
  select(-c(recipient_last_name, recipient_first_name, recipient_email,
            external_data_reference, response_set, location_accuracy))
```

missing ema_1_1 - ema_1_5 variables    
These are follow up variables for participants who report a lapse on ema_1
```{r}
ema_all %>% 
  filter(is.na(ema_1_1) | is.na(ema_1_2) | is.na(ema_1_3) | is.na(ema_1_4) | is.na(ema_1_5)) %>% 
  tabyl(ema_1)
```

82 participants report a lapse but do not provide full information about lapse   
Some do fill out ema_1_1 - ema_1_4 which are the dates/times of lapse
```{r}
ema_all %>% 
  filter(ema_1 == "Yes" & (is.na(ema_1_1) | is.na(ema_1_2) | is.na(ema_1_3) | 
                             is.na(ema_1_4) | is.na(ema_1_5))) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```


missing ema_2_1 - ema_7_1 variables    
All are marked as not finished
```{r}
ema_all %>% 
  filter(is.na(ema_2_1) | is.na(ema_3_1) | is.na(ema_4_1) | is.na(ema_5_1) |
           is.na(ema_6_1) | is.na(ema_7_1)) %>% 
  tabyl(finished)
```

missing ema_8_1 - ema_10_1 variables   
These variables were only on the morning survey    
All missing values on later surveys or on morning surveys marked as not finished
```{r}
ema_all %>% 
  filter(is.na(ema_8_1) | is.na(ema_9_1) | is.na(ema_10_1)) %>% 
  tabyl(ema_type, finished)
```

missing location_latitude and longitude    
These variables are only recorded when a survey is complete - all missing values are on unfinished surveys
```{r}
ema_all %>% 
  filter(is.na(location_latitude) | is.na(location_longitude)) %>% 
  tabyl(finished)
```


missing 93% send_date and send_time    
FIX: What are these variables? Related to survey signal?    
Too much missing data to likely be helpful
```{r}
ema_all %>% 
  filter(is.na(send_date)) %>% 
  slice_sample(n = 500) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```


#### EMA counts and frequencies

`r nrow(ema_all)` EMAS across `r length(unique(ema_all$subid))` unique subids  

This currently includes EMAs under subid test     
169 participants enrolled in study - 169 + test subid = 170 unique subids    


EMA counts per subid
```{r}
ema_all %>% 
  count(subid) %>% 
  arrange(desc(n))
```

Bring in study start and end dates
```{r}
visits <- vroom::vroom(here(path_shared, "visit_dates.csv"), col_types = vroom::cols()) %>% 
  mutate(across(c(everything(), -subid), ~ force_tz(.x, tzone = "America/Chicago"))) %>% 
  glimpse()

ema_all_visits <- ema_all %>% 
  # filter out test subid
  filter(subid != "test") %>% 
  mutate(subid = as.numeric(subid)) %>% 
  left_join(visits %>% 
              select(subid, start_study, end_study), 
            by = "subid")
```

Calculate days on study
```{r}
ema_all_visits <- ema_all_visits %>% 
  mutate(days_on_study = as.numeric(round(end_study - start_study))) %>% 
  glimpse()
```

Participants were on study for `r min(ema_all_visits$days_on_study)` - `r max(ema_all_visits$days_on_study)` days     

NOTE: 5 subids have over 90 days on study - no notes as to why this is
```{r}
ema_all_visits %>% 
  filter(days_on_study > 90) %>% 
  group_by(subid) %>% 
  slice(1) %>% 
  select(subid, days_on_study)
```


EMAs completed per study day    
```{r}
ema_all_visits <- ema_all_visits %>% 
  group_by(subid, days_on_study) %>% 
  summarise(n_emas = n(), .groups = "drop") %>% 
  mutate(avg_emas = n_emas/days_on_study)
```

On average participants completed `r round(mean(ema_all_visits$avg_emas), 2)` EMAs per day.  

```{r}
ema_all_visits %>% 
  ggplot(aes(x = avg_emas)) +
  geom_histogram(bins = 20, color = "black", fill = "light grey")
```

NOTE: This does not cap out possible daily EMAs at 4. Almost all participants completed more than 4 EMAs in a single day at some point.    
Days with more than 4 EMAs
```{r}
ema_all_more_than_4 <- ema_all %>% 
  filter(subid != "test") %>% 
  mutate(date = date(start_date)) %>% 
  count(subid, date) %>% 
  filter(n > 4)

print(ema_all_more_than_4)
```


There are `r nrow(ema_all_more_than_4)` instances of days with more than 4 surveys from `r length(unique(ema_all_more_than_4$subid))` participants.   

The most surveys in one day are `r max(ema_all_more_than_4$n)` surveys.  

Subid 269 seems to have completed more than 4 surveys on most study days. Unclear why because they did not have missed surveys the day before to make up for. No staff notes about EMA.
```{r}
ema_all %>% 
  filter(subid == 269) %>% 
  mutate(date = date(start_date)) %>% 
  count(date)
```


FIX: count days between EMAs - look for large gaps    



#### Start and End dttms for EMAs

Duration of EMA
```{r}
ema_all <- ema_all %>%  
  mutate(duration_min = round(as.numeric(difftime(end_date, start_date, units = "mins"))))

ema_all %>% 
  filter(subid != "test") %>% 
  tabyl(duration_min)
```

Closer look at surveys under half a minute
```{r}
ema_all %>%  
  mutate(duration_min = as.numeric(difftime(end_date, start_date, units = "mins"))) %>%
  filter(duration_min < .5) %>% 
  filter(subid != "test") %>% 
  tabyl(duration_min)
```

Most surveys under half a minute either had no lapse or were not finished
```{r}
ema_all %>%  
  mutate(duration_min = as.numeric(difftime(end_date, start_date, units = "mins"))) %>%
  filter(duration_min < .5) %>% 
  filter(subid != "test") %>% 
  tabyl(finished, ema_1)
```

Surveys that took less than 12 seconds
```{r}
ema_all_less_than_12_sec <- ema_all %>%  
  mutate(duration_min = as.numeric(difftime(end_date, start_date, units = "mins"))) %>%
  filter(duration_min < .2) %>% 
  filter(subid != "test") 
```

`r nrow(subset(ema_all_less_than_12_sec, finished == 1))` of the `r nrow(ema_all_less_than_12_sec)` surveys with a duration of less than 12 seconds were marked complete   
All of these surveys report no lapses and were completed later in the day - which significantly shortens the survey length
```{r}
ema_all_less_than_12_sec %>% 
  filter(finished == 1) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```


Surveys that took more than 5 minutes
```{r}
ema_all_more_than_5_min <- ema_all %>%  
  mutate(duration_min = as.numeric(difftime(end_date, start_date, units = "mins"))) %>%
  filter(duration_min > 5) %>% 
  filter(subid != "test") 
```

`r nrow(ema_all_more_than_5_min)` surveys took over 5 minutes to complete.    

Most (N = `r nrow(subset(ema_all_more_than_5_min, finished == 1))`) were marked as complete.   
```{r}
ema_all_more_than_5_min %>% 
  filter(finished == 1) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```

Different start and end days   
NOTE: Includes 2 lapses
```{r}
ema_all_more_than_5_min %>% 
  mutate(start_day = as_date(start_date),
         end_day = as_date(end_date)) %>% 
  filter(start_day != end_day) %>% 
  select(c(subid, start_date, end_date, finished, ema_1:ema_10_1, ema_type, duration_min)) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(width = "100%", height = "500px")
```


#### Finished

`r nrow(subset(ema_all, finished == 0 & subid != "test"))` surveys are marked as incomplete

Keep unfinished surveys - all have at least ema_1 answered
```{r}
ema_all %>% 
  filter(subid != "test") %>% 
  filter(finished == 0) %>% 
  select(subid, ema_1:ema_1_5)
```


#### Status

`r nrow(subset(ema_all, status == 8))` surveys have status = 8     

The value in the Status column indicates the type of response collected     
0 = A normal response   
8 = A possible spam response   

```{r}
ema_all %>% 
  tabyl(status)
```

All flagged surveys were completed in under 5 min
```{r}
ema_all %>% 
  filter(status == 8) %>% 
  tabyl(duration_min)
```

But they don't seem to be related to any particular subid
```{r}
ema_all %>% 
  filter(status == 8) %>% 
  tabyl(subid)
```


#### Lapses

Reported lapses   
**ema_1**    
"Have you drank any alcohol that you have not yet reported?"
```{r}
ema_all %>% 
  tabyl(ema_1)
```

**ema_1_1**    
"Please indicate the date of the first drink that you have not yet reported"    
```{r}
ema_all <- ema_all %>% 
  mutate(ema_1_1 = as_datetime(ema_1_1, format = "%m-%d-%Y", tz = "America/Chicago"))
```

Dates of first drink in lapse range from `r min(ema_all$ema_1_1, na.rm = TRUE)` - `r max(ema_all$ema_1_1, na.rm = TRUE)`.    


**ema_1_2**    
"Please select the hour of the first drink that you have not yet reported"
```{r}
ema_all %>% 
  filter(ema_1 == "Yes") %>% 
  tabyl(ema_1_2)
```


**ema_1_3**    
"Please indicate the date of the last drink that you have not yet reported"
```{r}
ema_all <- ema_all %>% 
  mutate(ema_1_3 = as_datetime(ema_1_3, format = "%m-%d-%Y", tz = "America/Chicago"))
```

Dates of last drink in lapse range from `r min(ema_all$ema_1_3, na.rm = TRUE)` - `r max(ema_all$ema_1_3, na.rm = TRUE)`.     


**ema_1_4**    
"Please select the hour of the last drink that you have not yet reported"
```{r}
ema_all %>% 
  filter(ema_1 == "Yes") %>% 
  tabyl(ema_1_4)
```

**ema_1_5**    
"Is your goal still to remain abstinent in the future?"
```{r}
ema_all %>% 
  filter(ema_1 == "Yes") %>% 
  tabyl(ema_1_5)
```



FIX: check how timezone was calculated on raw data and cleaning log (should all be in America/Chicago)     

FIX: check notes/additional info on participants with no lapses   

FIX: check for invalid lapses   


#### 13-Point (0-12) Likert Scale Questions

"How intense was your greatest urge to drink alcohol?"
```{r}
ema_all %>% 
  tabyl(ema_2_1)
```


"Did you encounter any risky situations (people, places, or things)?  If yes, rate the intensity of the situation. If you experienced more than one risky situation, rate the most intense one."
```{r}
ema_all %>% 
  tabyl(ema_3_1)
```

"Has a hassle or stressful event occurred? If yes, rate the intensity of the event. If you experienced more than one hassle or stressful event, rate the most intense one."
```{r}
ema_all %>% 
  tabyl(ema_4_1)
```


"Has a pleasant or positive event occurred? If yes, rate the intensity of the event. If you experienced more than one pleasant or positive event, rate the most intense one."
```{r}
ema_all %>% 
  tabyl(ema_5_1)
```

#### 11-Point (1-11) Likert Scale Questions

"How are you feeling right now? Unpleasant/unhappy - Pleasant/happy"
```{r}
ema_all %>% 
  tabyl(ema_6_1)
```


"How are you feeling right now? Calm/sleepy - Aroused/alert"
```{r}
ema_all %>% 
  tabyl(ema_7_1)
```


"How likely are you to encounter risky situations (people, places, or things) within the next week?" (moring EMA only)
```{r}
ema_all %>% 
  filter(ema_type == "morning") %>% 
  tabyl(ema_8_1)
```

"How likely are you to encounter a stressful event within the next week?" (morning EMA only)
```{r}
ema_all %>% 
  filter(ema_type == "morning") %>% 
  tabyl(ema_9_1)
```

"How likely are you to drink any alcohol within the next week?" (morning EMA only)
```{r}
ema_all %>% 
  filter(ema_type == "morning") %>% 
  tabyl(ema_10_1)
```



### Write csvs

FIX: remove Qualtrics variables: location_latitude, location_longitude, ip_address?    


FIX: Uncomment write csv when test subids are removed - currently still in for checking/EDA

```{r}
# ema_morning %>% 
#   write_csv(file.path(path_shared, "ema_morning.csv"))
# 
# ema_later %>% 
#   write_csv(file.path(path_shared, "ema_later.csv"))
```
