---
title: "Create lapse labels"
author: "John Curtin"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "P:/studydata/risk/knits/shared"
    )
  })
---

### Code Status

In progress.   There are still some errors in the raw EMA and interview data to explore or correct before we have
a set of accurate lapses and periods to exclude for no_lapse observations     

Outstanding issues:   

- currently clean_qualtrics function is not adapted to handle recode_tz entries for out of town EMAs. Discuss with JC how to best implement this.   

- log entries to discuss with JC have been flagged in flagged_log_entries.Rmd    

- Some incomplete surveys were taken again and completed within a minute. See cln_ema.Rmd and discuss.     

- many participants have more than 4 daily surveys and often surveys are taken within minutes of each other. How to handle?    

### Conclusions   

- More complete EDA is in cln_ema.Rmd. This file focusses on EDA related to whether a lapse/non-lapse is reliable for sampling from.       

- EMA compliance gaps and reasons for them are noted in cln_ema.Rmd    

- All unfinished surveys (finished = 0) have at least ema_1 answered which reports if there have been any lapses since the last survey. These should be used for exclusion.          

- Subids 104 and 128 have over 100 reported lapses.     
  - According to notes, subid 104 reported lapses everyday on study.     
  - Audio messages seem to support 128's frequent lapses - notes say "Audio message for 10/05 reports that the sub has been drinking off and on for the last 2 or 3 days; Lots of lapses reported on 10/03-10/05; Some overlap but not all which further emphasizes info from audio message; Audio message on 10/17 reported drinking the night before - Lots of lapses being reported during time; Participant mentioned that she drank some on 11/18 but not a ton; She also reported on 11/17 that she has not been fighting any urges; No explicit mention of drinking in audio message just that sub was not looking forward to going home; Lots of little lapses reported around this time (12/3/18)"        

### Set Up Environment

Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```

Absolute paths
```{r, paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_raw <- "P:/studydata/risk/data_raw"
          path_processed <- "P:/studydata/risk/data_processed/shared"
          path_lab_support <- "P:/toolboxes/lab_support"},

        # IOS paths
        Darwin = {
          path_raw <- "/Volumes/private/studydata/risk/data_raw"
          path_processed <- "/Volumes/private/studydata/risk/data_processed/shared"
          path_lab_support <- "/Volumes/private/toolboxes/lab_support"}
        )
```

Relative paths
```{r, paths}
path_log <- "shared/notes"
```

Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) # detect and warn about function conflicts
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

library(here)  # establish project directory consistently as working directory
```


Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
# for data wrangling
library(tidyverse)
library(vroom)
library(janitor)
library(lubridate)
```


Source for script
```{r, source_script, message=FALSE, warning=FALSE}
source(here(path_lab_support, "print_kbl.R"))
source(here("shared/fun_risk.R"))
```


### Study Dates/Times

We will not predict lapses outside of study participation dates. Need info on:

* Start and end dates for participation
* Who completed followup_1 so that they have context
* Time of the last EMA so we can know the definite window for no_lapse sampling.
We can assume no_lapse sampling starts with study_start but it end with the earlier
of study_end or ema_end (time of the last ema that we trust has valid data)


```{r}
dates <- get_study_dates(here(path_processed, "visit_dates.csv"),
                         here(path_processed, "ema_morning.csv"),
                         here(path_processed, "ema_later.csv")) %>% 
  filter(followup_complete) %>% 
  select(-followup_complete) %>% 
  glimpse()

dates %>% print_kbl()
```


### EMA Lapses

EMA lapse reports
```{r, message=FALSE}
emam <- vroom(here(path_processed, "ema_morning.csv"), col_types = vroom::cols()) %>% 
  rename_with(~ str_replace(.x, "emam_", "ema_"))

emal <- vroom(here(path_processed, "ema_later.csv"), col_types = vroom::cols())%>% 
  rename_with(~ str_replace(.x, "emal_", "ema_"))

ema <- bind_rows(emam, emal) %>% 
  select(subid, response_id, start_date, end_date, utc, finished,
         contains("ema_1"), -ema_1_5, -ema_10_1) %>% 
  mutate(subid = as.numeric(subid)) %>% 
  arrange(subid, start_date) %>%  
  filter(ema_1 == "Yes") %>% 
  select(-ema_1) %>% 
  glimpse()
```

#### EDA for EMA lapses

KENDRA TO DO
Review notes from data cleaning for issues with remaining lapses

May need some more EDA before we remove variables in next code chunk

Notes on EMA lapse/non-lapse validity    
read in log and notes
```{r}
log <- vroom::vroom(here(path_log, "log_ema_morning.csv"), col_types = vroom::cols()) %>% 
  bind_rows(vroom::vroom(here(path_log, "log_ema_morning.csv"), col_types = vroom::cols()))

notes <- vroom::vroom(here(path_log, "raw_notes.csv"), col_types = vroom::cols())
```

**America/Chicago Timezone**    
*FIX: need to implement the recode_tz log action into clean_qualtrics*    

10 recode_tz log entries
```{r}
log %>% 
  tabyl(log_action)

log %>% 
  filter(log_action == "recode_tz") %>% 
  print_kbl()
```

These affect 5 entries since both the start and end time need to be recoded
```{r}
log %>% 
  filter(log_action == "recode_tz") %>% 
  count(response_id)
```

All `r length(unique(subset(log, log_action == "recode_tz")$response_id))` recode_tz entries contain a lapse
```{r}
ema %>% 
  filter(response_id %in% subset(log, log_action == "recode_tz")$response_id)
```



**Unfinished surveys**
```{r}

```


#### Final EMA Processing
```{r}
ema <- ema %>% 
  filter(!(finished == 0 & is.na(ema_1_1) & is.na(ema_1_2))) %>% # removed unfinished with no lapse info
  select(-start_date, -end_date, -utc, -finished) %>% 
  mutate(source = "ema")
  
ema %>% print_kbl()
```

### Interview Lapses

Interview lapse reports

* All reported in America/Chicago tz so dropped this variable
* Times indicated only when clearly reported by participant based on notes
* Source is both staff and EDA by Sarah.  Dropped this variable.
* Retained notes to check any suspect reports
```{r, message=FALSE}
interview <- vroom(here(path_raw, "additional_lapses.csv")) %>% 
  select(-report_date, -ema_1, -ema_1_5, -time_zone) %>% 
  mutate(subid = as.numeric(subid)) %>% 
  arrange(subid) %>% 
  glimpse()
```

#### EDA for Inteview Lapses

KENDRA to do

#### Final Interview Processing
```{r}
interview <- interview %>% 
  select(-source, -notes) %>% 
  mutate(source = "interview")  # use source to mean ema vs. interview
    
interview %>% print_kbl()
```


### Merge and Process Lapses

Merge
```{r}
lapses <- interview %>% 
  bind_rows(ema)
```

Process timestamp of lapse

* Calculate start_lapse and end_lapse as dttm when completed timestamp info available
* retain character date and timestamps as check and also for lapses with incomplete info

KENDRA - you will see that we seem to not have any lapses from a large number (2/3)
of participants.  Check this carefully.
```{r}
# To recode start and end times from EMA
recode_military <- function (time_12hr) {
    case_when(
    time_12hr == "Midnight" ~ "00:00",
    time_12hr == "1 AM" ~ "01:00",
    time_12hr == "2 AM" ~ "02:00",
    time_12hr == "3 AM" ~ "03:00",
    time_12hr == "4 AM" ~ "04:00",
    time_12hr == "5 AM" ~ "05:00",
    time_12hr == "6 AM" ~ "06:00",
    time_12hr == "7 AM" ~ "07:00",
    time_12hr == "8 AM" ~ "08:00",
    time_12hr == "9 AM" ~ "09:00",
    time_12hr == "10 AM" ~ "10:00",
    time_12hr == "11 AM" ~ "11:00",
    time_12hr == "Noon" ~ "12:00",
    time_12hr == "1 PM" ~ "13:00",
    time_12hr == "2 PM" ~ "14:00",
    time_12hr == "3 PM" ~ "15:00",
    time_12hr == "4 PM" ~ "16:00",
    time_12hr == "5 PM" ~ "17:00",
    time_12hr == "6 PM" ~ "18:00",
    time_12hr == "7 PM" ~ "19:00",
    time_12hr == "8 PM" ~ "20:00",
    time_12hr == "9 PM" ~ "21:00",
    time_12hr == "10 PM" ~ "22:00",
    time_12hr == "11 PM" ~ "23:00",
    is.na(time_12hr) ~ NA_character_,
    TRUE ~ "ERROR!")
}

lapses <- lapses %>% 
  mutate(lapse_start_time = recode_military(ema_1_2),
         lapse_end_time = recode_military(ema_1_4),
         lapse_start = str_c(ema_1_1, " ", lapse_start_time),
         lapse_end = str_c(ema_1_3, " ", lapse_end_time),
         lapse_start = as_datetime(lapse_start, format = "%m-%d-%Y %H:%M", tz = "America/Chicago"),
         lapse_end = as_datetime(lapse_end, format = "%m-%d-%Y %H:%M", tz = "America/Chicago"),
         duration = difftime(lapse_end, lapse_start, unit = "hour")) %>% 
  select(subid, lapse_start_date = ema_1_1, lapse_start_time, lapse_start, lapse_end_date = ema_1_3, lapse_end_time, lapse_end, duration, source)

length(unique(lapses$subid)) # 98 participants with some lapses (valid and invalid)
```


Now we:

* Join lapses with study dates
* `inner_join()` so we only have subids with lapses and with followup_complete
* Filter out complete lapses that are outside of study participation dates
* But retain lapses with missing partial timestamps b/c will be useful for excluding for no_lapse labels
```{r}
lapses <- lapses %>% 
  inner_join(dates, by = "subid") %>% 
  glimpse()  # 1371 lapses

lapses <- lapses %>% 
  filter(lapse_start >= study_start | is.na(lapse_start)) %>% 
  filter((lapse_end <= (study_end + days(1)) | is.na(lapse_end))) %>% # + days(1) sets time to midnight on study_end
  select(-study_start, -study_end, ema_end) %>%   # can get this back later from dates or with get_study_dates()
  arrange(subid, lapse_start) 

nrow(lapses)  # 1357 lapses
length(unique(lapses$subid))  # from 88 participants
```

Fix midnight reporting error.   Many participants considered midnight the same date 
as a few hours before when, in fact, midnight starts the next date.  We can see these
among the negative lapse reports.  Look at the many with `lapse_end_time` == "00:00"

```{r}
lapses %>% filter(duration < 0) %>% 
  arrange(lapse_end_time) %>% 
  print_kbl
```

It is a reasonable assumption/solution to fix dates for these errors.  John believes
this will salvage more correct lapses vs. dropping them and not likely include many
incorrect lapses.  

* We add one day `lapse_end`
* We update `lapse_end_date` to be based on the new `lapse_end`.  This is fine 
for the reports we changed and those we didnt.  However, we dot update `lapse_end_date`
if `lapse_end` was missing (b/c of a missing `lapse_end_time`)
* We update `duration`

```{r}
lapses <- lapses %>% 
  mutate(lapse_end = if_else(duration < 0 & duration > -24 & lapse_end_time == "00:00",
                             lapse_end + days(1), lapse_end, lapse_end),
         lapse_end_date = if_else(is.na(lapse_end), 
                                  lapse_end_date, format(lapse_end, "%m-%d-%Y")),
         duration = difftime(lapse_end, lapse_start, units = "hours"))


```




### Exclude Ill-formed Lapses

We will track these because we want to exclude these lapses from our final list 
of lapse observations.  We want an accurate label for positive class.  We will also 
exclude these dates/times from samples of no-lapse class observations so that they 
are as accurate as possible.


* Extract lapses have no start time and date
```{r}
lapses <- lapses %>% 
  mutate(exclude = FALSE,
         exclude = if_else(is.na(lapse_start), TRUE, exclude), # no definitive start time
         exclude = if_else(duration < 0, TRUE, exclude, exclude), # negative lapse duration
         exclude = if_else(duration > 24, TRUE, exclude, exclude)) # clear break in duration between 19 - 25 hours
```

And now we need to handle valid lapses that are overlapping.  We will merge them.
I did this after excluding above so that we didn't merge valid and invalid lapses.
If we don't trust a lapse report, we can't tell is should be merged.
```{r}
nrow(lapses)  # 1357 total lapses prior to merge

lapses <- merge_lapses(lapses)

nrow(lapses)  # 1200 total lapses after merge

sum(lapses$lapse_cnt)  # we have accounted for all original reports in the merged reports
```

Exclude any new lapses > 24 hours that aren't yet excluded
```{r}
lapses <- lapses %>% 
  mutate(exclude = if_else(duration > 24, TRUE, exclude, exclude)) 
```

#### EDA

THere are issues with 204.   They are missing lapses reported by interview.  But they also
stopped doing any ema by 5/17 even though their study end date was 6/13.

probably need to drop them for lapse analyses for anything after 5/17.  Probably
also need to add in their reported lapses at follow-up 2.   OR we drop them at the end of follow-up 1
or wherever their ema gets sketchy

THere are also issues with 180.   The interview lapses are not credible for onset time.  Those need to be exluded

Need to check on the date that are reported by EMA.  There are some notes in the log.




KENDRA - check `lapses` more carefully.  Should any other lapses be excluded.  

We also need to decide definitely what to do with lapses that have start but no end time.

* Do we retain the two lapses below with start but no end time as lapses
* Check EMA cleaning log to see why we lost the end times
* What surrounding hours do we later exclude from no_lapse sampling (assume 24 hour lapse?)?
* Let's discuss and make final decision pending your EDA

```{r}
lapses %>% 
  filter(is.na(lapse_end)) %>% 
  print_kbl(height = NULL)
```

Valid vs. invalid lapses
```{r}
lapses %>% tabyl(exclude)   # 1169 lapses; 31 excluded
```

Unique participants
```{r}
lapses %>% 
  filter(!exclude) %>% 
  pull(subid) %>% 
  unique() %>% 
  length()    # valid lapses from 86 participants
```

View valid lapses
```{r}
lapses %>% 
  filter(!exclude) %>% 
  print_kbl()
```

Lapses per participant.  We need to decide what to do with overlapping lapses

* See below
* And do we retain participants who basically drink all the time?  Lets review
once we combine overlapping lapses to see total time drinking
```{r}
lapses %>% 
  filter(!exclude) %>% 
  tabyl(subid) %>% 
  arrange(desc(n))

lapses %>% 
  filter(!exclude) %>% 
  tabyl(subid) %>% 
  pull(n) %>% 
  hist(main = "Number of lapses", breaks = 90)

# subid with many many lapses
lapses %>% 
  filter(!exclude) %>% 
  tabyl(subid) %>% 
  filter(n > 60) %>% 
  pull(subid)
```


Duration of lapses
```{r}
lapses %>% 
  filter(!exclude) %>% 
  pull(duration) %>% 
  as.numeric() %>% 
  hist(main = "Duration (hours)", breaks = 24)
```


Hour of Lapse Onset
```{r}
lapses %>% 
  mutate(lapse_start_hour = str_split_fixed(lapse_start_time, ":", 2)[,1]) %>% 
  pull(lapse_start_hour) %>% 
  as.numeric() %>% 
  hist(main = "Lapse Onset (hour)", breaks = 24)
```


Excluded Lapses
```{r}
lapses %>% 
  filter(exclude) %>% 
  print_kbl()
```



### Make labels

#### Get valid observations of lapse and no_lapse

Get valid lapse and no_lapse observations by hour

* tibble includes all hours for each subject starting on midnight on day 2 through
the end of study (or last ema, whichever is earlier)
* lapse column is true or false.  True for accurate lapse reports
* no_lapse column is true or NA.  True for accurate no_lapse, NA for excluded periods
These periods are excluded if there are with +-3 hours of a valid lapse period, or similar
periods around invalid lapse reports.  see function for more detail
```{r}
labels_all <- get_lapse_labels(lapses, dates) %>% 
  glimpse()
```



#### EDA

Check `all_labels` carefully

```{r}
labels_all %>% nrow()

labels_all %>% 
  pull(lapse) %>% 
  sum()  # 1137!

labels_all %>% 
  pull(no_lapse) %>% 
  sum()  # 298973 (hard to know what is correct here)

sum(labels_all$lapse & labels_all$no_lapse)  # 0!

sum(!labels_all$lapse & !labels_all$no_lapse)  # 10102 (should be non-zero.  Hard to know correct value)

1137 + 298973 + 10102  # 310212!
```


#### Get Final Labels 

Will use all lapses and a proportion of no_lapses

```{r}
labels_05 <- sample_labels(labels_all, .05, 19690127) %>% 
  glimpse()
```


#### EDA on Final Labels

```{r}
labels_05 %>% tabyl(label)

labels_05 %>% 
  pull(subid) %>% 
  unique() %>% 
  length()

labels_05 %>% tabyl(subid)

labels_05 %>% tabyl(subid, label)
```


Consider number of valid labels vs. total number of hours on study for each subid

consider correlation between n lapse vs. no_lapse


Need to save valid_observations and labels

Labels may be best made in a study script?   Not sure

### Save

```{r}
labels_05 %>% 
  write_csv(here(path_processed, "labels_05.csv"))

labels_all %>% 
  write_csv(here(path_processed, "labels_all.csv"))
```

