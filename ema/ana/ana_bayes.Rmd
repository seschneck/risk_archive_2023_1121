---
title: "Posterior probabilities across models"
author: "John Curtin"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/knits/ema", 
      "/Volumes/private/studydata/risk/knits/ema")
    )
  })
---

### Code Status

In use with iterative improvement

### Notes
 Can review online docs for 
 
 * [how to use rstanarm](https://cran.r-project.org/web/packages/rstanarm/vignettes/rstanarm.html)
 * [priors](https://cran.r-project.org/web/packages/rstanarm/vignettes/priors.html)
 * [warnings](https://mc-stan.org/misc/warnings.html)
 * [tutorial on rstanarm and shinystan](https://www.tqmp.org/RegularArticles/vol14-2/p099/p099.pdf)
 * [R Bloggers on perf_mod](https://www.r-bloggers.com/2019/12/tidyposteriors-bayesian-approach-to-model-comparison/)
 
### Set Up Environment

Packages for lab workflow 
```{r packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) # detect and warn about function conflicts
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
conflict_prefer("slice", "dplyr")
conflict_prefer("spec", "yardstick")
conflicts_prefer(shiny::observe)
conflicts_prefer(ggplot2::`%+%`)
```

Packages for script
```{r packages_script, message=FALSE, warning=FALSE}
library(tidyposterior)
library(tidyverse)
library(tidymodels)

theme_set(theme_classic()) 
```

Absolute paths
```{r absolute paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_input <- str_c("P:/studydata/risk/chtc/ema")
          path_processed <- str_c("P:/studydata/risk/data_processed/ema")
          path_models <- str_c("P:/studydata/risk/models/ema")},

        # IOS paths
        Darwin = {
          path_input <- str_c("/Volumes/private/studydata/risk/chtc/ema")
          path_processed <- str_c("/Volumes/private/studydata/risk/data_processed/ema")
          path_models <- str_c("/Volumes/private/studydata/risk/models/ema")}
        )
```


Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```


Source training controls 
```{r source}
# EDA
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true")
```


### Read in preds and metrics for best model

```{r load_preds_metrics}

auc_week <- readRDS(file.path(path_models, "resample_metrics_best_all_1week_0_v4_kfold.rds")) %>% 
  select(id, id2, roc_auc)

auc_day <- readRDS(file.path(path_models, "resample_metrics_best_all_1day_0_v4_kfold.rds")) %>% 
  select(id, id2, roc_auc)

auc_hour <- readRDS(file.path(path_models, "resample_metrics_best_all_1hour_0_v4_kfold.rds")) %>% 
  select(id, id2, roc_auc)

auc <- auc_week %>% 
  rename(week = roc_auc) %>% 
  mutate(day = auc_day$roc_auc,
         hour = auc_hour$roc_auc) %>% 
  glimpse
```

```{r}
auc_week %>% 
  ggplot() + 
  geom_histogram(aes(x = roc_auc), bins = 10)

auc_day %>% 
  ggplot() + 
  geom_histogram(aes(x = roc_auc), bins = 10)

auc_hour %>% 
  ggplot() + 
  geom_histogram(aes(x = roc_auc), bins = 10)
```

### All models

```{r}
pp <- auc %>% 
  perf_mod(formula = statistic ~ model + (1 | id2/id),
         # prior_intercept = rstanarm::student_t(autoscale = TRUE),
         # prior = rstanarm::student_t(autoscale = TRUE),
         transform = tidyposterior::logit_trans,  # for skewed & bounded AUC
         # iter = 6000, chains = 4,  
         adapt_delta = .99,
         cores = 4, seed = 12345,
         family = gaussian, 
)  
```

```{r}
rstanarm::prior_summary(pp$stan)
```

```{r}
summary(pp$stan)
```

```{r}
# shinystan::launch_shinystan(pp$stan)
```

```{r}
pp %>%  saveRDS(file.path(path_models, "posteriors_all_allwindows_0_v4_kfold.rds"))
```


### Model contrasts

```{r}
pp_contrasts <- contrast_models(pp, 
                                list("hour","hour", "day"), 
                                list("week", "day", "week"))
summary(pp_contrasts, size = .01)
pp_contrasts %>% autoplot(size = .01)
```

### Plots

Model posteriors
```{r}
pp_tidy <- pp %>% 
  tidy(seed = 123)

ci <- pp_tidy %>% 
  summary() %>% 
  mutate(model = factor(model, levels = c("week", "day", "hour")),
         y = 1000)

pp_tidy %>% 
  mutate(model = factor(model, levels = c("week", "day", "hour"))) %>%
  ggplot() + 
  geom_histogram(aes(x = posterior, fill = model), color = "black", alpha = .4, 
                 bins = 30) +
  geom_segment(mapping = aes(y = y+100, yend = y-100, x = mean, xend = mean,
                           color = model),
               data = ci) +
  geom_segment(mapping = aes(y = y, yend = y, x = lower, xend = upper, color = model),
                data = ci) +
  facet_wrap(~model, ncol = 1) +
  scale_y_continuous("Posterior Probability", breaks = c(0, 500, 1000)) +
  # ylab("Posterior Probability Density") +
  xlab("Area Under ROC Curve")
```

model contrast posteriors

```{r model_contrast_posteriors}
  contrast_models(list("hour","hour", "day"), 
                list("week", "day", "week")) %>% 
  summary(size = .01) %>% 
  mutate(contrast = factor(contrast, 
                           levels = c("hour vs week", "hour vs day", "day vs week"),
                           labels = c("hour vs. week", "hour vs. day", "day vs. week")),
         y = 700)

pp %>% 
  tidy(seed = 123) %>%   
  group_by(model) %>% 
  mutate(sample = row_number()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = model, values_from = posterior) %>% 
  mutate(hour_vs_week = hour - week,
         hour_vs_day = hour - day,
         day_vs_week = day - week) %>% 
  pivot_longer(cols = hour_vs_week:day_vs_week,
               names_to = "contrast",
               values_to = "posterior") %>% 
  mutate(contrast = factor(contrast, 
                           levels = c("hour_vs_week", "hour_vs_day", "day_vs_week"),
                           labels = c("hour vs. week", "hour vs. day", "day vs. week"))) %>% 
  ggplot() +
  geom_histogram(aes(x = posterior, fill = contrast), 
                 color = "black", alpha = .4, bins = 30) +
  geom_vline(xintercept = -.01, color = "yellow", linetype = "dashed", size = 1) +
  geom_vline(xintercept = .01, color = "yellow", linetype = "dashed", size = 1) +
  geom_segment(mapping = aes(y = y+100, yend = y-100, x = mean, xend = mean,
                             color = contrast), data = ci) +
  geom_segment(mapping = aes(y = y, yend = y, x = lower, xend = upper, 
                             color = contrast), data = ci) +
  facet_wrap(~contrast, ncol = 1)
```


