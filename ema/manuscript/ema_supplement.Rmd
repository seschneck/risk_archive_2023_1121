---
output:
  pdf_document:
    includes:
      in_header: !expr here::here("..", "lab_support", "rmd_templates", "latex", "header.tex")
    template: !expr here::here("..", "lab_support", "rmd_templates", "latex", "nih_latex_template.tex")
    keep_tex: no
    number_sections: no
    latex_engine: xelatex
    citation_package: default
header-includes:
  - \usepackage{helvet}
  - \usepackage[T1]{fontenc}
  - \renewcommand\familydefault{\sfdefault}
csl: "national-library-of-medicine-grant-proposals.csl"
geometry: margin=.5in
fontsize: 11pt
bibliography: paper_ema.bib
---

```{r, knitr_settings, include = FALSE}
# settings
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, cache = FALSE, 
                      message = FALSE)
options(knitr.kable.NA = '')
knitr::opts_chunk$set(fig.pos = "ht", out.extra = "")
```

```{r setup, include = FALSE}
library(papaja)
library(knitr)
library(yardstick) # for roc_curve
library(kableExtra)
library(janitor)
library(corx)
library(patchwork)
library(ggtext)
library(consort)
library(tidyverse)
library(tidymodels)
library(tidyposterior)

theme_set(theme_classic()) 
```

```{r paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_models <- "P:/studydata/risk/models/ema"
          path_data_shared <- "P:/studydata/risk/data_processed/shared"
          path_data_ema <- "P:/studydata/risk/data_processed/ema"},
        # IOS paths
        Darwin = {
          path_models <- "/Volumes/private/studydata/risk/models/ema"
          path_data_shared <- "/Volumes/private/studydata/risk/data_processed/shared"
          path_data_ema <- "/Volumes/private/studydata/risk/data_processed/ema"}
       )
```

```{r load_model_data}
# AUCs for 10x10 folds data
auc_folds_week<- readRDS(file.path(path_models, "resample_metrics_best_all_1week_0_v4_kfold.rds"))
auc_folds_day<- readRDS(file.path(path_models, "resample_metrics_best_all_1day_0_v4_kfold.rds"))
auc_folds_hour<- readRDS(file.path(path_models, "resample_metrics_best_all_1hour_0_v4_kfold.rds")) 

# Predictions data
preds_week<- readRDS(file.path(path_models, "resample_preds_best_all_1week_0_v4_kfold.rds"))
preds_day<- readRDS(file.path(path_models, "resample_preds_best_all_1day_0_v4_kfold.rds"))
preds_hour<- readRDS(file.path(path_models, "resample_preds_best_all_1hour_0_v4_kfold.rds")) 


roc_week <- preds_week %>%
  nest(.by = split_num)
  roc_curve(prob, truth = truth) %>% 
  mutate(model = "1week")

roc_day <- preds_day %>% 
  roc_curve(prob, truth = truth) %>% 
  mutate(model = "1day")

roc_hour <- preds_hour%>% 
  roc_curve(prob, truth = truth) %>% 
  mutate(model = "1hour")

roc_all <- roc_week %>% 
  bind_rows(roc_day) %>% 
  bind_rows(roc_hour)

pr_week <- preds_week %>% 
  pr_curve(prob, truth = truth) %>% 
  mutate(model = "1week")

#raw SHAPs
shap_raw_week <- readRDS(file.path(path_models, "imp_shap_raw_all_1week_0_v4.rds")) %>% 
  group_by(variable) %>% 
  slice(1) %>%   
  ungroup() %>% 
  arrange(mean_value)
shap_raw_day <- readRDS(file.path(path_models, "imp_shap_raw_all_1day_0_v4.rds")) %>% 
  group_by(variable) %>% 
  slice(1) %>%   
  ungroup() %>% 
  arrange(mean_value)
shap_raw_hour <- readRDS(file.path(path_models, "imp_shap_raw_all_1hour_0_v4.rds")) %>% 
  group_by(variable) %>% 
  slice(1) %>%   
  ungroup() %>% 
  arrange(mean_value)
```

<!-- Supplemental:  AUC figures (100 folds separate by model)-->








<!-- Supplemental:  Histogram of all fold AUCs-->


```{r caption_auc_folds}
fig_caption_auc_folds <- "Area under ROC Curve across Folds by Model.  The area under the receiver operating characteristic curve for each model (week, day, and hour) was evaluated using 10 repeats of 10-fold cross-validation.  This histogram displays the AUC observed for these models in the 100 held-out folds."
```

```{r fig_auc_folds, fig.cap = fig_caption_hist_1week, fig.height=7 }
auc_folds_week %>% mutate(model = "week") %>% 
  bind_rows(auc_folds_day %>% mutate(model = "day")) %>% 
  bind_rows(auc_folds_hour %>% mutate(model = "hour")) %>% 
  mutate(model = factor(model, levels = c("week", "day", "hour"))) %>% 
  ggplot() + 
  geom_histogram(aes(x = roc_auc, fill = model), color = "black", alpha = .4, bins = 15) +
  facet_wrap(~model, ncol = 1) +
  xlab("Area Under ROC Curve (per fold")

```


<!-- Supplemental: Paneled histograms separate by model--> 
```{r caption_predictions_week}
fig_caption_hist_1week <- "Lapse Probability Predictions Paneled by Ground Truth (Lapse vs. No Lapse) for 1week Model."
```

```{r fig_predictions_week, fig.cap = fig_caption_hist_1week, fig.height=7}
preds_week %>% 
  mutate(truth = if_else(truth == "no_lapse", "No lapse", "Lapse"),
         estimate = if_else(estimate == "no_lapse", "No lapse", "Lapse")) %>% 
  ggplot(data = ., aes(x = prob)) + 
   geom_histogram(bins = 15, fill = "white", col = "black") +
   facet_wrap(~truth, nrow = 2, scales = "free_y") +
   xlab("Pr(Lapse)") +
  theme(axis.text = element_text(size = rel(1.00)), 
        axis.title.x = element_text(size = rel(1.25)),
        strip.text = element_text(size = rel(1.75)))
```

```{r caption_predictions_day}
fig_caption_hist_1day <- "Lapse Probability Predictions Paneled by Ground Truth (Lapse vs. No Lapse) for 1day Model."
```

```{r fig_predictions_day, fig.cap = fig_caption_hist_1day, fig.height=7}
preds_day %>% 
  mutate(truth = if_else(truth == "no_lapse", "No lapse", "Lapse"),
         estimate = if_else(estimate == "no_lapse", "No lapse", "Lapse")) %>% 
  ggplot(data = ., aes(x = prob)) + 
   geom_histogram(bins = 15, fill = "white", col = "black") +
   facet_wrap(~truth, nrow = 2, scales = "free_y") +
   xlab("Pr(Lapse)") +
  theme(axis.text = element_text(size = rel(1.00)), 
        axis.title.x = element_text(size = rel(1.25)),
        strip.text = element_text(size = rel(1.75)))
```

```{r caption_predictions_hour}
fig_caption_hist_1hour <- "Lapse Probability Predictions Paneled by Ground Truth (Lapse vs. No Lapse) for 1hour Model."
```

```{r fig_predictions_hour, fig.cap = fig_caption_hist_1hour, fig.height=7}
preds_hour %>% 
  mutate(truth = if_else(truth == "no_lapse", "No lapse", "Lapse"),
         estimate = if_else(estimate == "no_lapse", "No lapse", "Lapse")) %>% 
  ggplot(data = ., aes(x = prob)) + 
   geom_histogram(bins = 15, fill = "white", col = "black") +
   facet_wrap(~truth, nrow = 2, scales = "free_y") +
   xlab("Pr(Lapse)") +
  theme(axis.text = element_text(size = rel(1.00)), 
        axis.title.x = element_text(size = rel(1.25)),
        strip.text = element_text(size = rel(1.75)))
```


<!-- Supplemental: SHAP Values for Raw Features--> 
```{r caption_shap_week}
fig_caption_shapraw_1week <- "Variable Importance (SHAP Values) for 1week Model.  Mean absolute SHAP values across observations are displayed for the top 50 raw features."
```

```{r fig_shap_week, fig.cap = fig_caption_shapraw_1week, fig.height=7}
shap_raw_week %>% 
  slice_tail(n = 50) %>%
  mutate(variable = factor(variable),
         variable = forcats::fct_inorder(variable)) %>% 
  ggplot(mapping = aes(x = variable, y = mean_value)) +
  geom_point(size = 2, color = "red") +
  geom_segment(aes(x = variable, y = mean_value, xend = variable), 
               yend = 0, colour = "grey50")  +
  ylab("Mean |SHAP| value") +
  xlab("") +
  coord_flip()
```

```{r caption_shap_day}
fig_caption_shapraw_1day <- "Variable Importance (SHAP Values) for 1day Model.  Mean absolute SHAP values across observations are displayed for the top 50 raw features."
```

```{r fig_shap_day, fig.cap = fig_caption_shapraw_1day, fig.height=7}
shap_raw_day %>% 
  slice_tail(n = 50) %>%
  mutate(variable = factor(variable),
         variable = forcats::fct_inorder(variable)) %>% 
  ggplot(mapping = aes(x = variable, y = mean_value)) +
  geom_point(size = 2, color = "red") +
  geom_segment(aes(x = variable, y = mean_value, xend = variable), 
               yend = 0, colour = "grey50")  +
  ylab("Mean |SHAP| value") +
  xlab("") +
  coord_flip()
```

```{r caption_shap_hour}
fig_caption_shapraw_1hour <- "Variable Importance (SHAP Values) for 1hour Model.  Mean absolute SHAP values across observations are displayed for the top 50 raw features."
```

```{r fig_shap_hour, fig.cap = fig_caption_shapraw_1hour, fig.height=7}
shap_raw_hour %>% 
  slice_tail(n = 50) %>%
  mutate(variable = factor(variable),
         variable = forcats::fct_inorder(variable)) %>% 
  ggplot(mapping = aes(x = variable, y = mean_value)) +
  geom_point(size = 2, color = "red") +
  geom_segment(aes(x = variable, y = mean_value, xend = variable), 
               yend = 0, colour = "grey50")  +
  ylab("Mean |SHAP| value") +
  xlab("") +
  coord_flip()
```