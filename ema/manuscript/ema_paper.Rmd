---
title: "EMA prediction"
shorttitle        : "Personal Sensing"

author: 
  - name          : "A1"
    affiliation   : "1"
  - name          : "A2"
    affiliation   : "1"
  - name          : "A3"
    affiliation   : "1"
  - name          : "A4"
    affiliation   : "1"
  - name          : "John J. Curtin"
    affiliation   : "1"
    corresponding : yes 
    address       : "1202 West Johnson St, Madison, WI 53706"
    email         : "jjcurtin@wisc.edu"

affiliation:
  - id            : "1"
    institution   : "Department of Psychology, University of Wisconsin - Madison"


authornote: |
  

abstract: |
  abstract text

  
keywords          : "key1, key2"


floatsintext      : yes
figurelist        : yes
tablelist         : no
footnotelist      : yes
linenumbers       : no
mask              : no
draft             : no

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_pdf
header-includes:
  - \raggedbottom
  - \usepackage{booktabs}
  - \definecolor{lightred}{RGB}{255,222,222}
  - \definecolor{lightblue}{RGB}{219,248,255}
  - \usepackage[justification=raggedright]{caption}
  - \usepackage{colortbl}


  
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/manuscripts/ema", 
      "/Volumes/private/studydata/risk/manuscripts/ema")
    )
  })
bibliography: paper_ema.bib
csl: national-library-of-medicine-grant-proposals.csl
---

```{r setup, include = FALSE}
library(here)
library(papaja)
library(knitr)
library(tidyverse)
library(yardstick)
library(kableExtra)
library(janitor)
library(corx)
library(patchwork)
library(ggtext)
library(consort)

knitr::opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = '')
```

```{r absolute paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_models <- "P:/studydata/risk/models/ema"
          path_data_shared <- "P:/studydata/risk/data_processed/shared"
          path_data_ema <- "P:/studydata/risk/data_processed/ema"},
        # IOS paths
        Darwin = {
          path_models <- "/Volumes/private/studydata/risk/models/ema"
          path_data_shared <- "/Volumes/private/studydata/risk/data_processed/shared"
          path_data_ema <- "/Volumes/private/studydata/risk/data_processed/ema"}
       )
```

```{r relative paths and source}

```

```{r}
disposition <- read_csv(here(path_data_ema, "disposition.csv"), col_types = "ccDDcccccccccc")
screen <- read_csv(here(path_data_shared, "screen.csv"), col_types = vroom::cols()) %>% 
  filter(subid %in% subset(disposition, analysis == "yes")$subid)
```


# Introduction


# Methods




# Results



<!-- Demographics table-->
```{r}
dem <- screen %>% 
  summarise(mean = as.character(round(mean(dem_1, na.rm = TRUE), 1)),
            SD = as.character(round(sd(dem_1, na.rm = TRUE), 1))) %>% 
  mutate(var = "Age",
         n = as.numeric(""),
         perc = as.numeric("")) %>% 
  select(var, n, perc, everything()) %>% 
  full_join(screen %>% 
  select(var = dem_2) %>% 
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = dem_3) %>% 
  mutate(var = fct_relevel(factor(var, 
                         c("American Indian/Alaska Native", "Asian", "Black/African American",
                           "White/Caucasian", "Other/Multiracial")))) %>%
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = dem_4) %>% 
  mutate(var = case_when(var == "No, I am not of Hispanic, Latino, or Spanish origin" ~ "No",
                         TRUE ~ "Yes"),
         var = fct_relevel(factor(var, c("Yes", "No")))) %>% 
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = dem_5) %>% 
  mutate(var = fct_relevel(factor(var, 
                         c("Less than high school or GED degree", "High school or GED", 
                           "Some college", "2-Year degree", "College degree", "Advanced degree")))) %>%
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = dem_6, dem_6_1) %>% 
  mutate(var = case_when(dem_6_1 == "Full-time" ~ "Employed full-time",
                         dem_6_1 == "Part-time" ~ "Employed part-time",
                         TRUE ~ var)) %>% 
  mutate(var = fct_relevel(factor(var, 
                         c("Employed full-time", "Employed part-time", "Full-time student",
                           "Homemaker", "Disabled", "Retired", "Unemployed", 
                           "Temporarily laid off, sick leave, or maternity leave",
                           "Other, not otherwise specified")))) %>%
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  summarise(mean = as.character(round(mean(dem_7, na.rm = TRUE), 0)),
            SD = as.character(round(sd(dem_7, na.rm = TRUE), 0))) %>% 
  mutate(var = "Income",
        n = as.numeric(""),
        perc = as.numeric("")) %>% 
  select(var, n, perc, everything()), by = c("var", "n", "perc", "mean", "SD")) %>% 
  full_join(screen %>% 
  select(var = dem_8) %>% 
  mutate(var = case_when(var == "Never Married" ~ "Never married",
                         TRUE ~ var)) %>% 
  mutate(var = fct_relevel(factor(var, 
                         c("Never married", "Married", "Divorced", "Separated",
                           "Widowed")))) %>%
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc"))

# display and format table
dem %>% 
  kbl(col.names = c("", "<i>n</i>", "%", "<i>M</i>", "<i>SD</i>"),
      digits = 1,
      align = c("l", "c", "c", "c", "c"),
      caption = "<b>Table 1<br><br>Demographics</b>",
      table.attr = "style='width:60%;'",
      escape = FALSE) %>% 
  row_spec(row = 0, align = "c") %>% 
  kable_classic(html_font = "Times New Roman", position = "left") %>% 
  pack_rows("Sex", 2, 3, bold = FALSE) %>% 
  pack_rows("Race", 4, 8, bold = FALSE) %>% 
  pack_rows("Hispanic, Latino, or Spanish Origin", 9, 10, bold = FALSE) %>% 
  pack_rows("Education", 11, 16, bold = FALSE) %>% 
  pack_rows("Employment", 17, 25, bold = FALSE) %>% 
  pack_rows("Marital Status", 27, 31, bold = FALSE) %>% 
  footnote("N = 151")
```

<!-- Alcohol Use History table-->

```{r}
auh <- screen %>% 
  summarise(mean = mean(auh_1, na.rm = TRUE),
            SD = sd(auh_1, na.rm = TRUE)) %>% 
  mutate(var = "Age of first drink",
        n = as.numeric(""),
        perc = as.numeric("")) %>% 
  select(var, n, perc, everything()) %>% 
  full_join(screen %>% 
  summarise(mean = mean(auh_2, na.rm = TRUE),
            SD = sd(auh_2, na.rm = TRUE)) %>% 
  mutate(var = "Age of regular drinking",
        n = as.numeric(""),
        perc = as.numeric("")) %>% 
  select(var, n, perc, everything()), by = c("var", "n", "perc", "mean", "SD")) %>% 
  full_join(screen %>% 
  summarise(mean = mean(auh_3, na.rm = TRUE),
            SD = sd(auh_3, na.rm = TRUE)) %>% 
  mutate(var = "Age at which drinking became problematic",
        n = as.numeric(""),
        perc = as.numeric("")) %>% 
  select(var, n, perc, everything()), by = c("var", "n", "perc", "mean", "SD")) %>% 
  full_join(screen %>% 
  summarise(mean = mean(auh_4, na.rm = TRUE),
            SD = sd(auh_4, na.rm = TRUE)) %>% 
  mutate(var = "Age of first quit attempt",
        n = as.numeric(""),
        perc = as.numeric("")) %>% 
  select(var, n, perc, everything()), by = c("var", "n", "perc", "mean", "SD")) %>% 
  full_join(screen %>% 
  summarise(mean = mean(auh_5, na.rm = TRUE),
            SD = sd(auh_5, na.rm = TRUE)) %>% 
  mutate(var = "Number of Quit Attempts",
        n = as.numeric(""),
        perc = as.numeric("")) %>% 
  select(var, n, perc, everything()), by = c("var", "n", "perc", "mean", "SD")) %>% 
  full_join(screen %>% 
  select(var = auh_6_1) %>%
  mutate(var = case_when(var == "Long-Term Residential Treatment (more than 6 months)" ~ "Long-term residential (6+ mos.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = auh_6_2) %>%
  mutate(var = case_when(var == "Short-Term Residential Treatment (less than 6 months)" ~ "Short-term residential (< 6 mos.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = auh_6_3) %>%
  mutate(var = case_when(var == "Outpatient Treatment" ~ "Outpatient",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = auh_6_4) %>%
  mutate(var = case_when(var == "Individual Counseling" ~ "Individual counseling",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = auh_6_5) %>%
  mutate(var = case_when(var == "Group Counseling" ~ "Group counseling",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = auh_6_6) %>%
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = auh_6_7) %>%
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = auh_7) %>% 
  mutate(var = fct_relevel(factor(var, c("Yes", "No")))) %>%
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  mutate(across(dsm5_1:dsm5_11, ~ recode(., "No" = 0, "Yes" = 1))) %>% 
  rowwise() %>% 
  # calculate dsm5 score by adding up dsm5_1 through dsm5_11
  mutate(dsm5_total = sum(c(dsm5_1, dsm5_2, dsm5_3, dsm5_4, dsm5_5, dsm5_6, dsm5_7, 
                            dsm5_8, dsm5_9, dsm5_10, dsm5_11))) %>% 
  ungroup() %>% 
  summarise(mean = mean(dsm5_total),
            SD = sd(dsm5_total)) %>% 
  mutate(var = "AUD DSM-5 Symptom Count*",
        n = as.numeric(""),
        perc = as.numeric("")) %>% 
  select(var, n, perc, everything()), by = c("var", "n", "perc", "mean", "SD")) %>% 
  full_join(screen %>% 
  select(var = assist_1_1) %>%
  filter(var == "Yes") %>% 
  mutate(var = case_when(var == "Yes" ~ "Tobacco products (cigarettes, chewing tobacco, cigars, etc.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = assist_1_2) %>%
  filter(var == "Yes") %>% 
  mutate(var = case_when(var == "Yes" ~ "Cannabis (marijuana, pot, grass, hash, etc.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = assist_1_3) %>%
  filter(var == "Yes") %>% 
  mutate(var = case_when(var == "Yes" ~ "Cocaine (coke, crack, etc.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = assist_1_4) %>%
  filter(var == "Yes") %>% 
  mutate(var = case_when(var == "Yes" ~ "Amphetamine type stimulants (speed, diet pills, ecstasy, etc.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = assist_1_5) %>%
  filter(var == "Yes") %>% 
  mutate(var = case_when(var == "Yes" ~ "Inhalants (nitrous, glue, petrol, paint thinner, etc.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = assist_1_6) %>%
  filter(var == "Yes") %>% 
  mutate(var = case_when(var == "Yes" ~ "Sedatives or sleeping pills (Valium, Serepax, Rohypnol, etc.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = assist_1_7) %>%
  filter(var == "Yes") %>% 
  mutate(var = case_when(var == "Yes" ~ "Hallucinogens (LSD, acid, mushrooms, PCP, Special K, etc.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) %>% 
  full_join(screen %>% 
  select(var = assist_1_8) %>%
  filter(var == "Yes") %>% 
  mutate(var = case_when(var == "Yes" ~ "Opioids (heroin, morphine, methadone, codeine, etc.)",
                         TRUE ~ var)) %>% 
  group_by(var) %>% 
  drop_na() %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / 154) * 100), by = c("var", "n", "perc")) 

# display and format table
auh %>%
  kbl(col.names = c("", "<i>n</i>", "%", "<i>M</i>", "<i>SD</i>"),
      digits = 1,
      align = c("l", "c", "c", "c", "c"),
      caption = "<b>Table 2<br><br>Alcohol Related Information</b>",
      table.attr = "style='width:70%;'",
      escape = FALSE) %>% 
  row_spec(row = 0, align = "c") %>% 
  kable_classic(html_font = "Times New Roman", position = "left") %>% 
  pack_rows("AUD Milestones", 1, 4, bold = FALSE) %>% 
  pack_rows("Lifetime History of Treatment (Can choose more than 1)", 6, 12, bold = FALSE) %>% 
  pack_rows("Received Medication for AUD", 13, 14, bold = FALSE) %>% 
  pack_rows("Lifetime Drug Use", 16, 23, bold = FALSE) %>% 
  footnote("N = 151")
```



## Figures

Get predictions
```{r load_preds}
preds_week<- readRDS(here(path_models, "resample_preds_best_all_1week_0_v4_kfold.rds"))
preds_day<- readRDS(here(path_models, "resample_preds_best_all_1day_0_v4_kfold.rds"))
preds_hour<- readRDS(here(path_models, "resample_preds_best_all_1hour_0_v4_kfold.rds")) 

roc_week <- preds_week %>% 
  roc_curve(prob, truth = truth) %>% 
  mutate(model = "1week")

roc_day <- preds_day %>% 
  roc_curve(prob, truth = truth) %>% 
  mutate(model = "1day")

roc_hour <- preds_hour%>% 
  roc_curve(prob, truth = truth) %>% 
  mutate(model = "1hour")

roc_all <- roc_week %>% 
  bind_rows(roc_day) %>% 
  bind_rows(roc_hour)

pr_week <- preds_week %>% 
  pr_curve(prob, truth = truth) %>% 
  mutate(model = "1week")

pr_day <- preds_day %>% 
  pr_curve(prob, truth = truth) %>% 
  mutate(model = "1day")

pr_hour <- preds_hour%>% 
  pr_curve(prob, truth = truth) %>% 
  mutate(model = "1hour")

pr_all <- pr_week %>% 
  bind_rows(pr_day) %>% 
  bind_rows(pr_hour)
```

get shaps
```{r load_shaps}
shap_raw_week <- readRDS(here(path_models, "imp_shap_raw_all_1week_0_v4.rds"))
shap_raw_day <- readRDS(here(path_models, "imp_shap_raw_all_1day_0_v4.rds"))
shap_raw_hour <- readRDS(here(path_models, "imp_shap_raw_all_1hour_0_v4.rds"))

shap_grouped_week <- readRDS(here(path_models, "imp_shap_grouped_all_1week_0_v4.rds"))
shap_grouped_day <- readRDS(here(path_models, "imp_shap_grouped_all_1day_0_v4.rds"))
shap_grouped_hour <- readRDS(here(path_models, "imp_shap_grouped_all_1hour_0_v4.rds"))
```

<!-- Consort Diagram: I think the powerpoint version looks a bit nicer so we can discuss if we want to keep this.-->
```{r fig.width=10, fig.height=8}
consort_plot(data = disposition,
             orders = c(eligible = "Eligible Sample",
                        consented_reason = "Not Consented",
                        consented = "Consented",
                        enrolled_reason = "Not Enrolled",
                        enrolled = "Enrolled",
                        completed_followup_reason = "Discontinued",
                        completed_followup = "Completed through Followup 1",
                        analysis_reason = "Excluded",
                        analysis = "Final Analysis"),
             side_box = c("consented_reason", 
                          "enrolled_reason", 
                          "completed_followup_reason",
                          "analysis_reason"),
             cex = .9)
```


<!-- Single AUC figure by model-->  
```{r}
fig_caption_auc <- "Receiver operating characterititic curves for models by prediction window."
```

```{r fig.cap = fig_caption_auc, out.extra = "", fig.pos="h", warning = FALSE}

roc_all %>% 
  ggplot(aes(x = 1 - specificity, y = sensitivity, color = model)) +
  geom_path() +
  geom_abline(lty = 3) +
  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +
  labs(x = "Specificity",
       y = "Sensitivity") +
  scale_x_continuous(breaks = seq(0,1,.25),
    labels = sprintf("%.2f", seq(1,0,-.25))) +
  theme(axis.text = element_text(size = rel(1.50)), 
        axis.title = element_text(size = rel(1.75)))
```

<!-- Supplemental:  AUC figures (100 folds separate by model)-->

<!-- Supplemental: Paneled histograms separate by model--> 

<!-- Single Posteriors for AUC by model with rope-->

<!-- Table of auc, sen, spec, ppv, npv, accuracy, balanced accuracy by model-->

<!-- PR curve by model-->
```{r}
pr_all %>% 
  ggplot(aes(x = recall, y = precision, color = model)) +
  geom_path() +
  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +
  labs(x = "Sensitivity (Recall)",
       y = "Positive Predictive Value (Precision)")
```

<!-- SHAP Importance figures separate by model  or same fig?-->


```{r}
shap_grouped %>% 
  group_by(group) %>% 
  summarize(mean_value = mean(abs(shap)), .groups = "drop") %>% 
  arrange(mean_value) %>% 
  mutate(group = factor(group),
         group = forcats::fct_inorder(group)) %>% 
  ggplot(mapping = aes(x = group, y = mean_value)) +
  geom_point(size = 2, color = "red") +
  geom_segment(aes(x = group, y = mean_value, xend = group), 
               yend = 0, colour = "grey50")  +
  ylab("Mean |SHAP| value") +
  coord_flip()
```


## Supplemental Figures


# Discussion


\newpage

# Acknowledgments

This research was supported by the National Institute of Alcohol Abuse and Alcoholism (NIAAA) under award number R01 AA024391 (J Curtin).

The authors wish to thank Susan E. Wanta for her role as project administrator and her help with data curation. The authors also wish to thank Candace Lightheart, Jill Nagler, Kerry Keiser, and Megan Shultz for their contributions to data collection and Chris Gioia for the clinical supervision he provided to graduate students. 


\newpage

# Conflicts of Interest

None declared.


\newpage

# References
<div id="refs"></div>



\newpage

```{r}
fig_caption_1 <- "Flowchart of participant retention over the course of the 3-month study. This figure displays retention and attrition of all eligible participants at various stages from consent through study completion.  It also displays the reasons for attrition categorized as due to acceptability, other reasons, or unknown. \\linebreak *All participants who completed through follow-up 1 were used in the analyses."
```

```{r figure-1, fig.cap = fig_caption_1, out.extra = "", fig.pos="h", warning = FALSE}
include_graphics(here("burden/manuscript/submission_2/figs/fig_disposition.jpg"), dpi = 150)
```

\newpage

