---
title: "Create EMA lapse labels"
author: "John Curtin and Kendra Wyant"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/knits/ema", 
      "/Volumes/private/studydata/risk/knits/ema")
    )
  })
---


### Set Up Environment

Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```

Absolute paths
```{r, absolute paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_raw <- "P:/studydata/risk/data_raw"
          path_processed <- "P:/studydata/risk/data_processed/shared"
          path_ema <- "P:/studydata/risk/data_processed/ema"},

        # IOS paths
        Darwin = {
          path_raw <- "/Volumes/private/studydata/risk/data_raw"
          path_processed <- "/Volumes/private/studydata/risk/data_processed/shared"
          path_ema <- "/Volumes/private/studydata/risk/data_processed/ema"}
        )
```

Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) # detect and warn about function conflicts
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

library(here)  # establish project directory consistently as working directory
```


Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
# for data wrangling
library(tidyverse)
library(vroom)
library(janitor)
library(lubridate)
library(furrr)
```


Source for script
```{r, source_script, message=FALSE, warning=FALSE}
source(here("../lab_support/print_kbl.R"))
source(here("shared/fun_local.R"))
```

### Read in lapses and sates
```{r}
lapses <- vroom(here(path_processed, "lapses.csv"), col_types = vroom::cols()) %>% 
  mutate(across(c(lapse_start, lapse_end, ema_end)), with_tz(., "America/Chicago"))

dates <- vroom(here(path_ema, "study_dates.csv"), col_types = vroom::cols()) %>%
  mutate(across(study_start:ema_end), with_tz(., tz = "America/Chicago")) 
```





# DEMO START

### Get valid observations of lapse and no_lapse

Make labels with 1 hour window duration
start at midnight on second day

subids 
```{r}
subids <- c(1, 2, 3)
```


```{r}  
labels_1_hour <- subids %>% 
  future_map_dfr(~ get_lapse_labels(.x, lapses, dates, 
                                    buffer_start = 60 * 60 * 24, window_dur = 3600),
                 .options = furrr_options(seed = NULL)) %>% 
  glimpse()
```

Make labels with 1 day window duration
```{r}   
labels_1_day <- subids %>% 
  future_map_dfr(~ get_lapse_labels(.x, lapses, dates, 
                                    buffer_start = 60 * 60 * 24, window_dur = 86400),
                 .options = furrr_options(seed = NULL)) %>% 
  glimpse()
```

Make labels with 1 week window duration
```{r}
labels_1_week <- subids %>% 
  future_map_dfr(~ get_lapse_labels(.x, lapses, dates, 
                                    buffer_start = 60 * 60 * 24, window_dur = 604800),
                 .options = furrr_options(seed = NULL)) %>% 
  glimpse()
```




### Check counts of lapse and no lapse labels


Check counts in `labels_1_hour`       

* A total of `r nrow(labels_1_hour)` labels made.    
* `r nrow(subset(labels_1_hour, lapse))` labels are lapses.   
* `r nrow(subset(labels_1_hour, no_lapse))` labels are labeled as no lapse.    
* `r sum(labels_1_hour$lapse & labels_1_hour$no_lapse)` are labeled lapse and no lapse (should be zero).   
* `r sum(!labels_1_hour$lapse & !labels_1_hour$no_lapse)` are not labeled lapse or no lapse (should be non-zero. Hard to know correct value).  
* `r nrow(subset(labels_1_hour, lapse))` + `r nrow(subset(labels_1_hour, no_lapse))` + `r sum(!labels_1_hour$lapse & !labels_1_hour$no_lapse)` = `r nrow(subset(labels_1_hour, lapse)) + nrow(subset(labels_1_hour, no_lapse)) +  sum(!labels_1_hour$lapse & !labels_1_hour$no_lapse)`    


Check counts in `labels_1_day`       

* A total of `r nrow(labels_1_day)` labels made.    
* `r nrow(subset(labels_1_day, lapse))` labels are lapses.   
* `r nrow(subset(labels_1_day, no_lapse))` labels are labeled as no lapse.    
* `r sum(labels_1_day$lapse & labels_1_day$no_lapse)` are labeled lapse and no lapse (should be zero).   
* `r sum(!labels_1_day$lapse & !labels_1_day$no_lapse)` are not labeled lapse or no lapse (should be non-zero. Hard to know correct value).  
* `r nrow(subset(labels_1_day, lapse))` + `r nrow(subset(labels_1_day, no_lapse))` + `r sum(!labels_1_day$lapse & !labels_1_day$no_lapse)` = `r nrow(subset(labels_1_day, lapse)) + nrow(subset(labels_1_day, no_lapse)) +  sum(!labels_1_day$lapse & !labels_1_day$no_lapse)`     


Check counts in `labels_1_week`       

* A total of `r nrow(labels_1_week)` labels made.    
* `r nrow(subset(labels_1_week, lapse))` labels are lapses.   
* `r nrow(subset(labels_1_week, no_lapse))` labels are labeled as no lapse.    
* `r sum(labels_1_week$lapse & labels_1_week$no_lapse)` are labeled lapse and no lapse (should be zero).   
* `r sum(!labels_1_week$lapse & !labels_1_week$no_lapse)` are not labeled lapse or no lapse (should be non-zero. Hard to know correct value).  
* `r nrow(subset(labels_1_week, lapse))` + `r nrow(subset(labels_1_week, no_lapse))` + `r sum(!labels_1_week$lapse & !labels_1_week$no_lapse)` = `r nrow(subset(labels_1_week, lapse)) + nrow(subset(labels_1_week, no_lapse)) +  sum(!labels_1_week$lapse & !labels_1_week$no_lapse)`     





### Get Final Labels 

Removes no_lapse labels that we do not want to use (e.g., they are 24 hours before or after a lapse)
```{r}
labels_1_hour <- bind_labels(labels_1_hour) %>% 
  rename(lapse = label) %>% 
  mutate(lapse = if_else(lapse == "lapse", "yes", "no")) %>% 
  arrange(subid, dttm_label) %>% 
  glimpse()

labels_1_day <- bind_labels(labels_1_day) %>% 
  rename(lapse = label) %>% 
  mutate(lapse = if_else(lapse == "lapse", "yes", "no")) %>% 
  arrange(subid, dttm_label) %>% 
  glimpse()

labels_1_week <- bind_labels(labels_1_week) %>% 
  rename(lapse = label) %>% 
  mutate(lapse = if_else(lapse == "lapse", "yes", "no")) %>% 
  arrange(subid, dttm_label) %>% 
  glimpse()
```




