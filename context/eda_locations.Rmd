---
title: "Clean and process location data from interviews"
author: "Hannah Moshontz & John Curtin"
output: 
  html_document:
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "P:/studydata/risk/knits/context")
  })
---

### Code status

Under construction


### Notes

Purpose: This file summarizes the location labels supplied by participants for the Liu et al. GPS project. In that project, place labels (supplied by participants) are predicted by geospatial and temporal features of people's GPS data in the risk project. In this markdown, I aim to:
1. Recommend what data to exclude on the basis of: multiple homes, multiple workplaces.
2. Understand meaningful, risk-related clusters of labels. We want these labels to be useful for inclusion in models like the kind we are creating for the primary aims of the risk and risk2 projects.
3. Identify any "other" labels that fit existing factor levels. The goal is for these labels to be as accurate as possible, since they serve as ground truth.

Inputs:  Opens data files in path_raw

* locations.csv

### Setup

Paths 
```{r}
path_processed <- "P:/studydata/risk/data_processed" 
```

Packages and Source
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
library(janitor)
library(purrr)
library(kableExtra)
library(geosphere)
library(here)
```

### Import locations files

```{r}
locations <- read_csv(file.path(path_processed, "locations.csv")) %>% 
  mutate(across(where(is_character), str_to_lower),
         across(
           c("type", 
             "drank",
             "alcohol",
             "avoid",
             "vacation"),
           as_factor),
         risk = factor(risk, 
                       levels = c("no", "low", "medium", "high"), 
                       ordered = TRUE),
         emotion = factor(emotion,
                          levels = c("unpleasant", "mixed", "neutral", "pleasant"),
                          ordered = TRUE),
         date_of_observation = as_datetime(utc, tz = "America/Chicago")) %>% 
  select(-utc) %>% 
  glimpse()
```


### EDA

#### 1. Recommend what data to exclude on the basis of: multiple homes, multiple workplaces.

##### Multiple homes

```{r}
locations %>% 
  filter(type == "home") %>% 
  group_by(subid, type) %>% 
  count() %>% 
  arrange(n) %>% 
  filter(n > 1) %>% 
  kable(caption = "Multiple homes", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")
```

Investigating when homes were added and how far away they are (as they may be the same place, but different lat and long).

```{r}
subs_with_mult_homes <- locations %>% 
  filter(type == "home") %>% 
  group_by(subid, type) %>% 
  count() %>% 
  arrange(n) %>% 
  filter(n > 1) %>% 
  pull(subid)

locations %>% 
  filter(type == "home") %>% 
  filter(subid %in% subs_with_mult_homes) %>% 
  group_by(subid) %>% 
  mutate( #adding readable month
    month_of_obs = month(date_of_observation, label = TRUE),
    next_lat = lead(lat),
    next_long = lead(long)) %>% 
  arrange(month_of_obs) %>% 
  rowwise() %>% 
  mutate(
    miles_to_next_home = distm(c(long, lat), c(next_long, next_lat))*0.000621371) %>% 
  group_by(subid, type, month_of_obs) %>% 
  summarize(
    n = n(),
    miles_to_next_home = first(miles_to_next_home)) %>% 
  ungroup() %>% 
  kable(caption = "Multiple homes", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")
```

Some of these places were added later, and some appear to be the same place with different lat/long.

##### Multiple workplaces
```{r}
subs_with_mult_works <- locations %>% 
  filter(type == "work") %>% 
  group_by(subid, type) %>% 
  count() %>% 
  arrange(n) %>% 
  filter(n > 1) %>% 
  pull(subid)

locations %>% 
  filter(type == "work") %>% 
  filter(subid %in% subs_with_mult_works) %>% 
  group_by(subid) %>% 
  mutate( #adding readable month
    month_of_obs = month(date_of_observation, label = TRUE),
    next_lat = lead(lat),
    next_long = lead(long)) %>% 
  arrange(month_of_obs) %>% 
  rowwise() %>% 
  mutate(
    miles_to_next_work = distm(c(long, lat), c(next_long, next_lat))*0.000621371) %>% 
  group_by(subid, type, month_of_obs) %>% 
  summarize(
    n = n(),
    miles_to_next_work = first(miles_to_next_work)) %>% 
  ungroup() %>% 
  kable(caption = "Multiple works", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")
```

Similar pattern to homes, although some people have a ton of observations. Most appear to be truly different places.

```{r}
locations %>% 
  filter(type == "work") %>% 
  group_by(subid, type) %>%
  count() %>% 
  filter(n > 5) %>% 
  arrange(desc(n)) %>% 
  kable(caption = "People with over 5 work locations", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")
```

Some people appear to have work that, by its nature, involves traveling to different places. Consider doing analyses in ways that can accomodate this kind of work given how common it is.

#### 2. Understand meaningful, risk-related clusters of labels. We want these labels to be useful for inclusion in models like the kind we are creating for the primary aims of the risk and risk2 projects.


```{r}
locations %>% 
  tabyl(type, drank) %>% 
  tibble() %>% 
  mutate(drink_majority = (yes > no)) %>% 
  arrange(desc(drink_majority)) %>% 
  kable(caption = "Place type by drank", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")
```

```{r}
locations %>% 
  tabyl(type, alcohol) %>% 
  tibble() %>% 
  mutate(alcohol_majority = (yes > no)) %>% 
  arrange(desc(alcohol_majority)) %>% 
  kable(caption = "Place type by alcohol", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")
```

```{r}
locations %>% 
  tabyl(type, avoid) %>% 
  tibble() %>% 
  mutate(avoid_majority = (yes > no)) %>% 
  arrange(desc(avoid_majority)) %>% 
  kable(caption = "Place type by avoid", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")
```

```{r}
locations %>% 
  tabyl(type, risk) %>% 
  tibble() %>% 
  arrange(desc(no)) %>% 
  kable(caption = "Place type by risk", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")

locations %>% 
  group_by(type) %>% 
  summarize(mean_risk = mean(as.numeric(risk), na.rm = TRUE),
            sd_risk = sd(as.numeric(risk), na.rm = TRUE)) %>% 
  arrange(desc(mean_risk)) %>% 
  kable(caption = "Place type by mean risk", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")
```

```{r}
locations %>% 
  tabyl(type, emotion) %>% 
  tibble() %>% 
  arrange(desc(pleasant)) %>% 
  kable(caption = "Place type by emotion", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")

locations %>% 
  group_by(type) %>% 
  summarize(mean_emotion = mean(as.numeric(emotion), na.rm = TRUE),
            sd_emotion = sd(as.numeric(emotion), na.rm = TRUE)) %>% 
  arrange(desc(mean_emotion)) %>% 
  kable(caption = "Place type by mean emotion", table.attr = "style='width:50%;'") %>%
  kable_styling(position = "left")
```


#### 3. Identify any "other" labels that fit existing factor levels. The goal is for these labels to be as accurate as possible, since they serve as ground truth.


```{r}

```


#### Misc -- investigating type NA values

```{r}
locations %>% 
  filter(is.na(type))
```

The second of these (subid == 131, vacation == yes) is at a landmark in colorado.

The first appears (subid == 110) appears to be a house, but this person seems to work in lots of different places, including places nearby.