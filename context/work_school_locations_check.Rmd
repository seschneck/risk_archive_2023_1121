---
title: "Review and resolution of each participants work/school locations"
author: "Hannah Moshontz"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "P:/studydata/risk/knits/context")
  })
---


### Notes

Purpose: This file reviews each person's GPS data to resolve issues related to multiple work and school locations.

Inputs:  user_locations_check.csv, which is a copy of a sheet in "workbook_sent_from_xinyi.xlsx" with cleaned variable names. Many of the columns we will not use (the binary description and decision columns Xinyi created), but many contain information about activity zones that we do not otherwise have.


### Setup

Packages and Source
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(janitor)
library(purrr)
library(kableExtra)
library(tidylog)
library(ggmap)  
register_google(key = "AIzaSyBBwIG1tC4QZi5QrTnhXXLktIPD8NlVVI0") #API key
```

### Import file

```{r import locations check}
location_descriptions <- read_csv("./user_locations_check.csv",
                            col_names = TRUE) %>% 
  clean_names("snake") %>% 
  glimpse()
```

```{r import locations}
locations <- read_csv("P:/studydata/risk/data_processed/gps/to_share/locations.csv",
                      col_names = TRUE) %>% 
  mutate(subid = as.numeric(subid)) %>% 
  clean_names("snake") %>% 
  mutate(time = lubridate::as_datetime(utc, tz = "America/Chicago")) %>% 
  glimpse()
```

```{r import gps}
gps <- read_rds("P:/studydata/risk/data_processed/shared/gps.rds") %>% 
  rename(long = lon) %>% 
  glimpse()

```


### Merge

```{r create combined dataset}
location_check <- gps %>% 
  mutate(location_source = "gps_data") %>% 
  select(subid, lat, long, time, location_source) %>% 
  bind_rows(
    locations %>% 
      mutate(location_source = "labeled_home") %>% 
      filter(type == "HOME") %>% 
      select(subid, lat, long, time, location_source)) %>% 
  group_by(subid) %>% 
  nest() %>% 
  left_join(
    select(
      location_descriptions,
      subid, type, n_home_locations, n_work_locations, 
      n_home_zones = n_home_zone, n_work_zones), 
    by = "subid") %>% 
  rename(gps_data = data)
```

#### Check for issues

```{r check issues}

#check for subids only in location_description
missing_ids <- unique(location_descriptions$subid)[!unique(location_descriptions$subid) %in% unique(gps$subid)]

#clean up
rm(gps)

```

There are `r length(missing_ids)` subjects that are in location descriptions and have locations, but are not in the processed gps dataset. Their subids are: `r paste(missing_ids)`.

TODO: Get more information about where their removal is documented. "studydata/risk/knits/gps/mak_gps_enriched.html" does not note their removal. Do not see another mak_gps html but the gps file was created in the last month. The notes file does not have any entry for 24 or 67. Clearly these people had data at some point, because they have locations.

### Examine participants

#### Set up variables

```{r}
location_check <- location_check %>% 
  mutate(action = case_when(type == 1 ~ "use as is",
                                type == 2 ~ "use with modification",
                                type == 0 ~ "remove all data")) 
```


#### Categorize particpants with unique labeled and observed home and work

```{r}
location_check <- location_check %>% 
  mutate(action = case_when(n_home_locations == 1 & 
                     n_work_locations == 1 &
                     n_home_zones == 1 &
                     n_work_zones == 1 ~ "use as is",
                     TRUE ~ action))
```

#### Check participants with multiple home locations

```{r}
multiple_homes_ids <- locations %>% 
  filter(type == "HOME") %>% 
  group_by(subid) %>% 
  count() %>% 
  filter(n > 1) %>% 
  pull(subid)

#function that takes subid and creates maps around each home
#this will iterate through multiple_homes_ids list

check_labeled_homes <- function(subid){
  
subject <- as.numeric(subid) #renaming to prevent issues  
  
gps <- location_check %>% 
  filter(subid == subject) %>% 
  pull(gps_data) %>% 
  pluck(1) %>% 
  mutate(location_source = case_when(location_source == "labeled_home" ~ "home",
                                     location_source == "gps_data" ~ "observed location"))

homes <- gps %>% 
  filter(location_source == "home") %>% 
  select(long, lat) 

plots <- map2(homes$long, homes$lat, 
     ~ggmap(
       get_map(
         c(.x, .y), zoom = 18)) +
       geom_point(aes(x = long, 
                      y = lat,
                      color = location_source),
                  data = gps) +
       ggtitle(paste0("subid ", subject, "'s home and surrounding gps observations"))) 

return(plots)

}
```

```{r map function for all people with multiple homes}

all_maps <- map(multiple_homes_ids, ~check_labeled_homes(.x))

all_maps
```
