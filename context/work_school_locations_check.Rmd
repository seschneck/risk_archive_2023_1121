---
title: "Review and resolution of each participants work/school locations"
author: "Hannah Moshontz"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "P:/studydata/risk/knits/context")
  })
---


### Notes

Purpose: This file reviews each person's GPS data to resolve issues related to multiple work and school locations.

Inputs:  user_locations_check.csv, which is a copy of a sheet in "workbook_sent_from_xinyi.xlsx" with cleaned variable names. Many of the columns we will not use (the binary description and decision columns Xinyi created), but many contain information about activity zones that we do not otherwise have.


### Setup

Packages and Source
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(janitor)
library(purrr)
library(here)
library(kableExtra)
library(tidylog)
library(ggmap)
register_google(key = "AIzaSyBBwIG1tC4QZi5QrTnhXXLktIPD8NlVVI0") #API key
```

### Import file

```{r import locations check}
location_descriptions <- read_csv("./context/user_locations_check.csv",
                            col_names = TRUE) %>% 
  clean_names("snake") %>% 
  glimpse()

```

```{r import locations}
locations <- read_csv("P:/studydata/risk/data_processed/gps/to_share/locations.csv",
                      col_names = TRUE) %>% 
  mutate(subid = as.numeric(subid)) %>% 
  clean_names("snake") %>% 
  mutate(time = lubridate::as_datetime(utc, tz = "America/Chicago")) %>% 
  mutate(type = tolower(type)) %>% 
  glimpse()

#fixing minor typos in type
locations$type[locations$type == "coffee shop/café"] <- "coffee shop/cafe"
locations$type[locations$type == "coffe shop/café"] <- "coffee shop/cafe"

#imputing missing lat/long 
locations_imputed <- locations %>%
  filter(is.na(lat)) %>% 
  mutate(address = str_c(street_address, city, state, sep = ", "), 
         imputed_location = geocode(address)) %>% 
           select(-address) 

locations_imputed$imputed_long <- locations_imputed$imputed_location$lon
locations_imputed$imputed_lat <- locations_imputed$imputed_location$lat

locations <- locations_imputed %>% 
  select(subid, imputed_long, imputed_lat) %>% 
  left_join(locations, ., by = "subid") %>% 
  mutate(lat = coalesce(lat, imputed_lat),
         long = coalesce(long, imputed_long)) 

rm(locations_imputed)
```

```{r import gps}
gps <- read_rds("P:/studydata/risk/data_processed/shared/gps.rds") %>% 
  rename(long = lon) %>% 
  glimpse()

```


### Merge

```{r create combined dataset}
location_check <- gps %>% 
  mutate(location_source = "gps_data") %>% 
  select(subid, lat, long, time, location_source) %>% 
  bind_rows(
    locations %>% 
      mutate(location_source = "labeled_home") %>% 
      filter(type == "home") %>% 
      select(subid, lat, long, time, location_source)) %>%
    bind_rows(
    locations %>% 
      mutate(location_source = "labeled_work") %>% 
      filter(type == "work" | type == "school") %>% 
      select(subid, lat, long, time, location_source)) %>%
  group_by(subid) %>% 
  nest() %>% 
  left_join(
    select(
      location_descriptions,
      subid, type, n_home_locations, n_work_locations, 
      n_home_zones = n_home_zone, n_work_zones), 
    by = "subid") %>% 
  rename(gps_data = data)
```

#### Check for issues

```{r check issues}

#check for subids only in location_description
missing_ids <- unique(location_descriptions$subid)[!unique(location_descriptions$subid) %in% unique(gps$subid)]

#clean up
rm(gps)

```

There are `r length(missing_ids)` subjects that are in location descriptions and have locations, but are not in the processed gps dataset. Their subids are: `r paste(missing_ids)`.

TODO: Get more information about where their removal is documented. "studydata/risk/knits/gps/mak_gps_enriched.html" does not note their removal. Do not see another mak_gps html but the gps file was created in the last month. The notes file does not have any entry for 24 or 67. Clearly these people had data at some point, because they have locations.


### Examine participants

#### Set up variables

```{r}

#starting new action variable from scratch so that we are consistent in our evaluations
location_check <- location_check %>% 
  mutate(action = as.factor(NA))

#location_check <- location_check %>% 
#  mutate(action = case_when(type == 1 ~ "use as is",
#                                type == 2 ~ "use with modification",
#                                type == 0 ~ "remove all data")) 
```


#### Categorize particpants with unique labeled and observed home and work

```{r}
location_check <- location_check %>% 
  mutate(action = case_when(n_home_locations == 1 & 
                     n_work_locations == 1 &
                     n_home_zones == 1 &
                     n_work_zones == 1 ~ "use as is",
                     TRUE ~ action))
```

#### Check participants with multiple home locations

```{r}
multiple_homes_ids <- locations %>% 
  filter(type == "home") %>% 
  group_by(subid) %>% 
  count() %>% 
  filter(n > 1) %>% 
  pull(subid)

#function that takes subid and creates maps around each home
#this will iterate through multiple_homes_ids list

check_labeled_places <- function(subid, place_type){
  
message(paste0("processing subject", subid))  
  
subject <- as.numeric(subid) #renaming to prevent issues  
  
gps <- location_check %>% 
  filter(subid == subject) %>% 
  pull(gps_data) %>% 
  pluck(1) %>% 
  mutate(location_source = case_when(location_source == paste0("labeled_", place_type) ~ place_type,
                                     location_source == "gps_data" ~ "observed location"))

places <- gps %>% 
  filter(location_source == place_type) %>% 
  select(long, lat) 

plots <- map2(places$long, places$lat, 
     ~ggmap(
       get_map(
         c(.x, .y), zoom = 18)) +
       geom_point(aes(x = long, 
                      y = lat,
                      color = location_source),
                  data = gps) +
       ggtitle(paste0("subid ", subject, "'s ", place_type," and surrounding gps observations"))) 

return(plots)

}
```

```{r map function for all people with multiple homes}

all_maps <- map(multiple_homes_ids, ~check_labeled_places(.x, "home"))

all_maps
```

### Closer look at ppl who have spent time at both homes

```{r}
investigate_homes <- function(subid){
  
  subject <- subid
  
  homes <-   location_check %>% 
    filter(subid == subject) %>% 
    pull(gps_data) %>% 
    pluck(1) %>% 
    filter(location_source == "labeled_home")
  
  home1 <- homes %>% 
    select(long, lat) %>% .[1,]
  
  home2 <- homes %>% 
    select(long, lat) %>% .[2,]
  
  
  homes_subid <- location_check %>% 
    filter(subid == subject) %>% 
    pull(gps_data) %>% 
    pluck(1) %>% 
    mutate(near_home1 = case_when(long > home1[[1]]-.001 & 
                                    long < home1[[1]]+.001 & 
                                    lat < home1[[2]]+.001 & 
                                    lat > home1[[2]]-.001 ~ "yes",
                                  TRUE ~ "no"),
           near_home2 = case_when(long > home2[[1]]-.001 & 
                                    long < home2[[1]]+.001 & 
                                    lat < home2[[2]]+.001 & 
                                    lat > home2[[2]]-.001 ~ "yes",
                                  TRUE ~ "no")) 

  
  map1 <- ggmap(
    get_map(
      c(home1[[1]], home1[[2]]), zoom = 18)) +
    geom_point(aes(x = long, 
                   y = lat,
                   shape = location_source,
                   color = time),
               data = homes_subid) +
    ggtitle(paste0("subject ", subject, "'s obs near home 1 over time"))
  
  
  map2 <- ggmap(
    get_map(
      c(home2[[1]], home2[[2]]), zoom = 18)) +
    geom_point(aes(x = long, 
                   y = lat,
                   shape = location_source,
                   color = time),
               data = homes_subid) +
    ggtitle(paste0("subject ", subject, "'s obs near home 2 over time"))
  

  #homes_subid %>% 
  #  filter(near_home1 == "yes" | near_home2 == "yes") %>% 
  #  arrange(time) 
  
  tables <- homes_subid %>% 
    mutate(month = lubridate::month(time)) %>% 
    group_by(month, near_home1, near_home2) %>% 
    count() %>% 
    filter(near_home1 == "yes" | near_home2 == "yes")
  
  results <- list(tables, map1, map2)
  
  
      if (nrow(homes) == 3) {
    
        message("three homes detected")
        
    home3 <- homes %>% 
      select(long, lat) %>% .[3,]
    
    homes_subid <-  homes_subid %>% 
      mutate(
        near_home3 = case_when(long > home3[[1]]-.001 & 
                                 long < home3[[1]]+.001 & 
                                 lat < home3[[2]]+.001 & 
                                 lat > home1[[2]]-.001 ~ "yes",
                               TRUE ~ "no"))
    
    map3 <- ggmap(
    get_map(
      c(home3[[1]], home3[[2]]), zoom = 18)) +
    geom_point(aes(x = long, 
                   y = lat,
                   shape = location_source,
                   color = time),
               data = homes_subid) +
    ggtitle(paste0("subject ", subject, "'s obs near home 3 over time"))
    
    tables <- homes_subid %>% 
    mutate(month = lubridate::month(time)) %>% 
    group_by(month, near_home1, 
             near_home2,
             near_home3) %>% 
    count() %>% 
    filter(near_home1 == "yes" | near_home2 == "yes" | near_home3 == "yes")
    
     results <- list(tables, map1, map2, map3)
  
      }

  if (length(homes_subid) > 3) message(paste0("subject", subject, " has more than 3 homes"))
  
  return(results)
  
}
```


```{r homes sub 6}
#set action  
location_check$action[location_check$subid == "6"] <- "use with modification"

```


```{r homes sub 27}
#set action  
location_check$action[location_check$subid == "27"] <- "use with modification"

```

```{r}
map(c(6, 27, 43, 77, 79, 86, 93, 119, 135, 156, 162, 172, 201, 222, 240, 259, 270), ~investigate_homes(.x))
```


#### Check participants with multiple work locations


```{r  map function for all people with multiple works}

multiple_works_ids <- locations %>% 
  filter(type == "work") %>% 
  group_by(subid) %>% 
  count() %>% 
  filter(n > 1) %>% 
  pull(subid)

all_work_maps <- map(multiple_works_ids, ~check_labeled_places(.x, "work"))

all_work_maps
```

##### Closer look at people with multiple works


```{r}
investigate_works <- function(subid){
  
  subject <- subid
  
  works <-   location_check %>% 
    filter(subid == subject) %>% 
    pull(gps_data) %>% 
    pluck(1) %>% 
    filter(location_source == "labeled_work")
  
  work1 <- works %>% 
    select(long, lat) %>% .[1,]
  
  work2 <- works %>% 
    select(long, lat) %>% .[2,]
  
  
  works_subid <- location_check %>% 
    filter(subid == subject) %>% 
    pull(gps_data) %>% 
    pluck(1) %>% 
    mutate(near_work1 = case_when(long > work1[[1]]-.001 & 
                                    long < work1[[1]]+.001 & 
                                    lat < work1[[2]]+.001 & 
                                    lat > work1[[2]]-.001 ~ "yes",
                                  TRUE ~ "no"),
           near_work2 = case_when(long > work2[[1]]-.001 & 
                                    long < work2[[1]]+.001 & 
                                    lat < work2[[2]]+.001 & 
                                    lat > work2[[2]]-.001 ~ "yes",
                                  TRUE ~ "no")) 

  
  map1 <- ggmap(
    get_map(
      c(work1[[1]], work1[[2]]), zoom = 18)) +
    geom_point(aes(x = long, 
                   y = lat,
                   shape = location_source,
                   color = time),
               data = works_subid) +
    ggtitle(paste0("subject ", subject, "'s obs near work 1 over time"))
  
  
  map2 <- ggmap(
    get_map(
      c(work2[[1]], work2[[2]]), zoom = 18)) +
    geom_point(aes(x = long, 
                   y = lat,
                   shape = location_source,
                   color = time),
               data = works_subid) +
    ggtitle(paste0("subject ", subject, "'s obs near work 2 over time"))
  

  #works_subid %>% 
  #  filter(near_work1 == "yes" | near_work2 == "yes") %>% 
  #  arrange(time) 
  
  tables <- works_subid %>% 
    mutate(month = lubridate::month(time)) %>% 
    group_by(month, near_work1, near_work2) %>% 
    count() %>% 
    filter(near_work1 == "yes" | near_work2 == "yes")
  
  results <- list(tables, map1, map2)
  
  
      if (nrow(works) == 3) {
    
        message("three works detected")
        
    work3 <- works %>% 
      select(long, lat) %>% .[3,]
    
    works_subid <-  works_subid %>% 
      mutate(
        near_work3 = case_when(long > work3[[1]]-.001 & 
                                 long < work3[[1]]+.001 & 
                                 lat < work3[[2]]+.001 & 
                                 lat > work1[[2]]-.001 ~ "yes",
                               TRUE ~ "no"))
    
    map3 <- ggmap(
    get_map(
      c(work3[[1]], work3[[2]]), zoom = 18)) +
    geom_point(aes(x = long, 
                   y = lat,
                   shape = location_source,
                   color = time),
               data = works_subid) +
    ggtitle(paste0("subject ", subject, "'s obs near work 3 over time"))
    
    tables <- works_subid %>% 
    mutate(month = lubridate::month(time)) %>% 
    group_by(month, near_work1, 
             near_work2,
             near_work3) %>% 
    count() %>% 
    filter(near_work1 == "yes" | near_work2 == "yes" | near_work3 == "yes")
    
     results <- list(tables, map1, map2, map3)
  
      }
  
  if (length(works_subid) > 3) message(paste0("subject", subject, " has more than 3 works"))

  return(results)
  
}
```


###### Notes 

1. Subid 3 -- home locations are identical, should be combined
2. Subid 6 -- although the proportion of time spent at each home changes, they spend time at both houses throughout the study, but throughout they spend more time at home 2 than home 1. either delete home 1 or restrict data to august and september
3. Subid 27 -- seems to have moved in december, but doesn't spend much time at home 2 (mostly just stopped spending time at home 1). remove the label for home 2 for analysis.
4. Subid 29 -- home locations are identical, should be combined
5. Subid 30 -- no observations near home location 2 (Main St)
6. Subid 43 -- has three homes, appears to have moved 3 times. it may make sense to restrict data to the time period when they were living at location 1 or location 3.
7. Subid 65 -- home 1 is a temporary home (pops up on google as a hotel), should be relabeled as such
8. Subid 77 -- much less time at home 2, and during a very narrow time-frame. this home is outside of madison. consider relabeling home 2 as a temporary home or hotel.
9. Subid 79 -- address looks a bit off on 79 home 1 -- also looks like a temporary residence, as they spent almost no time there. remove home 1. looks like a move between home 2 and 3 occured so we should restrict to times when they lived at one.
10. Subid 86 -- they moved between two homes that are very close. may make sense to pick house 2 as they seem to have moved early in the study.
11. Subid 93 -- data is pretty sparse. consider restricting to before August 10th or so, to focus on home 1, and then delete home 2. 
12. Subid 119 -- location 2 should be marked as a temporary home.
13. Subid 135 -- apartment address is a little off for 1. this looks like a move.... focus on home 1 or keep both.
14. Subid 156 -- less time at home 1, and all focused at the begining of the study. consider removing obs before nov 15th or so and removing home 1, or labeling home 1 as a temporary residence. 
15. Subid 162 -- much less time spent at time 1, which looks like it was a temporary home. 
16. Subid 172 -- a move. go with home 2 if we have to pick, and restrict to before feb 10th or so
17. Subid 201 -- almost no obs at home 1; mark as a temporary home or remove
18. Subid 222 -- a move... not sure what to do as they appear to be about equal.
19. Subid 240 -- a move, choice will have to be arbitrary if we restrict in time
20. Subid 259 -- much less time spent at home 1, consider marking as a temporary home 
21. Subid 270 --  home 2 looks like an error -- not a residence -- consider removing

Additional notes:
- Apartment addresses are often a little removed from their gps location -- it looks like the lat, long were generated from addresses rather than as an average of observed locations
- is it possible to keep two homes if people moved? if we can have multiple retaurants, etc. why not multiple homes? (see subject 86 as a good example of a case we should keep)