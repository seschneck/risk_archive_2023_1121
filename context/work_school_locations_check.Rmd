---
title: "Review and resolution of each participants work/school locations"
author: "Hannah Moshontz"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: 
  html_document:
    toc: true 
    toc_depth: 6
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "P:/studydata/risk/knits/context")
  })
---


### Notes

Purpose: This file reviews each person's GPS data to resolve issues related to multiple work and school locations.

Inputs:  

-  processed_data/context/user_locations_check.csv, which is a copy of a sheet in "workbook_sent_from_xinyi.xlsx" with cleaned variable names
- raw_data/gps.csv
- processed_data/context/locations.csv 

### Setup

Packages and Source
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(janitor)
library(purrr)
library(here)
library(kableExtra)
#library(tidylog)
library(ggmap)
library(vroom)
library(here)
library(lubridate)
register_google(key = "AIzaSyBBwIG1tC4QZi5QrTnhXXLktIPD8NlVVI0") #API key
```


Functions
```{r}
#function that takes subid and creates maps around each home
#this will iterate through multiple_homes_ids list

check_labeled_places <- function(subid, place_type){
  message(paste0("processing subject", subid))  
  
  subject <- as.numeric(subid) #renaming to prevent issues  
  
  gps <- location_check %>% 
    filter(subid == subject) %>% 
    pull(gps_data) %>% 
    pluck(1) %>% 
    mutate(location_source = case_when(location_source == paste0("labeled_", place_type) ~ place_type,
                                       location_source == "gps_data" ~ "observed location"))
  
  places <- gps %>% 
    filter(location_source == place_type) %>% 
    select(long, lat) 
  
  plots <- map2(places$long, places$lat, 
                ~ggmap(
                  get_map(
                    c(.x, .y), zoom = 18)) +
                  geom_point(aes(x = long, 
                                 y = lat,
                                 color = location_source),
                             data = gps) +
                  ggtitle(paste0("subid ", subject, "'s ", place_type," and surrounding gps observations"))) 
  
  return(plots)
  
}
```

```{r}

investigate_homes <- function(subid){
  
  subject <- subid
  
  homes <- location_check %>% 
    filter(subid == subject) %>% 
    pull(gps_data) %>% 
    pluck(1) %>% 
    filter(location_source == "labeled_home")
  
  
  if (nrow(homes) == 1) {
    
    message(paste0("one home detected for subject ", subid))
    
    
    home1 <- homes %>% 
      select(long, lat) %>% .[1,]
    
    
    homes_subid <- location_check %>% 
      filter(subid == subject) %>% 
      pull(gps_data) %>% 
      pluck(1) %>% 
      mutate(near_home1 = case_when(long > home1[[1]]-.001 & 
                                      long < home1[[1]]+.001 & 
                                      lat < home1[[2]]+.001 & 
                                      lat > home1[[2]]-.001 ~ "yes",
                                    TRUE ~ "no")) 
    
    map1 <- ggmap(
      get_map(
        c(home1[[1]], home1[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = homes_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near home 1 over time"))
    
    
    tables <- homes_subid %>% 
      mutate(near = case_when(near_home1 == "yes" ~ "home1")) %>% 
      group_by(near) %>% 
      summarize(first = min(time),
                last = max(time),
                count = n())
    
    results <- list(tables, map1)
    
    
    
  }
  
  
  if (nrow(homes) == 2) {
    
    message(paste0("two homes detected for subject ", subid))
    
    home1 <- homes %>% 
      select(long, lat) %>% .[1,]
    
    home2 <- homes %>% 
      select(long, lat) %>% .[2,]
    
    
    homes_subid <- location_check %>% 
      filter(subid == subject) %>% 
      pull(gps_data) %>% 
      pluck(1) %>% 
      mutate(near_home1 = case_when(long > home1[[1]]-.001 & 
                                      long < home1[[1]]+.001 & 
                                      lat < home1[[2]]+.001 & 
                                      lat > home1[[2]]-.001 ~ "yes",
                                    TRUE ~ "no"), 
             near_home2 = case_when(long > home2[[1]]-.001 & 
                                      long < home2[[1]]+.001 & 
                                      lat < home2[[2]]+.001 & 
                                      lat > home2[[2]]-.001 ~ "yes",
                                    TRUE ~ "no")) 
    
    
    map1 <- ggmap(
      get_map(
        c(home1[[1]], home1[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = homes_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near home 1 over time"))
    
    
    map2 <- ggmap(
      get_map(
        c(home2[[1]], home2[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = homes_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near home 2 over time"))
    
    
    #homes_subid %>% 
    #  filter(near_home1 == "yes" | near_home2 == "yes") %>% 
    #  arrange(time) 
    
    tables <- homes_subid %>% 
      mutate(near = case_when(near_home1 == "yes" ~ "home1",
                              near_home2 == "yes" ~ "home2")) %>% 
      group_by(near) %>% 
      summarize(first = min(time),
                last = max(time),
                count = n())
    
    results <- list(tables, map1, map2)
    
  }
  
  if (nrow(homes) == 3) {
    
    message(paste0("three homes detected for subject ", subid))
    
    home1 <- homes %>% 
      select(long, lat) %>% .[1,]
    
    home2 <- homes %>% 
      select(long, lat) %>% .[2,]
    
    home3 <- homes %>% 
      select(long, lat) %>% .[3,]
    
    homes_subid <-  location_check %>% 
      filter(subid == subject) %>% 
      pull(gps_data) %>% 
      pluck(1) %>% 
      mutate(near_home1 = case_when(long > home1[[1]]-.001 & 
                                      long < home1[[1]]+.001 & 
                                      lat < home1[[2]]+.001 & 
                                      lat > home1[[2]]-.001 ~ "yes",
                                    TRUE ~ "no"), 
             near_home2 = case_when(long > home2[[1]]-.001 & 
                                      long < home2[[1]]+.001 & 
                                      lat < home2[[2]]+.001 & 
                                      lat > home2[[2]]-.001 ~ "yes",
                                    TRUE ~ "no"),
             near_home3 = case_when(long > home3[[1]]-.001 & 
                                      long < home3[[1]]+.001 & 
                                      lat < home3[[2]]+.001 & 
                                      lat > home3[[2]]-.001 ~ "yes",
                                    TRUE ~ "no"))
    
    
    map1 <- ggmap(
      get_map(
        c(home1[[1]], home1[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = homes_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near home 1 over time"))
    
    
    map2 <- ggmap(
      get_map(
        c(home2[[1]], home2[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = homes_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near home 2 over time"))
    
    map3 <- ggmap(
      get_map(
        c(home3[[1]], home3[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = homes_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near home 3 over time"))
    
    tables <- homes_subid %>% 
      mutate(near = case_when(near_home1 == "yes" ~ "home1",
                              near_home2 == "yes" ~ "home2",
                              near_home3 == "yes" ~ "home3")) %>% 
      group_by(near) %>% 
      summarize(first = min(time),
                last = max(time),
                count = n())
    
    results <- list(tables, map1, map2, map3)
    
  }
  
  if (nrow(homes) > 3) message(paste0("subject", subject, " has more than 3 homes"))
  
  return(results)
  
}
```

```{r}

investigate_works <- function(subid){
  
  subject <- subid
  
  works <- location_check %>% 
    filter(subid == subject) %>% 
    pull(gps_data) %>% 
    pluck(1) %>% 
    filter(location_source == "labeled_work")
  
    if (nrow(works) == 1) {
    
    message(paste0("one work detected for subject ", subid))
    
    
    work1 <- works %>% 
      select(long, lat) %>% .[1,]
    
    
    works_subid <- location_check %>% 
      filter(subid == subject) %>% 
      pull(gps_data) %>% 
      pluck(1) %>% 
      mutate(near_work1 = case_when(long > work1[[1]]-.001 & 
                                      long < work1[[1]]+.001 & 
                                      lat < work1[[2]]+.001 & 
                                      lat > work1[[2]]-.001 ~ "yes",
                                    TRUE ~ "no")) 
    
    map1 <- ggmap(
      get_map(
        c(work1[[1]], work1[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = works_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near work 1 over time"))
    
    
    tables <- works_subid %>% 
      mutate(near = case_when(near_work1 == "yes" ~ "work1")) %>% 
      group_by(near) %>% 
      summarize(first = min(time),
                last = max(time),
                count = n())
    
    results <- list(tables, map1)
    
    
    
  }
  
  
  if (nrow(works) == 2) {
    
    message(paste0("two works detected for subject ", subid))
    
    work1 <- works %>% 
      select(long, lat) %>% .[1,]
    
    work2 <- works %>% 
      select(long, lat) %>% .[2,]
    
    
    works_subid <- location_check %>% 
      filter(subid == subject) %>% 
      pull(gps_data) %>% 
      pluck(1) %>% 
      mutate(near_work1 = case_when(long > work1[[1]]-.001 & 
                                      long < work1[[1]]+.001 & 
                                      lat < work1[[2]]+.001 & 
                                      lat > work1[[2]]-.001 ~ "yes",
                                    TRUE ~ "no"), 
             near_work2 = case_when(long > work2[[1]]-.001 & 
                                      long < work2[[1]]+.001 & 
                                      lat < work2[[2]]+.001 & 
                                      lat > work2[[2]]-.001 ~ "yes",
                                    TRUE ~ "no")) 
    
    
    map1 <- ggmap(
      get_map(
        c(work1[[1]], work1[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = works_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near work 1 over time"))
    
    
    map2 <- ggmap(
      get_map(
        c(work2[[1]], work2[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = works_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near work 2 over time"))
    
    
    #works_subid %>% 
    #  filter(near_work1 == "yes" | near_work2 == "yes") %>% 
    #  arrange(time) 
    
    tables <- works_subid %>% 
      mutate(near = case_when(near_work1 == "yes" ~ "work1",
                              near_work2 == "yes" ~ "work2")) %>% 
      group_by(near) %>% 
      summarize(first = min(time),
                last = max(time),
                count = n())
    
    results <- list(tables, map1, map2)
    
  }
  
  if (nrow(works) == 3) {
    
    message(paste0("three works detected for subject ", subid))
    
    work1 <- works %>% 
      select(long, lat) %>% .[1,]
    
    work2 <- works %>% 
      select(long, lat) %>% .[2,]
    
    work3 <- works %>% 
      select(long, lat) %>% .[3,]
    
    works_subid <-  location_check %>% 
      filter(subid == subject) %>% 
      pull(gps_data) %>% 
      pluck(1) %>% 
      mutate(near_work1 = case_when(long > work1[[1]]-.001 & 
                                      long < work1[[1]]+.001 & 
                                      lat < work1[[2]]+.001 & 
                                      lat > work1[[2]]-.001 ~ "yes",
                                    TRUE ~ "no"), 
             near_work2 = case_when(long > work2[[1]]-.001 & 
                                      long < work2[[1]]+.001 & 
                                      lat < work2[[2]]+.001 & 
                                      lat > work2[[2]]-.001 ~ "yes",
                                    TRUE ~ "no"),
             near_work3 = case_when(long > work3[[1]]-.001 & 
                                      long < work3[[1]]+.001 & 
                                      lat < work3[[2]]+.001 & 
                                      lat > work3[[2]]-.001 ~ "yes",
                                    TRUE ~ "no"))
    
    
    map1 <- ggmap(
      get_map(
        c(work1[[1]], work1[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = works_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near work 1 over time"))
    
    
    map2 <- ggmap(
      get_map(
        c(work2[[1]], work2[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = works_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near work 2 over time"))
    
    map3 <- ggmap(
      get_map(
        c(work3[[1]], work3[[2]]), zoom = 18)) +
      geom_point(aes(x = long, 
                     y = lat,
                     shape = location_source,
                     color = time),
                 data = works_subid) +
      ggtitle(paste0("subject ", subject, "'s obs near work 3 over time"))
    
    tables <- works_subid %>% 
      mutate(near = case_when(near_work1 == "yes" ~ "work1",
                              near_work2 == "yes" ~ "work2",
                              near_work3 == "yes" ~ "work3")) %>% 
      group_by(near) %>% 
      summarize(first = min(time),
                last = max(time),
                count = n())
    
    results <- list(tables, map1, map2, map3)
    
  }
  
  if (nrow(works) > 3) {
    
    message(paste0("subject ", subject, " has more than 3 works"))
    
    results <- list()
    
    
  } 
  
  return(results)
  
}
```


### Import file

```{r import locations check}
location_descriptions <- read_csv("./context/user_locations_check.csv",
                                  skip = 1, col_names = TRUE) %>% 
  clean_names("snake") %>% 
  rename(
    n_home_locations = location_home,
    n_work_locations = location_work,
    n_home_zones = activityzone_home,
    n_work_zones = activityzone_work
  ) %>% 
  glimpse()
```

```{r import locations}
locations <- vroom("P:/studydata/risk/data_processed/context/locations.csv",
                      col_names = TRUE) 
```

There are `r nrow(locations)` unique labeled locations for `r length(unique(locations$subid))` subjects. `r nrow(filter(locations, is.na(lat)))` observations are missing latitude and longitude.


```{r categorize other locations}

other_locations <- vroom("P:/studydata/risk/data_processed/context/other_locations.csv") %>% 
  #note that lat and long are truncated because these data came from an excel sheet originally
  mutate( #fix inconsistent label name
    final = str_replace_all(final, 
                            "public drinking spaces", "public drinking space")) %>% 
  glimpse()

#merge, create new type column that combines filled-in other column and original type column
locations <- locations %>% 
  left_join(.,
    select(other_locations, context_id, description, type_imputed = final),
    by = c("context_id")) %>%
  rename(type_original = type) %>% 
  mutate(type = coalesce(type_imputed, type_original), #fill in the new type label
         type = str_replace(type, "^other$", NA_character_)) #replace 'other' with NA

#saving a copy for Xinyi's reference and transparency
locations %>% 
  write_delim("P:/studydata/risk/data_processed/context/locations_other_imputed.csv")
```


After filling in new labels for places that people categorized as "other", based on the given descriptions, some places are now unlabeled. These are places that: 1) we either didn't have information about (e.g., because the participant declined to describe the location or staff did not ask or did not write down the description), or 2) that we had information about but that didn't fit into existing categories.

```{r}
other_locations %>% 
  filter(is.na(final)) %>% 
  select(context_id, description) %>% 
  filter(description != "NA") %>% 
  group_by(description) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  kable(caption = "Places that do not fit our label categories") %>% 
  kable_styling()
```


```{r import gps}
#import gps
gps <- vroom("P:/studydata/risk/data_processed/shared/gps.csv") 

#summarize data to be removed
gps %>% 
  filter(subid %in% c("80", "74", "207", "28")) %>% 
  mutate(status = case_when(subid == "80" & time > as_date("2018-07-31") |
         subid == "74" & time < as_date("2018-07-19") | 
         subid == "207" & time > as_date("2019-05-19") | 
         subid == "28" & time < as_date("2017-12-18") ~ "removed",
         TRUE ~ "retained")) %>% 
  group_by(subid, status) %>% 
  count() %>% 
  kable(caption = "Amount of removed and retained gps data for subjects 28, 74, 80, 204")

gps <- gps %>% 
  #removing spotty sections of data 
  filter(!(subid == "80" & time > as_date("2018-07-31")),
         !(subid == "74" & time < as_date("2018-07-19")), #note -- the remaining data is extremely sparse
         !(subid == "207" & time > as_date("2019-05-19")), 
         !(subid == "28" & time < as_date("2017-12-18"))) %>% 
  rename(long = lon) 

```


Adjusted gps data for the following reasons (copied from mak_gps_enriched.Rmd in gps):

- 80 has good data for about first month (through 7/31).  No data after that.  Retain lapses through 7/31
- 74 had problems with Moves.  Gaps in data using Moves.  Switched to FollowMee on 7/19 and seemed
to resolve issue.   Filter data (and lapses before 7/19) 
- 207 had issues with broken phone, missing days, and out of country travel. Despite this, data were ok (some gaps but not really big ones) through 5/19.   End study on 5/19 
- 28 missing data for most of the first month.   Data are present afterward.  Adjust study start to 12/18

Note 167 had missing data issues, but this was adjusted for the entire gps dataset


### Merge

```{r create combined dataset}
location_check <- gps %>% 
  mutate(location_source = "gps_data") %>% 
  select(subid, lat, long, time, location_source) %>% 
  bind_rows(
    locations %>% 
      mutate(location_source = case_when(
        type == "school" ~ "labeled_work",
        type == "work" ~ "labeled_work",
        type == "home" ~ "labeled_home",
        TRUE ~ "other")) %>% 
      select(subid, lat, long, time, location_source)) %>%
  group_by(subid) %>% 
  nest() %>% 
  left_join(
    select(
      location_descriptions,
      subid, n_home_locations, n_work_locations, 
      n_home_zones = n_home_zones, n_work_zones), 
    by = "subid") %>% 
  rename(gps_data = data)
```

#### Check for issues

```{r check issues}

#check for subids only in location_description
missing_ids <- unique(location_descriptions$subid)[!unique(location_descriptions$subid) %in% unique(gps$subid)]

```

There are `r length(missing_ids)` subjects that are in location descriptions and have locations, but are not in the processed gps dataset. Their subids are: `r paste(missing_ids)`.

According to "raw_notes.csv", these participants never completed through FU1 and are considered discontinued from the study. Their data are not useful to the context project because they will have many unlabeled places.


### Examine participants


#### Characterizing the issue

```{r}
location_check %>% 
  tabyl(n_home_locations, n_home_zones) %>% 
  kable(caption = "Table of the number of labeled homes by the number of associated zones") %>% 
  kable_styling()

location_check %>% 
  tabyl(n_work_locations, n_work_zones)  %>% 
  kable(caption = "Table of the number of labeled works by the number of associated zones") %>% 
  kable_styling()
```

##### Categorize particpants based on counts and missing data

```{r}
location_check <- location_check %>% 
  mutate(action = case_when(n_home_locations == 1 & 
                              n_work_locations == 1 &
                              n_home_zones == 1 &
                              n_work_zones == 1 ~ "manual check",
                            n_home_locations == 2 &
                              n_home_zones == 1 ~ "manual check",
                            n_work_locations == 2 &
                              n_work_zones == 2 ~ "manual check",
                            n_home_zones > 1 ~ "manual check",
                            n_work_zones > 1 ~ "manual check",
                            n_work_locations > 3 ~ "manual check - more than 3 work locations")) %>% 
  #adding in information about people with lots of missing data
  mutate(action = case_when(subid %in%
                                        c(190, 56, 2,
                                          51, 21, 84, 65, 
                                          117, 19, 42) ~ "check missing gps",
                            TRUE ~ action),
         action = case_when(subid %in%
                                       c(80, 74, 
                                         207, 28) ~ "check adjusted gps",
                            TRUE ~ action))


```

Participants flagged for review of missing data for the following reasons (see mak_gps_enriched.Rmd in gps):

- 190 had gps problems through-out study.  Missing GPS on most (85) days.  
- 56 is missing most of their data until the last few days of the study. 
- 2 had tech (samsung) issues and is missing most of their data until the last few days of the study.
- 51 tech (samsung) issues with big (month long) gaps in their data.  
- 21 had tech (samsung) issues.  Large gaps. 
- 84 had many phone issues (lost phone, missing data, out of country wiht GPS off). 
- 65 had tech (samsung) issues with many gaps in gps.  
- 117 turned off location services repeatedly b/c of data plan issues. Many gaps. 
- 19 had tech issues (samsung) with many gaps in gps.  
- 42 had many big gaps throughout their data.  


##### Check people with missing data
```{r}
sparse_gps_maps <- location_check %>% 
  filter(action == "check missing gps" | action == "check adjusted gps") %>% 
  pull(subid) %>% 
  map(~check_labeled_places(.x, "home"))

sparse_gps_maps 
```

###### Remove data & document

```{r}

#remove
gps <- gps %>% 
  filter(!(subid %in% c(2, #very few obs near home (41) and in general (167)
                        19, # not many obs near home (574, diffuse) and in general (2816)
                        42, # not many obs near home (367) and in general (1082) 
                        51, #very few obs near home (132) and in general (397)
                        56, # few obs near home (47) and in general (1137)
                        61, #few obs near homes (87, 194), and overall (1195)
                        65, #very few obs near home (101, 628) and in general (1255)
                        74, #very few obs near home (83), and overall (96)
                        190 #very few obs near home (10) an in general (42)
                        )))

#Not dropping 21 (1932 obs total), 28 (8616 total), 80 (8398 total), 84 (2215 obs total), 117 (2854 obs total)
# 207 (2409 obs total)-- data looks like it may work

#save 
gps %>% 
  write_delim("P:/studydata/risk/data_processed/context/gps_with_exclusions.csv")

gps_counts <- gps %>% 
  group_by(subid) %>% 
  count()

rm(gps)

#document
location_check <- location_check %>% 
  mutate(action = case_when(subid %in% c(2, 19, 24, 42, 51, 56, 61, 65, 67, 74, 190) ~ "data removed due to sparse gps",
                            subid %in% c(21, 28, 80, 84, 117, 207) ~ "manual check",
                            TRUE ~ action))

tabyl(location_check, action)

```


##### Check home locations


```{r, echo = FALSE, message = FALSE}

manual_check_subids <- location_check %>% 
  filter(action == "manual check") %>% 
  pull(subid)

home_maps <- map(manual_check_subids, ~investigate_homes(.x))
```

###### Results

```{r}
home_maps
```


#### Check participants with multiple work locations

First, examine simpler maps for people with more than 3 work locations

```{r}
work_maps_multiple <- location_check %>% 
  filter(action == "manual check - more than 3 work locations") %>% 
  pull(subid) %>% 
  map(~check_labeled_places(.x, "work"))
```


```{r  map function for all people with multiple works, echo = FALSE}

manual_check_subids <- location_check %>% 
  filter(n_work_locations != 0, #drop people without any work locations
         action == "manual check") %>% 
  pull(subid)

work_maps <- map(manual_check_subids, ~investigate_works(.x))
```


###### Results

```{r}
work_maps_multiple
work_maps
```

##### Updating action for people with multiple works and homes

```{r}


#document
location_check <- location_check %>% 
  mutate(
    check_zones = case_when(
      subid %in% c(7, 10, 11, 26, 27, 29, 37, 43,
                   52, 64, 80, 82, 88, 90, 
                   118, 181, 182, 183, 189, 196, 201, 
                   203, 207, 211, 213,
                   224, 240, 243, 248, 262) ~  "check for overlapping activity/home/work zones"),
    action = case_when(
    subid %in% c(3, 7, 8,
                 10, 11, 17, 18,
                 20, 21, 23, 25, 26, 28, 
                 31, 34, 38, 39,
                 40, 41, 47, 48, 
                 50, 52, 53, 54, 58, 59,  
                 62, 64, 76,
                 80, 81, 82, 84, 85, 87, 88,
                 90, 92, 94, 97, 98, 99,
                 100, 103, 104, 105, 109,
                 110, 116, 117, 118, 
                 128,
                 130, 131, 134, 136, 137, 138, 139, 
                 143, 149,
                 151, 158, 
                 161, 163, 166, 167, 169,
                 171, 173, 175, 178, 177, 179, 
                 180, 181, 182, 183, 185, 187, 188, 189, 
                 196, 
                 200, 203, 204, 205, 207, 208, 209,
                 211, 212, 213, 214, 215, 218,
                 221, 223, 225,
                 230, 231, 232, 234, 236, 237, 238, 
                 241, 242, 243, 245, 248,
                 262, 265, 268, 269) ~ "standard selected",
    subid %in% c(15, 27, 29, 30, 37, 43,63, 66, 77, 79,
                 93, 119, 121, 135, 156, 162, 172, 201, 224, 240, 264) ~ "nonstandard selected",
    subid %in% c(1, 32, 5, 6, 9, 16, 33, 44, 78,  86,150,  191, 192, 193, 
                 197,222, 252, 255, 259, 263, 267, 270) ~ "home or work locations not separated in time",
    TRUE ~ action))

tabyl(location_check, action)
```


##### Documenting sparse obs


```{r}
gps_counts %>% 
  arrange(n) %>% 
  filter(n < 3000) %>% 
  kable(caption = "Subjects with sparse GPS data") %>% 
  kable_styling()
```


### Saving

```{r}
#saving a copy of location for Xinyi's reference and transparency
drop_subids <- location_check %>% 
  filter(action == "home or work locations not separated in time" |
           action == "data removed due to sparse gps") %>% 
  pull(subid)

locations %>% 
  filter(subid %in% drop_subids) %>% 
  write_delim("P:/studydata/risk/data_processed/context/locations_other_imputed.csv")
```

```{r}

```



### Notes 

- Apartment addresses are often a little removed from their gps location 
- People who are affiliated with the university, and have multiple locations marked on campus. These people are currently labeled as needing overlapping zones checked.

