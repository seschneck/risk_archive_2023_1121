---
title: "ISRII Acceptability Figures for EMA"
author: "Kendra Wyant"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4
---

Packages and Paths
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(vroom)
library(conflicted)
library(here)
library(lubridate)

conflict_prefer("cols", "vroom")
conflict_prefer("filter", "dplyr")

path_acceptability <- "P:/studydata/risk/data_processed/burden"
path_shared <- "P:/studydata/risk/data_processed/shared"
```


### Read in data
```{r}
data <- vroom(here(path_acceptability, "acceptability.csv"), col_types = cols()) %>% 
  select(subid, date, contains("daily_survey")) %>% 
  glimpse()
```


Pull out last observation/survey for each participant
```{r}
data_last <- data %>% 
  group_by(subid) %>% 
  arrange(desc(date)) %>% 
  slice(1) %>% 
  ungroup() %>% 
  glimpse()
```

Remove subids with EMA reporting issues (see conclusions in mak_study_dates for exclusion reasons)
```{r}
data_last <- data_last %>% 
  filter(!subid %in% c(104, 269, 204)) %>% 
  glimpse()
```



### Interference Figure

```{r fig.height = 6}
plot_ema_interfere <- data_last %>% 
  select(subid, daily_survey_interfere) %>% 
  rename(Interference = daily_survey_interfere) %>% 
  pivot_longer(Interference, names_to = "measure") %>% 
  mutate(value = factor(value, levels = c(-2:2),
                        labels = c("Strongly agree", "Agree", "Undecided", "Disagree", "Strongly disagree"))) %>% 
  ggplot(aes(x = value, y = ..prop.., group = measure)) +
  geom_bar(color = "black", fill = "light grey") +
  facet_wrap(~measure) +
  theme_classic() +
  ylim(0, .7) +
  labs(y = "Proportion",
       x = NULL) +
    theme(legend.position = "none",
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_vline(aes(xintercept = mean(as.numeric(value))), linetype = "solid", size = .705, color = "#b44343") +
  geom_vline(aes(xintercept = "Undecided"), linetype = "dashed", size = .4, color = "#787575")

plot_ema_interfere
```


Uncomment to save figure  
```{r}
# ggsave(plot = plot_ema_interfere, file.choose(), width = 7.5, height = 6, units = "in", device = "png",  dpi = 500)
```



### Dislike Figure


```{r fig.height = 6}
plot_ema_dislike <- data_last %>% 
  select(subid, daily_survey_dislike) %>% 
  rename(Dislike = daily_survey_dislike) %>% 
  pivot_longer(Dislike, names_to = "measure") %>% 
  mutate(value = factor(value, levels = c(-2:2),
                        labels = c("Strongly agree", "Agree", "Undecided", "Disagree", "Strongly disagree"))) %>% 
  ggplot(aes(x = value, y = ..prop.., group = measure)) +
  geom_bar(color = "black", fill = "light grey") +
  facet_wrap(~measure) +
  theme_classic() +
  ylim(0, .7) +
  labs(y = "Proportion",
       x = NULL) +
    theme(legend.position = "none",
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_vline(aes(xintercept = mean(as.numeric(value))), linetype = "solid", size = .705, color = "#b44343") +
  geom_vline(aes(xintercept = "Undecided"), linetype = "dashed", size = .4, color = "#787575")

plot_ema_dislike
```


Uncomment to save figure  
```{r}
# ggsave(plot = plot_ema_dislike, file.choose(), width = 7.5, height = 6, units = "in", device = "png",  dpi = 500)
```


### Willingness to Continue for 1 Year Figures

#### 1X Daily

```{r fig.height = 6}
plot_ema_1x <- data_last %>% 
  select(subid, daily_survey_1_1year) %>% 
  rename(`Willingness to Continue for 1 Year (1X EMA)` = daily_survey_1_1year) %>% 
  pivot_longer(`Willingness to Continue for 1 Year (1X EMA)`, names_to = "measure") %>% 
  mutate(value = factor(value, levels = c(-2:2),
                        labels = c("Strongly disagree", "Disagree", "Undecided", "Agree", "Strongly agree"))) %>% 
  ggplot(aes(x = value, y = ..prop.., group = measure)) +
  geom_bar(color = "black", fill = "light grey") +
  facet_wrap(~measure) +
  theme_classic() +
  ylim(0, .7) +
  labs(y = "Proportion",
       x = NULL) +
    theme(legend.position = "none",
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_vline(aes(xintercept = mean(as.numeric(value))), linetype = "solid", size = .705, color = "#b44343") +
  geom_vline(aes(xintercept = "Undecided"), linetype = "dashed", size = .4, color = "#787575")

plot_ema_1x
```


Uncomment to save figure  
```{r}
# ggsave(plot = plot_ema_1x, file.choose(), width = 7.5, height = 6, units = "in", device = "png",  dpi = 500)
```


#### 4X Daily

```{r fig.height = 6}
plot_ema_4x <- data_last %>% 
  select(subid, daily_survey_4_1year) %>% 
  rename(`Willingness to Continue for 1 Year (4X EMA)` = daily_survey_4_1year) %>% 
  pivot_longer(`Willingness to Continue for 1 Year (4X EMA)`, names_to = "measure") %>% 
  mutate(value = factor(value, levels = c(-2:2),
                        labels = c("Strongly disagree", "Disagree", "Undecided", "Agree", "Strongly agree"))) %>% 
  ggplot(aes(x = value, y = ..prop.., group = measure)) +
  geom_bar(color = "black", fill = "light grey") +
  facet_wrap(~measure) +
  theme_classic() +
  ylim(0, .7) +
  labs(y = "Proportion",
       x = NULL) +
    theme(legend.position = "none",
        text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_vline(aes(xintercept = mean(as.numeric(value))), linetype = "solid", size = .705, color = "#b44343") +
  geom_vline(aes(xintercept = "Undecided"), linetype = "dashed", size = .4, color = "#787575")

plot_ema_4x
```


Uncomment to save figure  
```{r}
# ggsave(plot = plot_ema_4x, file.choose(), width = 7.5, height = 6, units = "in", device = "png",  dpi = 500)
```


### Compliance Figure

Overall compliance with at least 1 EMA per day by week on study     



#### Read in data

```{r}
ema_m <- vroom(here(path_shared, "ema_morning.csv"), col_types = cols()) %>% 
  glimpse()
ema_l <- vroom(here(path_shared, "ema_later.csv"), col_types = cols()) %>% 
  glimpse()
```

Join morning and evening EMA datasets to get subids and survey start dates
```{r}
ema <- ema_m %>% 
  select(subid, start_date) %>% 
  full_join(ema_l %>% select(subid, start_date), by = c("subid", "start_date")) %>% 
  mutate(subid = as.numeric(subid),
         start_date = date(start_date)) %>% 
  glimpse()
```

Restrict subids to EMA sample
```{r}
ema <- ema %>% 
  filter(subid %in% data_last$subid) %>% 
  glimpse()
```

Check there are 151 subids
```{r}
length(unique(ema$subid))
```


#### Calculate study dates

Read in visit dates
```{r}
visit_dates <- vroom(here(path_shared, "visit_dates.csv"), col_types = cols()) %>%  
  glimpse()
```


Get all study days for each subid
```{r}
# function to map over
get_study_days <- function(the_subid, dates) {
  start_study <- dates %>% filter(subid == the_subid) %>% pull(start_study)
  end_study <- dates %>% filter(subid == the_subid) %>% pull(end_study)
  study_days <- tibble(subid = the_subid, study_day = seq(start_study, end_study - days(1), by = "day")) 
  return(study_days)
}

subids <- unique(ema$subid)

study_dates <- subids %>% 
  map_dfr(~get_study_days(.x, visit_dates)) %>% 
  glimpse()
```


#### Calculate compliance with 1 EMA per day

Count EMAs per study day
```{r}
# count EMAs per day
ema_1_count <- ema %>%  
  count(subid, start_date) %>%
  mutate(n = if_else(n > 1, 1, as.numeric(n)))

# left join with study dates
ema_1_study_dates <- study_dates %>% 
  left_join(ema_1_count, by = c("subid", "study_day" = "start_date")) %>% 
  mutate(n = if_else(is.na(n), 0, n)) %>% 
  mutate(n_prompts = 1) %>% 
  glimpse()
```


calculate mean compliance
```{r}
mean_ema_1 <- ema_1_study_dates %>% 
  summarize(n_total = sum(n), prompt_total = sum(n_prompts)) %>% 
  mutate(mean = n_total/prompt_total)
```

mean compliance for one daily survey is `r mean_ema_1$mean`



Compliance over time    

Slice into 7 day bins 
```{r}
ema_1_study_weeks <- ema_1_study_dates %>% 
  group_by(subid) %>% 
  slice(1:7) %>% 
  mutate(week = 1) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(8:14) %>% 
    mutate(week = 2)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(15:21) %>% 
    mutate(week = 3)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(22:28) %>% 
    mutate(week = 4)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(29:35) %>% 
    mutate(week = 5)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(36:42) %>% 
    mutate(week = 6)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(43:49) %>% 
    mutate(week = 7)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(50:56) %>% 
    mutate(week = 8)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(57:63) %>% 
    mutate(week = 9)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(64:70) %>% 
    mutate(week = 10)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(71:77) %>% 
    mutate(week = 11)) %>% 
  bind_rows(ema_1_study_dates %>% 
    group_by(subid) %>% 
    slice(78:84) %>% 
    mutate(week = 12)) %>% 
  ungroup()
```

Get individual compliance scores 
```{r}
ema_1_week_compliance <- ema_1_study_weeks %>%
  mutate(n = if_else(n > 1, 1, n),
         n_prompts = 1) %>% 
  group_by(subid, week) %>% 
  summarize(sum_n = sum(n), sum_prompts = sum(n_prompts), .groups = "rowwise") %>% 
  mutate(compliance = sum_n/sum_prompts) %>% 
  ungroup() %>% 
  glimpse()
```

Summarize total compliance
```{r}
ema_1_week_compliance %>% 
  group_by(week) %>% 
  summarize(mean_compliance = mean(compliance)) 
```


#### Calculate compliance for 4x daily EMA

Overall proportion of EMAs completed while on study    

Count EMAs per study day
```{r}
# count EMAs per day
ema_4_count <- ema %>%  
  count(subid, start_date) %>%
  mutate(n = if_else(n > 4, 4, as.numeric(n)))

# left join with study dates
ema_4_study_dates <- study_dates %>% 
  left_join(ema_4_count, by = c("subid", "study_day" = "start_date")) %>% 
  mutate(n = if_else(is.na(n), 0, n)) %>% 
  mutate(n_prompts = 4) %>% 
  glimpse()
```

calculate mean compliance
```{r}
mean_ema_4 <- ema_4_study_dates %>% 
  summarize(n_total = sum(n), prompt_total = sum(n_prompts)) %>% 
  mutate(mean = n_total/prompt_total)
```

compliance = `r mean_ema_4$mean`   

avg emas completed daily = `r mean(ema_4_study_dates$n)`



Compliance over time    

Slice into 7 day bins 
```{r}
ema_4_study_weeks <- ema_4_study_dates %>% 
  group_by(subid) %>% 
  slice(1:7) %>% 
  mutate(week = 1) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(8:14) %>% 
    mutate(week = 2)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(15:21) %>% 
    mutate(week = 3)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(22:28) %>% 
    mutate(week = 4)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(29:35) %>% 
    mutate(week = 5)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(36:42) %>% 
    mutate(week = 6)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(43:49) %>% 
    mutate(week = 7)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(50:56) %>% 
    mutate(week = 8)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(57:63) %>% 
    mutate(week = 9)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(64:70) %>% 
    mutate(week = 10)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(71:77) %>% 
    mutate(week = 11)) %>% 
  bind_rows(ema_4_study_dates %>% 
    group_by(subid) %>% 
    slice(78:84) %>% 
    mutate(week = 12)) %>% 
  ungroup()
```


Get individual compliance scores - N EMAs/possible EMAs
```{r}
ema_4_week_compliance <- ema_4_study_weeks %>% 
  group_by(subid, week) %>% 
  summarize(sum_n = sum(n), sum_prompts = sum(n_prompts), .groups = "rowwise") %>% 
  mutate(compliance = sum_n/sum_prompts) %>% 
  ungroup() %>% 
  glimpse()
```

Summarize total compliance
```{r}
ema_4_week_compliance %>% 
  group_by(week) %>% 
  summarize(mean_compliance = mean(compliance))
```



#### Plot compliance


```{r ema_1_week_compliance}
week_compliance_all <- ema_4_week_compliance %>% 
              group_by(week) %>% 
              summarize(mean_compliance = mean(compliance),
                        n = n(),
                        sd = sd(compliance)) %>% 
              mutate(se = sd/sqrt(n),
                     signal = "EMA (4x Daily)") %>% 
  bind_rows(ema_1_week_compliance %>% 
              group_by(week) %>% 
              summarize(mean_compliance = mean(compliance),
                        n = n(),
                        sd = sd(compliance)) %>% 
              mutate(se = sd/sqrt(n),
                     signal = "EMA (1x Daily)")) 
  
plot_weekly_compliance <- week_compliance_all %>%   
  mutate(signal = factor(signal, levels = c("EMA (1x Daily)", "EMA (4x Daily)"))) %>% 
  group_by(week, signal) %>% 
  ggplot(aes(x = week, y = mean_compliance, group = signal, shape = signal)) +
  geom_point(size = 2) +
  geom_line() +
  geom_errorbar(aes(ymin = mean_compliance - se, ymax = mean_compliance + se), 
                width = .3, size = .3) +
  theme_classic() +
  scale_shape_manual(values = c(19, 1, 17)) +
  scale_x_continuous(name = "Week", 
                     breaks = seq(1, 12, 1)) +
  scale_y_continuous(name = "Compliance", 
                     breaks = seq(0, 1, .1), 
                     limits = c(0, 1)) +
  geom_hline(aes(yintercept = mean_compliance), week_compliance_all %>% 
               group_by(signal) %>% 
               summarize(mean_compliance = mean(mean_compliance)),
             linetype = "dashed", size = .3) +
  theme(legend.title = element_blank(),
        text = element_text(size = 14),
        legend.position = "bottom")

plot_weekly_compliance
```


Uncomment to save figure  
```{r}
# ggsave(plot = plot_weekly_compliance, file.choose(), width = 7.5, height = 6, units = "in", device = "png",  dpi = 500)
```
