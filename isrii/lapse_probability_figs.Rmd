---
title: "Lapse Probabilities"
author: "Kendra Wyant"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
---

### Notes
This script plots lapse probabilities by day and hour to determine direction of 
feature importance.


### Set Up Environment

Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) # detect and warn about function conflicts
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
conflict_prefer("slice", "dplyr")
conflict_prefer("spec", "yardstick")
conflict_prefer("col_factor", "vroom")
conflict_prefer("vi", "vip")

library(here)
```


Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidymodels)
library(themis)
library(vroom)
library(janitor)
library(ggplot2)
library(kableExtra)
library(vip)
library(future)

theme_set(theme_classic()) 
```

Absolute paths
```{r, absolute paths}
path_input <- str_c("P:/studydata/risk/chtc/ema")
path_processed <- str_c("P:/studydata/risk/data_processed/ema")
path_models <- str_c("P:/studydata/risk/models/ema")
```


Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```


Source training controls 
```{r}
source(here("../lab_support/chtc/static_files/fun_chtc.R"))
source(here("../lab_support/print_kbl.R"))
```



### Predictions for ema 1day v4  

Confirm best model is xgboost

```{r open_metrics}
metrics_avg <- 
  vroom(here(path_processed, str_c("metrics_avg_train_1day_0_v4.csv")), 
        col_types = "iccdddcddddddd",
        show_col_types = FALSE)
```

Looks like only xgboost in metrics file
```{r best_model_info}
metrics_avg %>% 
  group_by(algorithm, feature_set, resample) %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1) %>% 
  ungroup %>% 
  arrange(desc(roc_auc)) 

algorithm_best <- metrics_avg %>% 
  group_by(algorithm, feature_set, resample) %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1) %>% 
  ungroup %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1) %>% 
  pull(algorithm) %>%
  print
```


Read in data and predictions for best model
```{r resample_best_config}
# set paths
path_best <- here("P:/studydata/risk/chtc/ema/train_all_1day_0_v4_xgboost/input")
source(here(path_best, "training_controls.R"))

# read in data
chunks <- str_split_fixed(data_trn, "\\.", n = Inf) # parse name from extensions
if (length(chunks) == 2) {
  fn <- str_c("data_trn.", chunks[[2]])
} else {
  fn <- str_c("data_trn.", chunks[[2]], ".", chunks[[3]])
}

if (str_detect(fn, "csv")) {
  d <- vroom(here(path_best, fn), show_col_types = FALSE) 
} else {
  d <- readRDS(here(path_best, fn))
}

d <- d %>% 
  rename(y = {{y_col_name}})
  

# read in preds
preds_best <- readRDS(here(path_models, "resample_preds_best_all_1day_0_v4.rds"))
```

Preds dont have label - can I join with dataframe by row number?
```{r}
glimpse(preds_best)

d %>% 
  select(label_num, subid, dttm_label, y, label_day, label_hour) %>% 
  glimpse()
```

Match label_num to preds row_num
```{r}
preds_merged <- d %>% 
  select(label_num, subid, dttm_label, y, label_day, label_hour) %>% 
  full_join(preds_best %>% 
              rownames_to_column(var = "label_num") %>% 
              mutate(label_num = as.numeric(label_num)), by = "label_num") %>% 
  glimpse()
```

Check truth matches y   
doesn't match =(
```{r}
preds_merged %>% 
  janitor::tabyl(y, truth)
```





Plot predicted probabilities by day









