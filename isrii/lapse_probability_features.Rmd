---
title: "Lapse Probabilities for Important Features"
author: "Kendra Wyant"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
---

### Notes
This script plots lapse probabilities by day and hour to determine direction of 
feature importance.


### Set Up Environment

Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) # detect and warn about function conflicts
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
conflict_prefer("slice", "dplyr")
conflict_prefer("spec", "yardstick")
conflict_prefer("col_factor", "vroom")
conflict_prefer("vi", "vip")

library(here)
```


Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidymodels)
library(themis)
library(vroom)
library(janitor)
library(ggplot2)
library(kableExtra)
library(vip)
library(future)

theme_set(theme_classic()) 
```

Absolute paths
```{r, absolute paths}
path_input <- str_c("P:/studydata/risk/chtc/ema")
path_processed <- str_c("P:/studydata/risk/data_processed/ema")
path_models <- str_c("P:/studydata/risk/models/ema")
```


Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```



### Predictions for ema 1day v4  

Confirm best model is xgboost

```{r open_metrics_1day}
metrics_avg <- 
  vroom(here(path_processed, str_c("metrics_avg_train_1day_0_v4.csv")), 
        col_types = "iccdddcddddddd",
        show_col_types = FALSE)
```

Looks like only xgboost in metrics file
```{r best_model_info_1day}
metrics_avg %>% 
  group_by(algorithm, feature_set, resample) %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1) %>% 
  ungroup %>% 
  arrange(desc(roc_auc)) 

config_best <- metrics_avg %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1)

algorithm_best <- metrics_avg %>% 
  group_by(algorithm, feature_set, resample) %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1) %>% 
  ungroup %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1) %>% 
  pull(algorithm) %>%
  print
```


Read in data and predictions for best model
```{r resample_best_config_1day}
# set paths
path_best <- here("P:/studydata/risk/chtc/ema/train_all_1day_0_v4_xgboost/input")
source(here(path_best, "training_controls.R"))

# read in data
chunks <- str_split_fixed(data_trn, "\\.", n = Inf) # parse name from extensions
if (length(chunks) == 2) {
  fn <- str_c("data_trn.", chunks[[2]])
} else {
  fn <- str_c("data_trn.", chunks[[2]], ".", chunks[[3]])
}

if (str_detect(fn, "csv")) {
  d <- vroom(here(path_best, fn), show_col_types = FALSE) 
} else {
  d <- readRDS(here(path_best, fn))
}

d <- d %>% 
  rename(y = {{y_col_name}})
  

# read in preds
preds_best <- readRDS(here(path_models, "resample_preds_best_all_1day_0_v4.rds"))
```

Preds dont have label - can I join with dataframe by row number?
```{r}
glimpse(preds_best)

d %>% 
  select(label_num, subid, dttm_label, y, label_day, label_hour) %>% 
  glimpse()
```

Match label_num to preds row_num
```{r}
preds_merged <- d %>% 
  select(label_num, subid, dttm_label, y, label_day, label_hour) %>% 
  full_join(preds_best %>% 
              rownames_to_column(var = "label_num") %>% 
              mutate(label_num = as.numeric(label_num)), by = "label_num") %>% 
  glimpse()
```

Check truth matches y   
doesn't match =(
```{r}
preds_merged %>% 
  janitor::tabyl(y, truth)
```


Read in new preds with label numbers
```{r}
preds_best_new <- readRDS(here(path_models, "resample_preds_best_all_1day_0_v4_with_label_num.rds"))
```

Check preds_best and preds_best_new match
```{r}
identical(preds_best_new %>% select(-label_num), preds_best)
```

merge new preds with data
```{r}
preds_merged <- d %>% 
  select(label_num, subid, dttm_label, y, label_day, label_hour) %>% 
  full_join(preds_best_new, by = "label_num") %>% 
  glimpse()
```

Check y = truth
```{r}
preds_merged %>% 
  janitor::tabyl(y, truth)
```

Plot predicted probabilities by day
```{r}
preds_merged %>% 
  group_by(label_day) %>% 
  summarize(lapse_prob = mean(prob))
```

Double check reference day   
step_dummy used on label_day in recipe  
reference = Friday (first listed day is by default reference)   
```{r}
rec <- build_recipe(d = d, job = config_best)

feat_all <-  rec %>% 
  prep(training = d, strings_as_factors = FALSE) %>% 
  bake(new_data = NULL)

feat_all %>% 
  select(starts_with("label_day")) %>% 
  glimpse()
```



### Predictions for ema 1hour v4  

Confirm best model is xgboost

```{r open_metrics_1hr}
metrics_avg <- 
  vroom(here(path_processed, str_c("metrics_avg_train_1hour_0_v4.csv")), 
        col_types = "iccdddcddddddd",
        show_col_types = FALSE)
```

Looks like only xgboost in metrics file
```{r best_model_info_1hr}
metrics_avg %>% 
  group_by(algorithm, feature_set, resample) %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1) %>% 
  ungroup %>% 
  arrange(desc(roc_auc)) 

config_best <- metrics_avg %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1)

algorithm_best <- metrics_avg %>% 
  group_by(algorithm, feature_set, resample) %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1) %>% 
  ungroup %>% 
  arrange(desc(roc_auc)) %>% 
  slice(1) %>% 
  pull(algorithm) %>%
  print
```


Read in data and predictions for best model
```{r resample_best_config_1hr}
# set paths
path_best <- here("P:/studydata/risk/chtc/ema/train_all_1hour_0_v4_xgboost/input")
source(here(path_best, "training_controls.R"))

# read in data
chunks <- str_split_fixed(data_trn, "\\.", n = Inf) # parse name from extensions
if (length(chunks) == 2) {
  fn <- str_c("data_trn.", chunks[[2]])
} else {
  fn <- str_c("data_trn.", chunks[[2]], ".", chunks[[3]])
}

if (str_detect(fn, "csv")) {
  d <- vroom(here(path_best, fn), show_col_types = FALSE) 
} else {
  d <- readRDS(here(path_best, fn))
}

d <- d %>% 
  rename(y = {{y_col_name}})
  

# read in preds
preds_best <- readRDS(here(path_models, "resample_preds_best_all_1hour_0_v4.rds"))
```

Read in new preds with label numbers
```{r}
preds_best_new <- readRDS(here(path_models, "resample_preds_best_all_1hour_0_v4_with_label_num.rds"))
```

Check preds_best and preds_best_new match
```{r}
identical(preds_best_new %>% select(-label_num), preds_best)
```

merge new preds with data
```{r}
preds_merged <- d %>% 
  select(label_num, subid, dttm_label, y, label_day, label_hour) %>% 
  full_join(preds_best_new, by = "label_num") %>% 
  glimpse()
```

Check y = truth
```{r}
preds_merged %>% 
  janitor::tabyl(y, truth)
```

Predicted probabilities by hour   
Hour can be evening (5-11 pm) or other
```{r}
preds_merged %>% 
  group_by(label_hour) %>% 
  summarize(lapse_prob = mean(prob))
```















