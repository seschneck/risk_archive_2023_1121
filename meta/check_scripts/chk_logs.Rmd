---
title: "Check Meta"
author: "Kendra Wyant"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
    code_folding: show
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/knits/meta", 
      "/Volumes/private/studydata/risk/knits/meta")
    )
  })
---

### Set up Environment

Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```

Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) 
 conflict_prefer("filter", "dplyr")
 conflict_prefer("select", "dplyr")

library(here)  
```

Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
library(tidyverse)  
library(janitor) 
library(lubridate)
library(ggplot2)
library(kableExtra)

theme_set(theme_classic()) 
```

Absolute paths
```{r, paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_meta <- "P:/studydata/risk/data_processed/meta"
          path_shared <- "P:/studydata/risk/data_processed/shared"},

        # IOS paths
        Darwin = {
          path_meta <- "/Volumes/private/studydata/risk/data_processed/meta"
          path_shared <- "/Volumes/private/studydata/risk/data_processed/shared"}
        )
```

Relative paths
```{r}
path_lab_support <- "../lab_support"
```


Source for script
```{r, source_script, message=FALSE, warning=FALSE}
source(here(path_lab_support, "print_kbl.R"))
```


### Code Status

Discuss with JC 2 possible subid exclusions and how to handle log entries prior to start date.        


### Conclusions


Subid 1  

- Communications don't start till on day 50 of the study and  has gaps in data that we do have.    
- Has a total of 92 log entries (only 2 are SMS logs)    
- Has no lapses on study.   
- Found participant only has 2 voice/SMS logs in raw data folder    


Subid 74 

- communications don't start until day 33 on study   
- Has a total of 708 log entries (mix of voice and text)     
- Has no lapses on study    
- According to notes we were unable to retrieve text/call logs at followup 1 since 
their phone was broken. (only 2 SMS/Voice logs in raw data folder)   


Aside from these two all subids have at least one communication on their first day on study - 
all but 12 have communications starting at least 7 days prior to start date.    


### Notes

This script checks whether communication logs exist for participants 7 days prior to their 
start study date.



### Read in Data

cleaned meta logs
```{r}
logs_all <- vroom::vroom(here(path_meta, "meta_logs.csv"), col_types = vroom::cols()) %>% 
  mutate(dttm_obs = with_tz(dttm_obs, tz = "America/Chicago")) %>% 
  glimpse()
```

Study start dates
```{r}
dates <- vroom::vroom(here(path_shared, "visit_dates.csv"), col_types = vroom::cols()) 
```

Labels
```{r}
labels_05 <- vroom::vroom(here(path_meta, "labels_05.csv"), col_types = vroom::cols()) %>% 
  mutate(dttm_label = with_tz(dttm_label, tz = "America/Chicago")) 
```

Notes
```{r}
notes <- vroom::vroom(here("./shared/notes/raw_notes.csv"), col_types = vroom::cols()) 
```


### Check log start vs study start

Create first day of logs variable
```{r}
logs <- logs_all %>% 
  group_by(subid) %>% 
  arrange(subid, dttm_obs) %>% 
  slice(1) %>% 
  select(subid, dttm_obs)

logs <- logs %>% 
  left_join(dates %>% select(subid, start_study), by = "subid") %>% 
  # filter out excluded subids 
  filter(!subid %in% c(104, 204, 269)) %>% 
  mutate(diff_days =  date(dttm_obs) - start_study) %>% 
  glimpse()
```

`r nrow(subset(logs, diff_days > -7))` subids do not have communications at least 7 days 
before their study start date.
```{r}
logs %>% 
  filter(diff_days > -7)
```

`r nrow(subset(logs, diff_days > 0))` people may need to be excluded for having a large handful of days with no communications
```{r}
logs_last <- logs_all %>% 
  group_by(subid) %>% 
  arrange(desc(dttm_obs)) %>% 
  slice(1) %>% 
  select(subid, dttm_obs)

logs %>% 
  filter(diff_days > 0)  %>% 
  rename(first_log_date = dttm_obs) %>% 
  left_join(logs_last, by = "subid") %>% 
  rename(last_log_date = dttm_obs) %>% 
  left_join(dates %>% select(subid, end_study), by = "subid") %>% 
  mutate(first_log_date = date(first_log_date),
         last_log_date = date(last_log_date),
         log_days = last_log_date - first_log_date,
         study_days = end_study - start_study) %>% 
  print_kbl(height = "100")
```

Subid 1 has `r nrow(subset(logs_all, subid == 1))` log entries.    

- Communications don't start till on day 50 of the study and  has gaps in data that we do have.    
- Has no lapses on study.   
- Found participant only has 2 voice/SMS logs in raw data folder   

Log entries
```{r}
logs_all %>% 
  filter(subid == 1) %>% 
  select(subid, dttm_obs, number, log_type) %>% 
  arrange(dttm_obs) %>% 
  print(n = Inf)

logs_all %>% 
  filter(subid == 1) %>% 
  tabyl(log_type)
```

Lapses
```{r}
labels_05 %>% 
  filter(subid == 1) %>% 
  tabyl(label)
```

Notes
```{r}
notes %>% 
  filter(subid == 1) %>% 
  print_kbl(align = "l")
```



Subid 74 has `r nrow(subset(logs_all, subid == 74))` log entries.     

- communications don't start until day 33 on study   
- Has no lapses on study    
- According to notes we were unable to retrieve text/call logs at followup 1 since 
their phone was broken. (only 2 SMS/Voice logs in raw data folder)   


Log entries   
```{r}
logs_all %>% 
  filter(subid == 74) %>% 
  select(subid, dttm_obs, number, log_type) %>% 
  arrange(dttm_obs) %>% 
  print(n = Inf)

logs_all %>% 
  filter(subid == 74) %>% 
  tabyl(log_type)
```

Lapses
```{r}
labels_05 %>% 
  filter(subid == 74) %>% 
  tabyl(label)
```

Notes
```{r}
notes %>% 
  filter(subid == 74) %>% 
  print_kbl(align = "l")
```


