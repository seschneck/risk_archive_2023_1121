---
title: "IOS/Voice Logs"
author: "Kendra Wyant"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: 
  html_document:
    toc: yes
    toc_depth: 3
---

### Notes
Purpose: This script does further cleaning and pre-processing on the ios voice logs specifically for meta study.    

Preprocessing steps:   

1. Correct any identified errors in clean script    

* 2 dates with year 2024   
* Change RecentsNumberLocationNotFound in location to NA   

2. Tidy responses   

* Recode known variables to character strings   

3. Format numbers to match contacts   

* Contact numbers only have country codes if they non-US numbers   
* No + signs before non-US country codes and no punctuation or spaces in numbers  

Inputs:  
- voice_ios.csv (path_in)    

Output:   
- meta_voice_ios.csv (path_out)  

### Setup
```{css, echo = FALSE}
pre, code {
  max-height: 500px;
  overflow-y: auto;
  white-space: pre !important; 
  overflow-x: auto
}
```

Paths 
```{r}
path_in <- "Z:/studydata/risk/data_processed/shared"
path_out <- "Z:/studydata/risk/data_processed/meta"
```

Packages and Source
```{r, message = FALSE}
library(tidyverse)
library(kableExtra)
library(lubridate)
library(janitor)

source("C:/Users/kpaquette2/lab_support/fun_phone_numbers.R")

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```


### Read in logs
Manually specifying column types because for some reason it was reading ZNAME in as logical and losing the little data available
```{r}
logs <- read_csv(file.path(path_in, "voice_ios.csv"), col_types = "iTiiiiiniiiincccccccTTcc") %>% 
  # remove UUID columns and primary key (not useful for this study)
  select(-c(z_pk, zlocalparticipantuuid, zoutgoinglocalparticipantuuid)) %>% 
  glimpse()
```

### Clean errors identified in clean script EDA

FIX: 2 dates with year 2024 - change to NA and filter out
```{r}
logs %>% 
  arrange(desc(zdate)) %>% 
  head(10)  %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("striped", "condensed")) %>% 
  scroll_box(width = "100%", height = "500px")


logs <- logs %>% 
  mutate(zdate = case_when(date(zdate) == "2024-11-26" ~ as_datetime(NA),
                           TRUE ~ zdate)) %>% 
  filter(!is.na(zdate))
```

FIX: Replace RecentsNumberLocationNotFound with NA in location
```{r}
logs <- logs %>% 
  mutate(zlocation = case_when(zlocation == "<<RecentsNumberLocationNotFound>>"~ as.character(NA),
                               TRUE ~ zlocation)) %>% 
  glimpse()
```

### Filter out duplicate unique IDS 
Duplicates due to changes in read status between log downloads   
Will keep first occurrence of each log entry

```{r}
logs <- logs %>%
  group_by(zunique_id, zdate) %>%
  arrange(zdate) %>%
  slice(1) %>%
  ungroup() %>%
  glimpse()

```



### Tidy responses

ziso_country_code: Two digit ISO country code
```{r}
logs <- logs %>% 
  mutate(ziso_country_code = factor(ziso_country_code, 
                                    levels = c("ca", "be", "de", "mx", "nz", "pe", "tr", "us"),
                                    labels = c("Canada", "Belgium", "Germany", "Mexico", "New Zealand",
                                               "Peru", "Turkey", "United States")))
```

zoriginated: Whether the call was outgoing
```{r}
logs <- logs %>% 
  mutate(zoriginated = factor(zoriginated, 
                              levels = c(0, 1),
                              labels = c("incoming", "outgoing")))
```


<br>


### Clean number functions

Clean numbers with function
```{r}
logs$number_formatted <- map_chr(logs$zaddress, extract_number)
```

Extract country codes
```{r}
logs$extracted_country_code <- map_chr(logs$zaddress, extract_country_code)

tabyl(logs$extracted_country_code)
```

### Check unknown patterns for matches to contacts

read in contacts
```{r message = FALSE}
contacts <- read_csv(file.path(path_in, "contacts.csv"), col_types = cols()) %>% 
  glimpse()
```

match 7 digit numbers to pull area codes
```{r}
numbers_7_digits <- logs %>% 
  filter(str_detect(zaddress, "^[1-9]") & nchar(zaddress) == 7) %>% 
  select(zaddress) %>% 
  unlist(use.names = FALSE)

contacts_7_digits <- tibble(subid = as.numeric())

for (i in seq_along(numbers_7_digits)) {
  match <- contacts %>% 
    filter(str_detect(phone_number, numbers_7_digits[i])) %>% 
    mutate(pattern = numbers_7_digits[i])
  if(nrow(match) != 0) {  
    contacts_7_digits <- contacts_7_digits %>% full_join(match)
  }
}

contacts_7_digits %>% 
  select(subid, phone_number, pattern, contact_type) %>% 
  group_by(subid, phone_number, pattern) %>% 
  slice(1) %>% 
  print(n = Inf) 
```

Area code is 608 for most but not all 7-digit number matches
```{r}
contacts_7_digits %>% 
  mutate(area_code = str_sub(phone_number, 1, 3)) %>% 
  tabyl(area_code)
```

Join numbers with log entries and replace formatted number with contact number
```{r}
logs <- logs %>% 
  left_join(contacts_7_digits %>% 
              select(subid, contact_number = phone_number, zaddress = pattern), 
            by = c("subid", "zaddress")) %>% 
  glimpse()
```

Log entries with contact matches
```{r}
logs %>% 
  filter(!is.na(contact_number)) %>% 
  select(subid, zaddress, contact_number, zdate) %>% 
  print(n = Inf)
```

Update formatted number
```{r}
logs <- logs %>% 
  mutate(number_formatted = case_when(!is.na(contact_number) ~ as.character(contact_number),
                                      TRUE ~ number_formatted)) 

# check
logs %>% 
  filter(!is.na(contact_number)) %>% 
  select(subid, zaddress, contact_number, number_formatted) %>% 
  print(n = Inf)

# remove contact number variable
logs <- logs %>% 
  select(-contact_number)
```


Contact numbers more than 10 digits in length        
FIX: 11 is US exit code for dialing out of country. Remove 11 to match log format?   
43 - Austria   
49 - Germany  
91 - India  
57 - Columbia   

800050001020 is health insurance scammer according to Google  

```{r}
contacts %>% 
  filter(nchar(phone_number) > 10) %>% 
  select(subid, phone_number, contact_type)
```



### EDA

Missing data
```{r}
logs %>%
  naniar::miss_var_summary()
```


#### Phone numbers

**Internet calls**    

```{r}
tabyl(logs$zservice_provider) 
```

BTU numbers are from Facebook messenger
```{r}
logs %>% 
  filter(str_detect(number_formatted, "IBTU") | str_detect(number_formatted, "JBTU") | 
           str_detect(number_formatted, "KBTU")) %>% 
  select(number_formatted, zservice_provider) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("striped", "condensed")) %>% 
  scroll_box(height = "500px", width = "75%")
```

Amazon echo calls    
FIX: replace with something readable?
```{r}
logs %>% 
  filter(zservice_provider == "94KV3E626L.com.amazon.echo") %>% 
  tabyl(zaddress)  %>% 
  kbl() %>% 
  kable_styling()
```

Instagram  
```{r}
logs %>% 
  filter(zservice_provider == "MH9GU9K5PX.com.burbn.instagram") %>% 
  tabyl(zaddress) %>% 
  kbl() %>% 
  kable_styling()
```

Whisper
```{r}
logs %>% 
  filter(zservice_provider == "U68MSDN6DR.org.whispersystems.signal") %>% 
  tabyl(zaddress) %>% 
  kbl() %>% 
  kable_styling()
```











#### Country codes

extracted country code and iso country code don't always match    
According to Apple ISO Country code = The ISO country code for the userâ€™s cellular service provider
```{r}
table(logs$ziso_country_code, logs$extracted_country_code)

logs %>% 
  filter(ziso_country_code == "Mexico") %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
  scroll_box(height = "500px", width = "100%")
```







### Remove other columns unnecessary for data analyses

```{r}
logs_final <- logs %>% 
  select(-c(log_file, created, modified, zunique_id))
```


### Write csv
```{r}
# write_csv(logs, file.path(path_out, "meta_voice_ios.csv")) %>% 
#   glimpse()
```

**Dates saved as UTC**

<br>










