---
title: "Meta Feature Engineering Shell"
author: "Kendra Wyant"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
    code_folding: show
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/knits/meta", 
      "/Volumes/private/studydata/risk/knits/meta")
    )
  })
---

### Code status

This shell is still in progress. Currently have a preliminary working filter_features function.  


### Conclusions

- Likely want to take function out of this script and put in a lab_support script.   
- Still need to discuss filter function with John


### Notes

This script serves as a shell for the feature engineering script for meta study.


### Set up Environment

Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')
```

Absolute paths
```{r, paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_meta <- "P:/studydata/risk/data_processed/meta"
          path_shared <- "P:/studydata/risk/data_processed/shared"
          path_lab_support <- "P:/toolboxes/lab_support"},

        # IOS paths
        Darwin = {
          path_meta <- "/Volumes/private/studydata/risk/data_processed/meta"
          path_shared <- "/Volumes/private/studydata/risk/data_processed/shared"
          path_lab_support <- "/Volumes/toolboxes/lab_support"}
        )
```

Relative paths
```{r}

```

Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) # detect and warn about function conflicts
 conflict_prefer("filter", "dplyr")
 conflict_prefer("select", "dplyr")

library(here)  # establish project directory consistently as working directory
```

Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
# for data wrangling
library(tidyverse)  # always need this
library(janitor) # cleaning and EDA
library(lubridate)
library(purrr)

# for plots and tables
library(ggplot2)
theme_set(theme_bw()) # or theme_set(theme_classic())
library(kableExtra)
```

Source for script
```{r, source_script, message=FALSE, warning=FALSE}
# source(here(path_lab_support, "get_credentials.R"))
```


### Filter Function

```{r}
filter_features <- function(the_subid, hour, data, lead_hours, period_duration_hours, study_start = NULL) {

  # Pass in subid and hour from lapse label - use map2_dfr to iterate through each 
  # row of lapse tibble
  # Pass in data tibble that will be filtered on by labels (MUST INCLUDE DATE VARIABLE)
  # Set lead_hours parameter to number of hours out from lapse you wish to predict 
  # Set period duration hours to set the duration over which you wish to use data from - 
  # If using all data since study start set period_duration_hours = NULL and pass
  # in tibble of subid and start dates (currently set to be compatible with start_study 
  # variable from visit dates)
  
  # JOHN - discuss how to best handle period_duration in hours vs start_study dates. 
  # Below is my solution, but may not be what you are thinking. 
  
  # Kendra, 
  # lets use variable names as they are currently returned by other functions
  # e.g., do data files have column called date or do we not yet have any consistent name
  # Lets discuss if we need/should filter on study_start
  # Did you need subid_label and hour_label?
  # Do remove message when testing is done. Good to have now.
  # Move function to fun_risk.R
  # Call function get_feature_period()
  
  # Create start date for filtering from study_start or period_duration_hours
  if (is.null(period_duration_hours)) {
    study_start <- study_start %>% 
      filter(subid == the_subid)
    start_date <- study_start$start_study
  } else {
    start_date <- hour_label - duration(period_duration_hours, "hours")
  }
  
  # filter on start_date
  data <- data %>% 
    filter(subid == the_subid) %>% 
    filter(date >= start_date)
  
  # filter on lead hours
  data <- data %>% 
    mutate(diff_hours = as.numeric(difftime(hour_label, date, units = "hours"))) %>%  
    filter(diff_hours >= lead_hours) 
  
  # can remove this message later - using for demo
  message("adding ", nrow(data), " rows")
  
  data
}
```


### Demo of filter function

#### Read in and prepare data

Read in logs    
```{r}
logs <- vroom::vroom(here(path_meta, "meta_logs.csv"), col_types = cols()) %>% 
  mutate(date = with_tz(date, tzone = "America/Chicago")) %>% 
  glimpse()
```

Narrow down to logs for only 10 random subids for demo
```{r}
set.seed(20210606)

subids_demo <- logs %>% 
  count(subid) %>% 
  slice_sample(n = 10)

logs_demo <- logs %>% 
  filter(subid %in% subids_demo$subid) %>% 
  glimpse()
```


Read in lapse labels
```{r}
labels <- vroom::vroom(here(path_shared, "labels_all.csv"), col_types = cols()) %>% 
  select(subid, hour) %>% 
  mutate(hour = with_tz(hour, tzone = "America/Chicago")) %>% 
  glimpse()
```

Narrow down lapse labels to 10 random lapses for demo
```{r}
labels_demo <- labels %>% 
  filter(subid %in% subids_demo$subid) %>% 
  slice_sample(n = 10)

labels_demo
```


Read in study start dates
```{r}
study_start_dates <- vroom::vroom(here(path_shared, "visit_dates.csv"), col_types = cols()) %>% 
  filter(subid %in% subids_demo$subid) %>% 
  mutate(start_study = force_tz(as_datetime(start_study)), "America/Chicago") %>% 
  select(subid, start_study) %>% 
  glimpse()
```


#### Run function    

Run function w/period duration hours specified
```{r}
logs_filtered <- map2_dfr(labels_demo$subid, 
                          labels_demo$hour, 
                          ~filter_features(
                            subid = .x,
                            hour = .y,
                            data = logs_demo,
                            lead_hours = 0, 
                            period_duration_hours = 72)) %>% 
  glimpse()
```


Run function w/study start dates
```{r}
logs_filtered <- map2_dfr(labels_demo$subid, 
                          labels_demo$hour, 
                          ~filter_features(
                            subid = .x,
                            hour = .y,
                            data = logs_demo,
                            lead_hours = 0, 
                            period_duration_hours = NULL,
                            study_start = study_start_dates)) %>% 
  glimpse()
```


Run function w/study start dates and 24 hour prediction lead
```{r}
logs_filtered <- map2_dfr(labels_demo$subid, 
                          labels_demo$hour, 
                          ~filter_features(
                            subid = .x,
                            hour = .y,
                            data = logs_demo,
                            lead_hours = 24, 
                            period_duration_hours = NULL,
                            study_start = study_start_dates)) %>% 
  glimpse()
```



