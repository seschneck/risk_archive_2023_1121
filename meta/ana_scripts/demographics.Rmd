---
title: "Demographic Characteristics for Meta Study"
author: "Kendra Wyant"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: 
  html_document:
    toc: true 
    toc_depth: 4
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/knits/meta", 
      "/Volumes/private/studydata/risk/knits/meta")
    )
  })
---



### Setup

Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```


Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(here)  
```

Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
library(tidyverse)  
library(janitor) 
library(lubridate)
library(ggplot2)
library(kableExtra)
library(vip)
library(tictoc)

theme_set(theme_classic()) 
```

Set additional paths
```{r}
path_models <- "meta/ana_scripts/model_output"
path_results <- "P:/studydata/risk/chtc/meta/jobs/training/model_selection/output/results"
path_features <- "P:/studydata/risk/chtc/meta/jobs/training/model_selection/input"
path_figures <- "meta/ana_scripts/figures"
path_meta <- "P:/studydata/risk/data_processed/meta"
path_shared <- "P:/studydata/risk/data_processed/shared"
```

Source function scripts from lab support
```{r  source_script, message=FALSE, warning=FALSE}
source(here("../lab_support/print_kbl.R"))
```


### Read in data

```{r}
study_dates <- vroom::vroom(here(path_meta, "study_dates.csv"), col_types = vroom::cols()) %>% 
  mutate(across(study_start:ema_end, ~with_tz(., tzone = "America/Chicago"))) %>% 
  glimpse() 

data_id <- vroom::vroom(here(path_meta, "static_features.csv"), col_types = vroom::cols()) %>%
  mutate(id_quit_date = with_tz(id_quit_date, tzone = "America/Chicago")) %>% 
  filter(subid %in% study_dates$subid) %>% 
  glimpse()

data_context <- vroom::vroom(here(path_shared, "contacts.csv"), col_types = vroom::cols()) %>% 
  filter(subid %in% study_dates$subid) %>% 
  glimpse()
```

### Summarize demographics and study characteristics

```{r}
dem <- data_id %>% 
  summarise(mean = as.character(round(mean(id_age, na.rm = TRUE), 1)),
            SD = as.character(round(sd(id_age, na.rm = TRUE), 1))) %>% 
  mutate(var = "Age",
         n = as.numeric(""),
         perc = as.numeric("")) %>% 
  select(var, n, perc, everything()) %>% 
  full_join(data_id %>% 
  select(var = id_gender) %>% 
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(data_id %>% 
  select(var = id_race) %>% 
  mutate(var = fct_relevel(factor(var, 
                         c("American Indian/Alaska Native", "Asian", "Black/African American",
                           "White/Caucasian", "Other/Multiracial")))) %>%
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(data_id %>% 
  select(var = id_hispanic) %>% 
  mutate(var = case_when(var == "no" ~ "No",
                         TRUE ~ "Yes"),
         var = fct_relevel(factor(var, c("Yes", "No")))) %>% 
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(data_id %>% 
  select(var = id_education) %>% 
  mutate(var = fct_relevel(factor(var, 
                         c("Less than high school or GED degree", "High school or GED", 
                           "Some college", "2-Year degree", "College degree", "Advanced degree")))) %>%
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(data_id %>% 
  select(var = id_employment) %>% 
  mutate(var = fct_relevel(factor(var, 
                         c("Full-time", "Part-time", "Full-time student",
                           "Homemaker", "Disabled", "Retired", "Unemployed", 
                           "Temporarily laid off, sick leave, or maternity leave",
                           "Other, not otherwise specified")))) %>%
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc")) %>% 
  full_join(data_id %>% 
  summarise(mean = as.character(round(mean(id_income, na.rm = TRUE), 0)),
            SD = as.character(round(sd(id_income, na.rm = TRUE), 0))) %>% 
  mutate(var = "Income",
        n = as.numeric(""),
        perc = as.numeric("")) %>% 
  select(var, n, perc, everything()), by = c("var", "n", "perc", "mean", "SD")) %>% 
  full_join(data_id %>% 
  select(var = id_marrital_status) %>% 
  mutate(var = fct_relevel(factor(var, 
                         c("Never Married", "Married", "Divorced", "Separated",
                           "Widowed")))) %>%
  group_by(var) %>% 
  summarise(n = n()) %>% 
  mutate(perc = (n / sum(n)) * 100), by = c("var", "n", "perc"))

dem %>% 
  kbl(booktabs = TRUE,
      caption = "Demographics",
      col.names = c("", "n", "%", "M", "SD"),
      align = c("l", "c", "c", "c", "c"),
      digits = 1,
      longtable = TRUE) %>% 
  kable_styling() %>% 
  row_spec(row = 0, align = "c", italic = TRUE) %>% 
  pack_rows("Sex", 2, 3, bold = FALSE) %>% 
  pack_rows("Race", 4, 8, bold = FALSE) %>%
  pack_rows("Hispanic, Latino, or Spanish Origin", 9, 10, bold = FALSE) %>%
  pack_rows("Education", 11, 16, bold = FALSE) %>%
  pack_rows("Employment", 17, 25, bold = FALSE) %>%
  pack_rows("Marital Status", 27, 31, bold = FALSE) %>% 
  footnote("N = 151")
```


Average days on study
```{r}
study_dates %>% 
  mutate(study_days = round(as.numeric(difftime(study_end, study_start, "days")))) %>% 
  ggplot(aes(x = study_days)) +
  geom_histogram(bins = 20, color = "black", fill = "light grey") +
  geom_vline(aes(xintercept = mean(study_days)), study_dates %>% 
  mutate(study_days = round(as.numeric(difftime(study_end, study_start, "days")))),
  color = "red3") +
  scale_x_continuous(breaks = c(0, 30, 60, 90), n.breaks = 4)
```


### Summarize context data
