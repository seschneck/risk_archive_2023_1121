---
title: "Aggregates jobs for Meta features from CHTC"
author: "John Curtin"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/knits/meta", 
      "/Volumes/private/studydata/risk/knits/meta")
    )
  })
---

### Code Status

In Use (still improving?).  Same code (different file/script) used by GPS too

### Notes   

This script aggregates all CHTC features and checks for missing jobs and other EDA.
  

Inputs:  

Returned CHTC files: 

* features
* error

Jobs input file   

* jobs.csv   

Output:   

* features_WINDOW.csv 

### Set up Label Window

EDIT THIS
```{r}
window <- "1day"
```


### Set Up Environment

Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) 
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
conflict_prefer("cols", "readr")

library(here)
```

Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
library(tidyverse)  
library(janitor) 
library(vroom)
library(furrr)
library(purrr)
library(stringr)
```

Source for script
```{r, source_script, message=FALSE, warning=FALSE}
source(here("../lab_support/print_kbl.R"))
```

Absolute paths
```{r, absolute paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_jobs <- str_c("P:/studydata/risk/chtc/meta/features_", window)
          path_meta <- "P:/studydata/risk/data_processed/meta"},

        # IOS paths
        Darwin = {
          path_jobs <- str_c("/Volumes/private/studydata/risk/chtc/meta/features_", window)
          path_meta <- "/Volumes/private/studydata/risk/data_processed/meta"}
        )
```


Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```


### Check raw files

Read job file
```{r}
jobs <- vroom(here(path_jobs, "input", "jobs.csv"), 
              show_col_types = FALSE, 
              col_names = FALSE) %>% 
  rename(job_start = X1, job_end = X2) %>% 
  glimpse()
```

Get counts of jobs and labels
```{r}
(n_jobs <- nrow(jobs))

(n_labels <- jobs %>% 
  mutate(n_bundle = job_end - job_start + 1) %>% 
  summarise(n_labels = sum(n_bundle)) %>% 
  pull(n_labels))
```

Read error, out, and feature files

```{r}
err_files <- map_dfr(list.files(here(path_jobs, "output", "error"), 
                               full.names = TRUE), 
                    file.info)
n_err_files <- nrow(err_files)

feature_files <- map_dfr(list.files(here(path_jobs, "output", "features"), 
                               full.names = TRUE), 
                    file.info)
n_feature_files <- nrow(feature_files)
```

Check counts of error, and features
```{r}
if (!(n_jobs == n_err_files)) {
  stop(n_jobs, " jobs != ", n_err_files, " error files!") 
} else {
  message(n_err_files, " error files detected.  Correct!")
}

if (!(n_jobs == n_feature_files)) {
  stop(n_jobs, " jobs != ", n_feature_files, " feature files!")
} else {
  message(n_feature_files, " feature files detected.  Correct!")
}
```

Display path/filename of non-zero error files
```{r}
err_files %>%
    filter(size > 0) %>%
    rownames_to_column("path") %>%
    pull(path)
```


### Aggregate feature files 

```{r}
 
#future_map over subids
(n_core <- parallel::detectCores(logical = FALSE))
plan(multisession, workers = n_core)

features <- list.files(here(path_jobs, "output", "features"), full.names = TRUE) %>% 
  future_map_dfr(~read_csv(file = .x, col_types = cols())) %>% 
  arrange(subid, dttm_label) %>% 
  glimpse()
plan(sequential)
```


### Brief EDA on Features

#### Basic Checks
Check for correct number of features (matches number of labels)  

```{r}
if (nrow(features) == n_labels) {
  message("Features detected for ", n_labels, " labels.  Correct!")
} else {
  stop("Missing features for label_num: \n", 
       subset(1:n_labels, !1:n_labels %in% features$label_num))
}
```

Check for duplicate labels
```{r}
features %>% 
  count(subid, dttm_label) %>% 
  filter(n > 1)
```

#### Missing Values

All missing values should be proportions   
```{r}
features %>% 
  naniar::miss_var_summary() %>% 
  filter(n_miss > 0) %>% 
  print(n = Inf)
```

Check for NaN.  Select only columns with NaN
```{r}
features %>% 
  summarise(across(everything(), ~ sum(is.nan(.x)))) %>% 
  select(where(function(x) x < 0)) %>% 
  glimpse() 
```


TEMP UNTIL FIGURE OUT MISSING
Remove high (> 20%) NA

```{r}
features <- features %>% 
  discard(~sum(is.na(.x))/length(.x) >.20)
```

#### Descriptives


NEED EDA



### Write feature file

```{r}
features %>% 
  vroom_write(here(path_meta, str_c("features_", window, ".csv"))) %>% 
  vroom_write(here(path_meta, str_c("features_", window, ".csv.xz")))
```


TEMP REDUCE FEATURES BY DELETING PROPORTION SCORES
```{r}
features %>% 
  vroom_write(here(path_meta, str_c("features_", window, ".csv"))) %>% 
  vroom_write(here(path_meta, str_c("features_", window, ".csv.xz")))
```
