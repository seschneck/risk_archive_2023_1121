---
title: "Documentation of Map and Future Map"
author: "Kendra Wyant"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
    code_folding: show
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/knits/meta", 
      "/Volumes/private/studydata/risk/knits/meta")
    )
  })
---


### Set up Environment

Chunk Defaults
```{r defaults, include=FALSE}
knitr::opts_chunk$set(attr.output='style="max-height: 500px;"')

options(tibble.width = Inf)
options(tibble.print_max = Inf)
```

Absolute paths
```{r, paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_meta <- "P:/studydata/risk/data_processed/meta"
          path_shared <- "P:/studydata/risk/data_processed/shared"},

        # IOS paths
        Darwin = {
          path_meta <- "/Volumes/private/studydata/risk/data_processed/meta"
          path_shared <- "/Volumes/private/studydata/risk/data_processed/shared"}
        )
```


Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
# detect and warn of conflicts
library(conflicted) 
 conflict_prefer("filter", "dplyr")
 conflict_prefer("select", "dplyr")

# set working directory to project
library(here)
```

Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
# data wrangling
library(tidyverse)  
library(janitor) 
library(lubridate)
library(purrr)
library(vroom)

# plots and tables
library(ggplot2)
theme_set(theme_classic()) 
library(kableExtra)
```

Source scripts
```{r, source_script, message=FALSE, warning=FALSE}
source(here("shared/fun_risk.R"))
source(here("../lab_support/print_kbl.R"))
```

### Read in Data

Meta logs dataframe  
```{r}
logs_all <- vroom(here(path_meta, "meta_logs.csv"), col_types = vroom::cols()) %>% 
  mutate(dttm_obs = with_tz(dttm_obs, tzone = "America/Chicago")) %>% 
  glimpse()

logs_sms <- logs_all %>% 
  filter(log_type == "sms") 
logs_voice <- logs_all %>% 
  filter(log_type == "voice") 
```

Lapse labels dataframe
```{r}
labels_05 <- vroom(here(path_meta, "labels_05.csv"), col_types = vroom::cols()) %>% 
  mutate(dttm_label = with_tz(dttm_label, tzone = "America/Chicago")) %>% 
  glimpse()
```

Read in study specific start dates
```{r}
data_start <- vroom::vroom(here(path_meta, "study_dates.csv"), col_types = vroom::cols()) %>% 
  select(subid, study_start, comm_start, data_start) %>% 
  mutate(across(study_start:data_start), with_tz(., tz = "America/Chicago")) %>% 
  glimpse()
```

### Make Features

Slice out test set of labels
```{r}
set.seed(102030)
labels_test <- slice_sample(labels_05, n = 1000)
```

### Initialize values for period duration and lead hours

Period duration should be a vector containing 1+ values in hours
```{r}
period_durations <- c(24, 48) 
```

Lead should be a single value in hours
```{r}
lead <-  0 
```


### Document time to run Map and Future Map

Map
```{r}
tictoc::tic()
meta_features <- map2_dfr(labels_test$subid, 
         labels_test$dttm_label,
         ~score_ratecount_value(
           the_subid = .x,
           the_dttm_label = .y,
           x_all  = logs_all,
           period_durations = period_durations,
           lead = lead, 
           data_start = data_start, 
           col_name = "org", 
           col_values = c("incoming", "outgoing"), 
           data_type_col = "log_type",
           data_type_values = c("sms", "voi"))) %>% 
  glimpse()
tictoc::toc()
```

Future Map all cores
```{r}
library(furrr)
library(progressr)

availableCores()

plan(multisession, workers = availableCores())

tictoc::tic()
meta_features <- future_map2_dfr(labels_test$subid, 
         labels_test$dttm_label,
         ~score_ratecount_value(
           the_subid = .x,
           the_dttm_label = .y,
           x_all  = logs_all,
           period_durations = period_durations,
           lead = lead, 
           data_start = data_start, 
           col_name = "org", 
           col_values = c("incoming", "outgoing"), 
           data_type_col = "log_type",
           data_type_values = c("sms", "voi"))) %>% 
  glimpse()
tictoc::toc()
```

Future Map logical cores
```{r}
availableCores(logical = FALSE)

plan(multisession, workers = availableCores(logical = FALSE))

tictoc::tic()
meta_features <- future_map2_dfr(labels_test$subid, 
         labels_test$dttm_label,
         ~score_ratecount_value(
           the_subid = .x,
           the_dttm_label = .y,
           x_all  = logs_all,
           period_durations = period_durations,
           lead = lead, 
           data_start = data_start, 
           col_name = "org", 
           col_values = c("incoming", "outgoing"), 
           data_type_col = "log_type",
           data_type_values = c("sms", "voi"))) %>% 
  glimpse()
tictoc::toc()
```

