---
title: "make enriched gps/location"
author: "John Curtin"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = dplyr::if_else(Sys.info()[["sysname"]] == "Windows",
      "P:/studydata/risk/knits/gps", 
      "/Volumes/private/studydata/risk/knits/gps")
    )
  })
---

### Code Status

under development

### Notes   



### Set Up Environment

Constants
```{r}
dist_context_min <- 50  # must be within 50 meters to match geolocation to context
```


Absolute paths
```{r, absolute paths}
switch (Sys.info()[['sysname']],
        # PC paths
        Windows = {
          path_shared <- "P:/studydata/risk/data_processed/shared"
          path_gps <- "P:/studydata/risk/data_processed/gps"},

        # IOS paths
        Darwin = {
          path_shared <- "/Volumes/private/studydata/risk/data_processed/shared"
          path_gps <- "/Volumes/private/studydata/risk/data_processed/gps"}
        )
```

Packages for lab workflow 
```{r, packages_workflow, message=FALSE, warning=FALSE}
library(conflicted) # detect and warn about function conflicts
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

library(here)  # establish project directory consistently as working directory
```


Packages for script
```{r, packages_script, message=FALSE, warning=FALSE}
# for data wrangling
library(tidyverse)
library(vroom)
library(purrr)
library(furrr)
library(tictoc)
```


Source for script
```{r, source_script, message=FALSE, warning=FALSE}
source(here("../lab_support/fun_gps.R"))
```


### Begin Main Code

Open data files
```{r}
gps <-  vroom(here(path_shared, "gps.csv")) %>% 
  glimpse()

locs <- vroom(here(path_shared, "locations.csv")) %>% 
  mutate(subid = as.numeric(subid))

```

Merge context into gps
```{r}

#add context to gps for one subid
enrich_subid <- function(a_subid, gps, locs) {
  gps <- gps %>% 
    filter(subid == a_subid)
  
  locs <- locs %>% 
    filter(subid == a_subid)
  
  enriched <- gps %>% 
    bind_cols(map2_dfr(gps$lon, gps$lat, find_nearest_context, context = locs)) 
  
  return(enriched)
}

#get all subids
subids <- gps %>% 
  pull(subid) %>% 
  unique() %>% 
  print()

#future_map over subids
(n_core <- parallel::detectCores(logical = FALSE))
plan(multisession, workers = n_core)

tic()
enriched <- subids %>% 
  future_map_dfr(enrich_subid, gps = gps, locs = locs)
toc()


# join on context_id
#remove context_lat and lon then join and rearragne columns
```


###  Brief EDA



### Save enriched GPS



