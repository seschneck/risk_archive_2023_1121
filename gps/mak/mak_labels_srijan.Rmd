---
title: "Makes datafile of time stamped lapses"
author: "JJC and SJS"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

## Set up paths and packages
```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(janitor)
library(lubridate)
library(kableExtra)

source('P:/toolboxes/lab_support/fun_modeling.R')

path_data <- "P:/StudyData/RISK/analysis/shared/data"
path_notes <- "P:/StudyData/RISK/analysis/shared/notes"
path_raw <- "P:/StudyData/RISK/raw_data"
path_out <- "P:/StudyData/RISK/analysis/gps/data"
```

## Load files

Load, rename, and select for cleaned ema files
```{r}
ema_morning <- read_csv(file.path(path_data, 'ema_morning.csv'), col_types = cols()) %>%   
  rename(ema_1 = emam_1,
         ema_1_1 = emam_1_1,
         ema_1_2 = emam_1_2,
         ema_1_3 = emam_1_3,
         ema_1_4 = emam_1_4,
         ema_1_5 = emam_1_5) %>% 
  select(subid, response_id, start_date, end_date, utc, finished, starts_with("ema_1")) %>%
  mutate(type = "morning") %>% 
  glimpse()

ema_later <- read_csv(file.path(path_data, 'ema_later.csv'), col_types = cols()) %>% 
  rename(ema_1 = emal_1,
         ema_1_1 = emal_1_1,
         ema_1_2 = emal_1_2,
         ema_1_3 = emal_1_3,
         ema_1_4 = emal_1_4,
         ema_1_5 = emal_1_5) %>% 
  select(subid, response_id, start_date, end_date, utc, finished, starts_with("ema_1")) %>% 
  mutate(type = "later") %>% 
  glimpse()

#Set TZ to america/chicago so it makes sense when comparing to lapse dates
ema <-
  ema_morning %>% 
  bind_rows(ema_later) %>% 
  mutate(start_date = force_tzs(time = start_date, tzones = "UTC", tzone_out = "America/Chicago"),
         end_date = force_tzs(time = end_date, tzones = "UTC", tzone_out = "America/Chicago")) %>% 
  glimpse()
```

Open and combine data logs to look up notes about remaining problematic lapses
```{r}
log_morning <- read_csv(file.path(path_notes, "log_ema_morning.csv"), col_types = cols())

log_later <- read_csv(file.path(path_notes, "log_ema_later.csv"), col_types = cols())

log <- full_join(log_morning, log_later)

```

## Preliminary checks
ema_1 answered for all surveys. We will filter down to Yes below.
```{r}
ema %>% tabyl(ema_1)

total_yes <- ema %>% 
  tabyl(ema_1) %>% 
  filter(ema_1 == "Yes") %>% 
  pull(n)
```

### Reivew unfinished surveys
There are unfinished surveys
```{r}
ema %>% tabyl(finished)
```

Some of these unfinished are lapse reports
```{r}
ema %>% tabyl(finished, ema_1)
```

Here are those unfinished lapse reports
```{r}
ema %>% 
  filter(finished == 0, ema_1 == "Yes") %>% 
  select(starts_with("ema")) %>% 
  print(n = Inf)
```

Many of the Yes responses have no dates, times or other info. This happened often when a participant incorrectly selected Yes and had no way to fix this. Surveys that are unfinished and didnâ€™t at least include ema_1_1 (date of lapse) will be dropped. 
```{r}
(removed_yes <- sum(ema$finished == 0 & ema$ema_1 == "Yes" & is.na(ema$ema_1_1)))
```

However, unfinished responses that do include answers to question 1 follow-ups are retained
```{r}
ema_lapses <- ema %>% 
  filter(!(finished == 0 & is.na(ema_1_1))) %>% 
  filter(ema_1 == "Yes") %>% 
  glimpse()
```

Check my accounting of Yes responses
```{r}
nrow(ema_lapses) == total_yes - removed_yes
```

### Check ema_lapses survey date stamps
No missing for start_date or end_date
```{r}
sum(is.na(ema_lapses$start_date))

sum(is.na(ema_lapses$end_date))
```

One missing values for utc. There is one.  It looks normal  otherwise
```{r}
sum(is.na(ema_lapses$utc))

ema_lapses %>% 
  filter(is.na(utc)) %>% 
  print(n = Inf)
```

#### Compare start_date to utc timestamp

Good except for responses that are off by an hour. Susan confirms this was an issue with piped in UTC stamp. We will not use utc
```{r}
ema_lapses %>% 
  mutate(utc = as_datetime(utc, tz = "UTC", origin = "1970-01-01"),
         start_utc_diff_secs = as.numeric(difftime(start_date, utc, units = "secs"))) %>% 
  pull(start_utc_diff_secs) %>% 
  tabyl()

ema_lapses <- ema_lapses %>% 
  select(-utc)
```

#### Compare start_date to end_date

* There are some surveys with VERY long completion times
* All will be retained
```{r}
ema_lapses <- ema_lapses %>% 
  mutate(start_end_diff_mins = round(as.numeric(difftime(end_date, start_date, units = "mins")), 1))

ema_lapses %>% tabyl(start_end_diff_mins)
```

Here are the surveys with response times > 15 mins
```{r}
ema_lapses %>% 
  filter(start_end_diff_mins > 15) %>% 
  left_join(log) %>% 
  select(start_end_diff_mins, subid, start_date, end_date, finished, contains("ema"), notes) %>% 
  arrange(start_end_diff_mins) %>% 
  print_kbl()

ema_lapses <- ema_lapses %>% 
  select(-start_end_diff_mins)
```



#### Create $lapse\_start$ and $lapse\_end$

First need to handle the coding of lapse hour variables

* Need to handle midnight as 12 am
* Need to handle noon as 12 pm

```{r}
ema_lapses %>% tabyl(ema_1_2)

ema_lapses <- ema_lapses %>% 
  mutate(ema_1_2 = dplyr::recode(ema_1_2, Midnight = "12 AM", Noon = "12 PM"),
         ema_1_4 = dplyr::recode(ema_1_4, Midnight = "12 AM", Noon = "12 PM"))
```

Next, need to handle the time_zone issues.  Sarah computed timezones for lapses (to be included as a separate script). Here was the process:

* Found the closest day with gps data to each lapse start date
* Used tz_lookup_coords from the lutz package to get the timezone of the closest gps day
* Lapses that occurred in a timezone other than America/Chicago, occurred on days where the participant was in more than one timezone, or did not have any gps data on the day of the reported lapse were added to the ema logs and were inspected with EDA to determine the timezone. 
* All lapses in that were not in the america/chicago timezone are listed in the log, otherwise timezone is America/Chicago


Now, we need to:

1. Pull log entries that indicate new timezone
```{r}
recode_tz <- log %>% 
  filter(log_action == "recode_tz") %>% 
  select(response_id, new_value) %>% 
  rename(time_zone = new_value) %>% 
  glimpse()
```

2. Merge timezone info into ema_lapses tibble
```{r}
ema_lapses <- left_join(ema_lapses, recode_tz, by = "response_id") %>% 
  mutate(time_zone = replace_na(time_zone, "America/Chicago"))
```

3. Review timezones

    * There are 5 unique timezones in lapses. 
    * There are 53 lapses in timezones other than America/Chicago.
```{r}
ema_lapses %>% tabyl(time_zone)
```


4. Now convert lapse time variables to $lapse\_start$ and $lapse\_end$

NOTE: There was 3 lapses with missing values for lapse onset hour and/or lapse offset hour.  They remain missing for lapse_start and lapse_end.

```{r}
# make lapse start and end variables
ema_lapses <- ema_lapses %>% 
  mutate(lapse_start = str_c(ema_1_1, ema_1_2, sep = " "),
         lapse_start = as_datetime(lapse_start, tz = "America/Chicago", format = "%m-%d-%Y %I %p"),
         lapse_start = force_tzs(time = lapse_start, tzones = time_zone, tzone_out = "America/Chicago"),
         lapse_end = str_c(ema_1_3, ema_1_4, sep = " "),
         lapse_end = as_datetime(lapse_end, tz = "America/Chicago", format = "%m-%d-%Y %I %p"),
         lapse_end = force_tzs(time = lapse_end, tzones = time_zone, tzone_out = "America/Chicago"))

ema_lapses %>% 
  filter(is.na(lapse_start) | is.na(lapse_end)) %>% 
  select(subid, response_id, contains("ema"), lapse_start, lapse_end, type) %>% 
  print()
```

#### Compare lapse_start to lapse_end

There are some clear issues to review here

* Some negative values
* Some really long values

```{r}
ema_lapses <- ema_lapses %>% 
  mutate(lapse_start_end_diff_hours = round(as.numeric(difftime(lapse_end, lapse_start, units = "hours")), 1))

ema_lapses %>% plot_hist("lapse_start_end_diff_hours")
```


Here are notes for negative and long positive lapses
```{r}
ema_lapses %>% 
  filter(lapse_start_end_diff_hours < 0 | lapse_start_end_diff_hours > 15) %>% 
  left_join(log) %>% 
  select(lapse_start_end_diff_hours, subid, start_date, end_date, contains("ema"), lapse_start, lapse_end, notes) %>% 
  arrange(lapse_start_end_diff_hours) %>% 
  print_kbl()

ema_lapses <- ema_lapses %>% 
  select(-lapse_start_end_diff_hours)
```


#### Compare lapse start date to survey start date

Here is a comparison of the lapse start time to the survey start time.  Lapse starts should have preceded survey starts unless

* It was a survey that was started and left open to be finished after the lapse
* It was an error

```{r}
ema_lapses <- ema_lapses %>% 
  mutate(survey_lapse_diff_start_hours = round(as.numeric(difftime(start_date, lapse_start, units = "hours")), 1))
```

Surveys where the start of the lapse was reported in the future relative to the start of the survey have negative $survey\_lapse\_diff\_start$ values.  Surveys were the lapse was reported greater than 10 hours after it occurred were visually inspected by staff to check for validity. 

```{r}
ema_lapses %>% 
  filter(survey_lapse_diff_start_hours < 0 | survey_lapse_diff_start_hours > 24) %>% 
  left_join(log) %>% 
  select(survey_lapse_diff_start_hours, subid, start_date, end_date, contains("ema"), lapse_start, lapse_end, notes) %>% 
  arrange(survey_lapse_diff_start_hours) %>% 
  print_kbl()

ema_lapses <- ema_lapses %>% 
  select(-survey_lapse_diff_start_hours)
```

#### Compare lapse end date to survey end date

Here is a comparison of the lapse end time to the survey end time.  Lapse end should have preceded survey end unless

* The survey was reporting drinking up to the current time. Since lapses are reported only at the full hour (e.g. 7 pm, 8 pm), if a participant is completing a report of drinking at 8:30, lapses were rounded up to 9 PM to capture the full hour.
* It was an error

```{r}
ema_lapses <- ema_lapses %>% 
  mutate(survey_lapse_diff_end_hours = round(as.numeric(difftime(end_date, lapse_end, units = "hours")), 1))
```


```{r}
ema_lapses %>% 
  filter(survey_lapse_diff_end_hours < 0 | survey_lapse_diff_end_hours > 24) %>% 
  left_join(log) %>% 
  select(survey_lapse_diff_end_hours, subid, start_date, end_date, contains("ema"), lapse_start, lapse_end, notes) %>% 
  arrange(survey_lapse_diff_end_hours) %>% 
  print_kbl()

ema_lapses <- ema_lapses %>% 
  select(-survey_lapse_diff_end_hours)
```


## Open, Clean and BIND Lapses Reported by Interview to EMA Lapses

```{r}
ema_lapses <- ema_lapses %>% 
  select(-response_id, -start_date, -end_date, -finished) %>% 
  print()
```

```{r}
interview_lapses <- read_csv(file.path(path_raw, "additional_lapses.csv"), col_types = cols()) %>% 
  select(-report_date, -source, -notes) %>% 
  mutate(type = "interview") %>% 
  glimpse()
```

Bind them and save
```{r}
all_lapses <- ema_lapses %>% 
  full_join(interview_lapses) %>% 
  glimpse()

all_lapses %>% tabyl(type)

all_lapses %>% 
  write_csv(file.path(path_out, "all_lapses.csv"))
```

