---
title: "Make enrollment dates"
author: "JJC"
date: "2/26/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Set up paths and packages
```{r, warning = FALSE, message=FALSE}
library(tidyverse)
library(janitor)
library(lubridate)
library(stringr)
library(data.table)  # for fread()

source('P:/toolboxes/lab_support/fun_modeling.R')

path_shared <- "P:/StudyData/RISK/analysis/shared/data"
path_out <- "P:/StudyData/RISK/analysis/gps/data"
```

## Visit dates

Create enrolled from visit_dates

Remove subjects who did not have any completed visits after intake
```{r}
visit_dates <- read_csv(file.path(path_shared, 'visit_dates.csv'), col_types = cols())

enrolled <- visit_dates %>% 
  filter(! (is.na(followup_1) & is.na(followup_2) & is.na(final_visit))) %>% 
  rename(planned_end_study = end_study,
         planned_start_study = start_study) %>% 
  glimpse()
```

## locations
Review subjects who do not have locations files with data in them

FIX:  This locations file hasn't had full EDA yet
```{r}
locations <- read_csv(file.path(path_shared, "locations.csv"), col_types = cols()) %>% 
  mutate(subid = as.numeric(subid))

n_interviews <- locations %>% 
  group_by(subid) %>% 
  count(utc) %>% 
  summarise(n_interviews = n())

n_locations <-  locations %>% 
  group_by(subid) %>% 
  summarize(n_locations = n())

enrolled <- enrolled %>% 
  left_join(n_interviews, by = "subid") %>% 
  left_join(n_locations, by = "subid") %>% 
  glimpse()

enrolled %>% plot_hist("n_interviews")

enrolled %>% tabyl(n_locations)
enrolled %>% plot_hist("n_locations")
```

Participants with only one interview date

Verified that 5, 7, & 190 did complete the study
```{r}
enrolled %>% 
  filter(n_interviews == 1) %>% 
  print(n = Inf)
```

## gps

Check that raw gps.gpx file exists
```{r}
check_for_gps <- function(subid) {
  subid <- str_pad(subid, 3, "left", "0")
  path <- file.path("P:/StudyData/RISK/raw_data", subid)
  moves_name <- str_c(subid, "_GPS.gpx")
  moves_name_1 <- str_c(subid, "_GPS_1.gpx") # some moves participants have multiple gpx files
  followmee_name <- str_c(subid, "_GPSFollowRaw.rds")
  return(file.exists(file.path(path, moves_name)) | file.exists(file.path(path, moves_name_1)) 
         | file.exists(file.path(path, followmee_name)))
}

enrolled <- enrolled %>% 
  mutate(gps_exists = check_for_gps(.$subid))

enrolled %>% tabyl(gps_exists)
```

Load gps file and check

* number of points
* First and last date
```{r}
# use fread() from data.table b/c very big file
gps <- fread(file.path(path_shared, "gps.csv")) %>% 
  glimpse()

n_gps <- gps %>% 
  group_by(subid) %>% 
  summarise(n_gps = n()) %>% 
  ungroup()

enrolled <- enrolled %>% 
  left_join(n_gps, by = "subid") 
```


FIX:  NEED TO EXPLORE THIS PARTICIPANTS FURTHER
```{r}
enrolled %>% tabyl(n_gps)

enrolled %>% plot_hist("n_gps")

enrolled %>% 
  filter(n_gps < 1000) %>% 
  print()
```

Add in first and last GPS dates
```{r}
first_gps <- gps %>% 
  arrange(subid, time) %>% 
  group_by(subid) %>% 
  slice(1) %>% 
  select(subid, first_gps = time) %>% 
  mutate(first_gps = as_date(first_gps)) 

last_gps <- gps %>% 
  arrange(subid, desc(time)) %>% 
  group_by(subid) %>% 
  slice(1) %>% 
  select(subid, last_gps = time) %>% 
  mutate(last_gps = as_date(last_gps)) 

enrolled <- enrolled %>% 
  left_join(first_gps, by = "subid") %>% 
  left_join(last_gps, by = "subid") 
```

## ema
Read EMA
```{r}
ema_morning <- read_csv(file.path(path_shared, 'ema_morning.csv'), col_types = cols()) 

ema_later <- read_csv(file.path(path_shared, 'ema_later.csv'), col_types = cols())

ema <- ema_morning %>% 
  full_join(ema_later) 
```

Add in first and last EMA dates
```{r}
first_ema <- ema %>% 
  arrange(subid, start_date) %>% 
  group_by(subid) %>% 
  slice(1) %>% 
  select(subid, first_ema = start_date) %>% 
  mutate(subid = as.numeric(subid),
         first_ema = with_tz(first_ema, tzone = "America/Chicago"),
         first_ema = as_date(first_ema))

last_ema <- ema %>% 
  arrange(subid, desc(start_date)) %>% 
  group_by(subid) %>% 
  slice(1) %>% 
  select(subid, last_ema = start_date) %>% 
  mutate(subid = as.numeric(subid),
         last_ema = with_tz(last_ema, tzone = "America/Chicago"),
         last_ema = as_date(last_ema)) 

enrolled <- enrolled %>% 
  left_join(first_ema, by = "subid") %>% 
  left_join(last_ema, by = "subid") 
```

Add in number of EMAs and mean/day
```{r}
n_emas <- ema %>% 
  group_by(subid) %>% 
  summarise(n_emas = n()) %>% 
  ungroup() %>% 
  mutate(subid = as.numeric(subid))

enrolled <- enrolled %>% 
  left_join(n_emas, by = "subid") 

enrolled <- enrolled %>% 
  mutate(days_ema = as.numeric(difftime(last_ema, first_ema, units = "days"))) %>% 
  rowwise() %>% 
  mutate(emas_day = round(n_emas / days_ema, 1)) %>% 
  ungroup()
```


FIX:  Check subjects with too few and too many EMAS
```{}
enrolled %>% tabyl(n_emas)

enrolled %>% 
  filter(n_emas < 100) %>% 
  print()

enrolled %>% 
  filter(n_emas > 400) %>% 
  print()

enrolled %>% tabyl(emas_day)

enrolled %>% 
  filter(emas_day < 2) %>% 
  print()
```


## adjust start and end dates
If last_ema was earlier than planned_end_study, flag and adjust end_study to last_ema. 

If first_ema was later than planned_study_start, flag and adjust study_start to first_ema 

```{r}
enrolled <- enrolled %>% 
  mutate(start_diff = as.numeric(difftime(planned_start_study, first_ema, units = "days")),
         start_study =  if_else(first_ema > planned_start_study, first_ema, planned_start_study),
         end_diff = as.numeric(difftime(planned_end_study, last_ema, units = "days")),
         end_study = if_else(last_ema < planned_end_study, last_ema, planned_end_study),
         study_days = as.numeric(difftime(end_study, start_study, units = "days")))
```

Review these adjustments

FIX:  ADD SOME CHECKS/REVIEW OF Non-zero
```{r}
enrolled %>% tabyl(start_diff)
enrolled %>% tabyl(end_diff)
```

Review number of enrollment days

FIX: Add some EDA for low values
```{r}
enrolled %>% tabyl(study_days)
```


# save files
write out enrollment files.  For  now this is reduced for srijan
```{r}
enrolled %>% 
  write_csv(file.path(path_out, "enrolled_details.csv"))

enrolled %>% 
  select(subid, start_study, end_study) %>% 
  write_csv(file.path(path_out, "enrolled_dates.csv"))
```